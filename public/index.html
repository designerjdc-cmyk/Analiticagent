<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>InstaMetrics ‚Äî Instagram Analytics</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.10.3/Recharts.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'DM Sans', -apple-system, sans-serif;
      background: #0a0a14;
      color: #fff;
      min-height: 100vh;
    }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }
    a { color: inherit; text-decoration: none; }

    .header {
      border-bottom: 1px solid rgba(255,255,255,0.06);
      padding: 16px 28px;
      display: flex; align-items: center; justify-content: space-between;
      backdrop-filter: blur(20px);
      position: sticky; top: 0; z-index: 100;
      background: rgba(10,10,20,0.88);
    }
    .header-brand { display: flex; align-items: center; gap: 12px; }
    .header-logo {
      width: 38px; height: 38px; border-radius: 12px;
      background: linear-gradient(135deg, #F58529, #DD2A7B, #8134AF);
      display: flex; align-items: center; justify-content: center;
      font-weight: 800; font-size: 16px; color: #fff;
    }
    .header-title { font-weight: 700; font-size: 17px; letter-spacing: -0.01em; }
    .header-sub { font-size: 12px; color: rgba(255,255,255,0.4); font-weight: 500; }

    .btn-connect {
      background: linear-gradient(135deg, #DD2A7B, #8134AF);
      border: none; border-radius: 12px; padding: 10px 20px;
      color: #fff; font-size: 14px; font-weight: 600; cursor: pointer;
      font-family: inherit; display: flex; align-items: center; gap: 7px;
      transition: transform 0.2s, box-shadow 0.2s;
      box-shadow: 0 4px 16px rgba(221,42,123,0.3);
    }
    .btn-connect:hover { transform: scale(1.03); box-shadow: 0 6px 24px rgba(221,42,123,0.4); }

    .btn-secondary {
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px; padding: 10px 16px;
      color: #fff; font-size: 14px; font-weight: 600;
      cursor: pointer; font-family: inherit;
      display: flex; align-items: center; gap: 8px;
      transition: all 0.2s;
    }
    .btn-secondary:hover { background: rgba(255,255,255,0.1); }

    .main { padding: 24px 28px; max-width: 1300px; margin: 0 auto; }

    .empty-state {
      display: flex; flex-direction: column; align-items: center;
      justify-content: center; min-height: 70vh; gap: 18px; text-align: center;
    }
    .empty-icon {
      width: 80px; height: 80px; border-radius: 24px;
      background: linear-gradient(135deg, #F58529, #DD2A7B, #8134AF, #515BD4);
      display: flex; align-items: center; justify-content: center; font-size: 36px;
    }

    .card {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 16px; padding: 20px 22px;
      transition: all 0.3s ease;
    }
    .card:hover {
      background: rgba(255,255,255,0.06);
      border-color: rgba(255,255,255,0.12);
    }

    .chart-card {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 18px; padding: 24px;
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
      gap: 14px; margin-bottom: 24px;
    }

    .charts-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    .charts-grid .full-width { grid-column: 1 / -1; }

    .account-selector {
      position: relative; display: inline-block;
    }
    .dropdown {
      position: absolute; top: calc(100% + 6px); right: 0;
      background: #1a1a2e; border: 1px solid rgba(255,255,255,0.1);
      border-radius: 14px; overflow: hidden; min-width: 240px;
      box-shadow: 0 16px 48px rgba(0,0,0,0.5); z-index: 200;
    }
    .dropdown-item {
      padding: 12px 16px; display: flex; align-items: center;
      justify-content: space-between; cursor: pointer; transition: background 0.15s;
    }
    .dropdown-item:hover { background: rgba(255,255,255,0.08); }

    .tabs {
      display: flex; gap: 4px; background: rgba(255,255,255,0.04);
      border-radius: 12px; padding: 4px;
    }
    .tab {
      background: transparent; border: none; border-radius: 9px;
      padding: 8px 18px; color: rgba(255,255,255,0.4);
      font-size: 13px; font-weight: 600; cursor: pointer;
      font-family: inherit; text-transform: capitalize; transition: all 0.2s;
    }
    .tab.active { background: rgba(255,255,255,0.1); color: #fff; }

    .media-grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 14px;
    }
    .media-item {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 14px; overflow: hidden; transition: all 0.3s;
    }
    .media-item:hover { border-color: rgba(255,255,255,0.15); transform: translateY(-2px); }
    .media-item img { width: 100%; aspect-ratio: 1; object-fit: cover; }
    .media-item video { width: 100%; aspect-ratio: 1; object-fit: cover; }
    .media-info { padding: 12px 14px; }

    .toast {
      position: fixed; bottom: 24px; right: 24px;
      padding: 14px 22px; border-radius: 14px;
      font-size: 14px; font-weight: 600; z-index: 1000;
      animation: slideIn 0.3s ease;
    }
    .toast.success { background: #38EF7D22; border: 1px solid #38EF7D44; color: #38EF7D; }
    .toast.error { background: #FF6B6B22; border: 1px solid #FF6B6B44; color: #FF6B6B; }

    .loading-spinner {
      width: 24px; height: 24px; border: 3px solid rgba(255,255,255,0.1);
      border-top-color: #DD2A7B; border-radius: 50%;
      animation: spin 0.8s linear infinite; margin: 40px auto;
    }

    .token-warning {
      background: rgba(255,152,0,0.1); border: 1px solid rgba(255,152,0,0.3);
      border-radius: 12px; padding: 12px 18px; margin-bottom: 16px;
      font-size: 13px; color: #FFB74D; display: flex; align-items: center; gap: 10px;
    }

    @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes spin { to { transform: rotate(360deg); } }

    @media (max-width: 768px) {
      .header { padding: 12px 16px; }
      .main { padding: 16px; }
      .charts-grid { grid-template-columns: 1fr; }
      .metrics-grid { grid-template-columns: repeat(2, 1fr); }
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useCallback } = React;
    const { LineChart, Line, AreaChart, Area, BarChart, Bar, XAxis, YAxis,
      CartesianGrid, Tooltip, ResponsiveContainer, PieChart, Pie, Cell } = Recharts;

    const COLORS = ["#DD2A7B", "#8134AF", "#F58529", "#515BD4", "#1DA1F2", "#38EF7D", "#FC466B", "#FFD200"];
    const PIE_COLORS = ["#DD2A7B", "#8134AF", "#F58529", "#515BD4"];

    // ‚îÄ‚îÄ‚îÄ API Helper ‚îÄ‚îÄ‚îÄ
    async function api(path, opts = {}) {
      const res = await fetch(path, opts);
      if (!res.ok) {
        const err = await res.json().catch(() => ({ error: res.statusText }));
        throw new Error(err.error || "API Error");
      }
      return res.json();
    }

    // ‚îÄ‚îÄ‚îÄ Custom Tooltip ‚îÄ‚îÄ‚îÄ
    function ChartTooltip({ active, payload, label }) {
      if (!active || !payload?.length) return null;
      return (
        <div style={{
          background: "#1a1a2e", border: "1px solid rgba(255,255,255,0.12)",
          borderRadius: 12, padding: "12px 16px", boxShadow: "0 8px 32px rgba(0,0,0,0.4)",
        }}>
          <div style={{ fontSize: 12, color: "rgba(255,255,255,0.5)", marginBottom: 6 }}>{label}</div>
          {payload.map((p, i) => (
            <div key={i} style={{ fontSize: 13, color: p.color, fontWeight: 600, marginBottom: 2 }}>
              {p.name}: {typeof p.value === "number" ? p.value.toLocaleString("es-ES") : p.value}
            </div>
          ))}
        </div>
      );
    }

    // ‚îÄ‚îÄ‚îÄ Metric Card ‚îÄ‚îÄ‚îÄ
    function MetricCard({ icon, label, value, change, color }) {
      const isPositive = change >= 0;
      return (
        <div className="card" style={{ display: "flex", flexDirection: "column", gap: 10, cursor: "default" }}>
          <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between" }}>
            <div style={{
              width: 36, height: 36, borderRadius: 10,
              background: `${color}20`, display: "flex", alignItems: "center", justifyContent: "center",
              fontSize: 18,
            }}>{icon}</div>
            {change !== undefined && (
              <div style={{
                display: "flex", alignItems: "center", gap: 3, fontSize: 13, fontWeight: 600,
                color: isPositive ? "#38EF7D" : "#FF6B6B",
              }}>
                {isPositive ? "‚Üë" : "‚Üì"} {isPositive ? "+" : ""}{typeof change === "number" ? change.toFixed(1) : change}%
              </div>
            )}
          </div>
          <div>
            <div style={{ fontSize: 26, fontWeight: 700, letterSpacing: "-0.02em" }}>
              {typeof value === "number" ? value.toLocaleString("es-ES") : value}
            </div>
            <div style={{ fontSize: 13, color: "rgba(255,255,255,0.45)", marginTop: 2, fontWeight: 500 }}>{label}</div>
          </div>
        </div>
      );
    }

    // ‚îÄ‚îÄ‚îÄ Main App ‚îÄ‚îÄ‚îÄ
    function App() {
      const [accounts, setAccounts] = useState([]);
      const [selectedId, setSelectedId] = useState(null);
      const [dropdownOpen, setDropdownOpen] = useState(false);
      const [tab, setTab] = useState("overview");
      const [loading, setLoading] = useState(true);
      const [toast, setToast] = useState(null);

      // Data states
      const [insights, setInsights] = useState(null);
      const [media, setMedia] = useState([]);
      const [demographics, setDemographics] = useState(null);
      const [loadingData, setLoadingData] = useState(false);

      // Show toast
      const showToast = (msg, type = "success") => {
        setToast({ msg, type });
        setTimeout(() => setToast(null), 4000);
      };

      // Check URL params on mount
      useEffect(() => {
        const params = new URLSearchParams(window.location.search);
        if (params.get("connected")) {
          showToast(`@${params.get("connected")} conectada correctamente ‚úì`);
          window.history.replaceState({}, "", "/");
        }
        if (params.get("error")) {
          showToast(params.get("error"), "error");
          window.history.replaceState({}, "", "/");
        }
        loadAccounts();
      }, []);

      const loadAccounts = async () => {
        try {
          const data = await api("/api/accounts");
          setAccounts(data);
          if (data.length > 0 && !selectedId) setSelectedId(data[0].id);
        } catch (e) {
          showToast("Error loading accounts: " + e.message, "error");
        }
        setLoading(false);
      };

      // Load data when account changes
      useEffect(() => {
        if (!selectedId) return;
        fetchAccountData();
      }, [selectedId]);

      const fetchAccountData = async () => {
        setLoadingData(true);
        try {
          // Fetch profile, insights, and media in parallel
          const [profileData, insightsData, mediaData] = await Promise.allSettled([
            api(`/api/accounts/${selectedId}/profile`),
            api(`/api/accounts/${selectedId}/insights?period=day`),
            api(`/api/accounts/${selectedId}/media?limit=25`),
          ]);

          if (insightsData.status === "fulfilled") setInsights(insightsData.value);
          if (mediaData.status === "fulfilled") setMedia(mediaData.value.data || []);

          // Refresh profile in local state
          if (profileData.status === "fulfilled") {
            setAccounts(prev => prev.map(a =>
              a.id === selectedId ? { ...a, ...profileData.value } : a
            ));
          }

          // Try demographics (may fail for small accounts)
          try {
            const demo = await api(`/api/accounts/${selectedId}/demographics`);
            setDemographics(demo);
          } catch { setDemographics(null); }

        } catch (e) {
          showToast("Error fetching data: " + e.message, "error");
        }
        setLoadingData(false);
      };

      const removeAccount = async (id) => {
        try {
          await api(`/api/accounts/${id}`, { method: "DELETE" });
          const updated = accounts.filter(a => a.id !== id);
          setAccounts(updated);
          if (selectedId === id) setSelectedId(updated[0]?.id || null);
          showToast("Cuenta eliminada");
        } catch (e) {
          showToast("Error: " + e.message, "error");
        }
      };

      const refreshToken = async (id) => {
        try {
          await api(`/api/accounts/${id}/refresh-token`, { method: "POST" });
          showToast("Token renovado ‚úì");
          loadAccounts();
        } catch (e) {
          showToast("Error renovando token: " + e.message, "error");
        }
      };

      const acc = accounts.find(a => a.id === selectedId);

      // Parse insights data into chart-friendly format
      const chartData = (() => {
        if (!insights?.data) return [];
        const reachMetric = insights.data.find(m => m.name === "reach");
        const impressionsMetric = insights.data.find(m => m.name === "impressions");
        if (!reachMetric?.values) return [];

        return reachMetric.values.map((v, i) => ({
          date: new Date(v.end_time).toLocaleDateString("es-ES", { day: "2-digit", month: "short" }),
          reach: v.value,
          impressions: impressionsMetric?.values?.[i]?.value || 0,
        }));
      })();

      // Media stats
      const mediaStats = (() => {
        if (!media.length) return { totalLikes: 0, totalComments: 0, byType: {} };
        let totalLikes = 0, totalComments = 0;
        const byType = {};
        media.forEach(m => {
          totalLikes += m.like_count || 0;
          totalComments += m.comments_count || 0;
          const type = m.media_type || "UNKNOWN";
          byType[type] = (byType[type] || 0) + 1;
        });
        return { totalLikes, totalComments, byType };
      })();

      const contentDistribution = Object.entries(mediaStats.byType).map(([name, value]) => {
        const labels = { IMAGE: "Fotos", VIDEO: "Reels/Video", CAROUSEL_ALBUM: "Carruseles" };
        return { name: labels[name] || name, value };
      });

      // Token expiry check
      const daysUntilExpiry = acc?.token_expires_at
        ? Math.floor((acc.token_expires_at - Date.now()) / (1000 * 60 * 60 * 24))
        : null;

      if (loading) {
        return (
          <div style={{ display: "flex", alignItems: "center", justifyContent: "center", minHeight: "100vh" }}>
            <div className="loading-spinner" />
          </div>
        );
      }

      return (
        <div>
          {/* Header */}
          <div className="header">
            <div className="header-brand">
              <div className="header-logo">IG</div>
              <div>
                <div className="header-title">InstaMetrics</div>
                <div className="header-sub">Analytics Dashboard</div>
              </div>
            </div>

            <div style={{ display: "flex", alignItems: "center", gap: 12 }}>
              {accounts.length > 0 && (
                <div className="account-selector">
                  <button className="btn-secondary" onClick={() => setDropdownOpen(!dropdownOpen)}>
                    {acc?.profile_picture_url && (
                      <img src={acc.profile_picture_url} style={{ width: 22, height: 22, borderRadius: "50%" }} />
                    )}
                    <span style={{
                      width: 8, height: 8, borderRadius: "50%",
                      background: COLORS[accounts.indexOf(acc) % COLORS.length],
                      display: acc?.profile_picture_url ? "none" : "block",
                    }} />
                    @{acc?.username || "Seleccionar"}
                    <span style={{ opacity: 0.4, fontSize: 12 }}>‚ñº</span>
                  </button>

                  {dropdownOpen && (
                    <div className="dropdown">
                      {accounts.map((a, i) => (
                        <div key={a.id} className="dropdown-item"
                          onClick={() => { setSelectedId(a.id); setDropdownOpen(false); }}>
                          <div style={{ display: "flex", alignItems: "center", gap: 10 }}>
                            {a.profile_picture_url
                              ? <img src={a.profile_picture_url} style={{ width: 24, height: 24, borderRadius: "50%" }} />
                              : <span style={{ width: 8, height: 8, borderRadius: "50%", background: COLORS[i % COLORS.length] }} />}
                            <span style={{ fontSize: 14, fontWeight: 500 }}>@{a.username}</span>
                          </div>
                          <button onClick={(e) => { e.stopPropagation(); removeAccount(a.id); }}
                            style={{
                              background: "none", border: "none", cursor: "pointer",
                              color: "rgba(255,255,255,0.3)", fontSize: 16, padding: "2px 6px",
                            }}
                            onMouseEnter={e => e.target.style.color = "#FF6B6B"}
                            onMouseLeave={e => e.target.style.color = "rgba(255,255,255,0.3)"}
                          >‚úï</button>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              )}

              <button className="btn-connect" onClick={() => window.location.href = "/auth/login"}>
                + Conectar cuenta
              </button>
            </div>
          </div>

          {/* Main */}
          <div className="main">
            {!acc ? (
              <div className="empty-state">
                <div className="empty-icon">üìä</div>
                <h2 style={{ fontSize: 28, fontWeight: 700, letterSpacing: "-0.02em" }}>
                  Bienvenido a InstaMetrics
                </h2>
                <p style={{ color: "rgba(255,255,255,0.45)", fontSize: 16, maxWidth: 440, lineHeight: 1.6 }}>
                  Conecta tu primera cuenta de Instagram para ver tus m√©tricas reales.
                  Necesitas una cuenta Business o Creator.
                </p>
                <button className="btn-connect" style={{ marginTop: 8, padding: "14px 28px", fontSize: 16 }}
                  onClick={() => window.location.href = "/auth/login"}>
                  + Conectar cuenta
                </button>
                <div style={{ marginTop: 32, padding: 24, background: "rgba(255,255,255,0.03)", borderRadius: 16, maxWidth: 500, textAlign: "left" }}>
                  <h4 style={{ marginBottom: 12, color: "rgba(255,255,255,0.7)" }}>‚ö° Antes de conectar:</h4>
                  <ol style={{ paddingLeft: 20, color: "rgba(255,255,255,0.5)", lineHeight: 2, fontSize: 14 }}>
                    <li>Tu cuenta debe ser <strong style={{ color: "#fff" }}>Business</strong> o <strong style={{ color: "#fff" }}>Creator</strong> (se cambia gratis en Ajustes ‚Üí Cuenta)</li>
                    <li>Necesitas una app configurada en <a href="https://developers.facebook.com" target="_blank" style={{ color: "#DD2A7B" }}>Meta for Developers</a></li>
                    <li>Pulsa "Conectar cuenta" y autoriza el acceso</li>
                  </ol>
                </div>
              </div>
            ) : (
              <>
                {/* Token warning */}
                {daysUntilExpiry !== null && daysUntilExpiry < 10 && (
                  <div className="token-warning">
                    ‚ö†Ô∏è El token de @{acc.username} expira en {daysUntilExpiry} d√≠as.
                    <button onClick={() => refreshToken(acc.id)}
                      style={{
                        background: "rgba(255,152,0,0.2)", border: "1px solid rgba(255,152,0,0.4)",
                        borderRadius: 8, padding: "4px 14px", color: "#FFB74D",
                        fontSize: 13, fontWeight: 600, cursor: "pointer", fontFamily: "inherit",
                      }}>Renovar</button>
                  </div>
                )}

                {/* Account header */}
                <div style={{ marginBottom: 24, display: "flex", alignItems: "center", justifyContent: "space-between", flexWrap: "wrap", gap: 16 }}>
                  <div style={{ display: "flex", alignItems: "center", gap: 16 }}>
                    {acc.profile_picture_url && (
                      <img src={acc.profile_picture_url}
                        style={{ width: 52, height: 52, borderRadius: 16, border: "2px solid rgba(255,255,255,0.1)" }} />
                    )}
                    <div>
                      <h1 style={{ fontSize: 26, fontWeight: 800, letterSpacing: "-0.02em" }}>@{acc.username}</h1>
                      <p style={{ color: "rgba(255,255,255,0.4)", fontSize: 14, fontWeight: 500 }}>
                        {acc.account_type} ¬∑ {acc.name !== acc.username ? acc.name : ""}
                      </p>
                    </div>
                  </div>

                  <div style={{ display: "flex", alignItems: "center", gap: 10 }}>
                    <button className="btn-secondary" onClick={fetchAccountData}
                      style={{ fontSize: 13, padding: "8px 14px" }}>
                      üîÑ Actualizar
                    </button>
                    <div className="tabs">
                      {["overview", "media", "audiencia"].map(t => (
                        <button key={t} className={`tab ${tab === t ? "active" : ""}`} onClick={() => setTab(t)}>
                          {t}
                        </button>
                      ))}
                    </div>
                  </div>
                </div>

                {loadingData && (
                  <div style={{ display: "flex", justifyContent: "center", padding: 40 }}>
                    <div className="loading-spinner" />
                  </div>
                )}

                {!loadingData && (
                  <>
                    {/* Metrics cards */}
                    <div className="metrics-grid">
                      <MetricCard icon="üë•" label="Seguidores" value={acc.followers_count || 0} color="#DD2A7B" />
                      <MetricCard icon="‚û°Ô∏è" label="Siguiendo" value={acc.follows_count || 0} color="#8134AF" />
                      <MetricCard icon="üì∏" label="Publicaciones" value={acc.media_count || 0} color="#F58529" />
                      <MetricCard icon="‚ù§Ô∏è" label="Likes (√∫lt. posts)" value={mediaStats.totalLikes} color="#FC466B" />
                      <MetricCard icon="üí¨" label="Comentarios" value={mediaStats.totalComments} color="#515BD4" />
                      <MetricCard icon="üìä" label="Eng. Rate"
                        value={acc.followers_count
                          ? ((mediaStats.totalLikes + mediaStats.totalComments) / Math.min(media.length || 1, 25) / acc.followers_count * 100).toFixed(2) + "%"
                          : "‚Äî"}
                        color="#38EF7D" />
                    </div>

                    {/* OVERVIEW TAB */}
                    {tab === "overview" && (
                      <div className="charts-grid">
                        {chartData.length > 0 && (
                          <>
                            <div className="chart-card full-width">
                              <h3 style={{ marginBottom: 20, fontSize: 16, fontWeight: 700 }}>Alcance e Impresiones (diario)</h3>
                              <ResponsiveContainer width="100%" height={280}>
                                <AreaChart data={chartData}>
                                  <defs>
                                    <linearGradient id="reachG" x1="0" y1="0" x2="0" y2="1">
                                      <stop offset="0%" stopColor="#DD2A7B" stopOpacity={0.3} />
                                      <stop offset="100%" stopColor="#DD2A7B" stopOpacity={0} />
                                    </linearGradient>
                                    <linearGradient id="impG" x1="0" y1="0" x2="0" y2="1">
                                      <stop offset="0%" stopColor="#515BD4" stopOpacity={0.3} />
                                      <stop offset="100%" stopColor="#515BD4" stopOpacity={0} />
                                    </linearGradient>
                                  </defs>
                                  <CartesianGrid strokeDasharray="3 3" stroke="rgba(255,255,255,0.05)" />
                                  <XAxis dataKey="date" stroke="rgba(255,255,255,0.2)" fontSize={11} tickLine={false} />
                                  <YAxis stroke="rgba(255,255,255,0.2)" fontSize={11} tickLine={false}
                                    tickFormatter={v => v >= 1000 ? `${(v/1000).toFixed(1)}k` : v} />
                                  <Tooltip content={<ChartTooltip />} />
                                  <Area type="monotone" dataKey="reach" stroke="#DD2A7B" strokeWidth={2.5}
                                    fill="url(#reachG)" name="Alcance" />
                                  <Area type="monotone" dataKey="impressions" stroke="#515BD4" strokeWidth={2}
                                    fill="url(#impG)" name="Impresiones" />
                                </AreaChart>
                              </ResponsiveContainer>
                            </div>
                          </>
                        )}

                        {/* Content distribution */}
                        {contentDistribution.length > 0 && (
                          <div className="chart-card">
                            <h3 style={{ marginBottom: 20, fontSize: 16, fontWeight: 700 }}>Distribuci√≥n de contenido</h3>
                            <ResponsiveContainer width="100%" height={240}>
                              <PieChart>
                                <Pie data={contentDistribution} cx="50%" cy="50%"
                                  innerRadius={55} outerRadius={90} paddingAngle={4} dataKey="value">
                                  {contentDistribution.map((_, i) => (
                                    <Cell key={i} fill={PIE_COLORS[i % PIE_COLORS.length]} />
                                  ))}
                                </Pie>
                                <Tooltip content={<ChartTooltip />} />
                              </PieChart>
                            </ResponsiveContainer>
                            <div style={{ display: "flex", justifyContent: "center", gap: 16, marginTop: 8 }}>
                              {contentDistribution.map((ct, i) => (
                                <div key={ct.name} style={{ display: "flex", alignItems: "center", gap: 6, fontSize: 12 }}>
                                  <span style={{ width: 10, height: 10, borderRadius: 3, background: PIE_COLORS[i % PIE_COLORS.length], display: "inline-block" }} />
                                  <span style={{ color: "rgba(255,255,255,0.6)" }}>{ct.name} ({ct.value})</span>
                                </div>
                              ))}
                            </div>
                          </div>
                        )}

                        {/* Top posts by engagement */}
                        <div className="chart-card">
                          <h3 style={{ marginBottom: 16, fontSize: 16, fontWeight: 700 }}>Top publicaciones</h3>
                          <div style={{ display: "flex", flexDirection: "column", gap: 10 }}>
                            {media.slice().sort((a, b) => (b.like_count || 0) - (a.like_count || 0)).slice(0, 5).map((m, i) => (
                              <a key={m.id} href={m.permalink} target="_blank" rel="noopener"
                                style={{
                                  display: "flex", alignItems: "center", gap: 12,
                                  padding: "10px 12px", background: "rgba(255,255,255,0.03)",
                                  borderRadius: 12, transition: "background 0.2s",
                                }}
                                onMouseEnter={e => e.currentTarget.style.background = "rgba(255,255,255,0.07)"}
                                onMouseLeave={e => e.currentTarget.style.background = "rgba(255,255,255,0.03)"}>
                                {(m.media_url || m.thumbnail_url) && (
                                  <img src={m.thumbnail_url || m.media_url}
                                    style={{ width: 44, height: 44, borderRadius: 8, objectFit: "cover" }} />
                                )}
                                <div style={{ flex: 1, minWidth: 0 }}>
                                  <div style={{ fontSize: 13, fontWeight: 600 }}>
                                    {m.media_type === "VIDEO" ? "üé¨" : m.media_type === "CAROUSEL_ALBUM" ? "üìë" : "üì∑"}
                                    {" "}{m.caption ? m.caption.slice(0, 40) + (m.caption.length > 40 ? "..." : "") : "Sin caption"}
                                  </div>
                                  <div style={{ fontSize: 11, color: "rgba(255,255,255,0.4)", marginTop: 2 }}>
                                    {new Date(m.timestamp).toLocaleDateString("es-ES")}
                                  </div>
                                </div>
                                <div style={{ textAlign: "right", flexShrink: 0 }}>
                                  <div style={{ fontSize: 14, fontWeight: 700, color: "#DD2A7B" }}>‚ù§ {(m.like_count || 0).toLocaleString("es-ES")}</div>
                                  <div style={{ fontSize: 11, color: "rgba(255,255,255,0.4)" }}>üí¨ {m.comments_count || 0}</div>
                                </div>
                              </a>
                            ))}
                          </div>
                        </div>

                        {/* Multi-account comparison */}
                        {accounts.length > 1 && (
                          <div className="chart-card full-width">
                            <h3 style={{ marginBottom: 16, fontSize: 16, fontWeight: 700 }}>Comparaci√≥n entre cuentas</h3>
                            <div style={{ overflowX: "auto" }}>
                              <table style={{ width: "100%", borderCollapse: "collapse" }}>
                                <thead>
                                  <tr>
                                    {["Cuenta", "Seguidores", "Siguiendo", "Posts", "Tipo"].map(h => (
                                      <th key={h} style={{
                                        textAlign: "left", padding: "10px 16px", fontSize: 12, fontWeight: 600,
                                        color: "rgba(255,255,255,0.4)", borderBottom: "1px solid rgba(255,255,255,0.06)",
                                      }}>{h}</th>
                                    ))}
                                  </tr>
                                </thead>
                                <tbody>
                                  {accounts.map((a, i) => (
                                    <tr key={a.id}
                                      style={{ background: a.id === acc.id ? "rgba(255,255,255,0.04)" : "transparent", cursor: "pointer" }}
                                      onClick={() => setSelectedId(a.id)}>
                                      <td style={{ padding: "12px 16px", fontSize: 14, fontWeight: 600 }}>
                                        <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                                          {a.profile_picture_url
                                            ? <img src={a.profile_picture_url} style={{ width: 24, height: 24, borderRadius: "50%" }} />
                                            : <span style={{ width: 8, height: 8, borderRadius: "50%", background: COLORS[i % COLORS.length], display: "inline-block" }} />}
                                          @{a.username}
                                        </div>
                                      </td>
                                      <td style={{ padding: "12px 16px", fontSize: 14 }}>{(a.followers_count || 0).toLocaleString("es-ES")}</td>
                                      <td style={{ padding: "12px 16px", fontSize: 14 }}>{(a.follows_count || 0).toLocaleString("es-ES")}</td>
                                      <td style={{ padding: "12px 16px", fontSize: 14 }}>{a.media_count || 0}</td>
                                      <td style={{ padding: "12px 16px", fontSize: 13, color: "rgba(255,255,255,0.5)" }}>{a.account_type}</td>
                                    </tr>
                                  ))}
                                </tbody>
                              </table>
                            </div>
                          </div>
                        )}

                        {chartData.length === 0 && (
                          <div className="chart-card full-width" style={{ textAlign: "center", padding: 40 }}>
                            <p style={{ color: "rgba(255,255,255,0.4)", fontSize: 15 }}>
                              üìà Los insights de alcance e impresiones aparecer√°n aqu√≠.<br />
                              <span style={{ fontSize: 13 }}>Puede tardar unos d√≠as en generar datos si la cuenta es nueva o tiene pocas interacciones.</span>
                            </p>
                          </div>
                        )}
                      </div>
                    )}

                    {/* MEDIA TAB */}
                    {tab === "media" && (
                      <div className="media-grid">
                        {media.map(m => (
                          <a key={m.id} href={m.permalink} target="_blank" rel="noopener" className="media-item">
                            {m.media_type === "VIDEO"
                              ? <img src={m.thumbnail_url || m.media_url} alt="" style={{ width: "100%", aspectRatio: "1", objectFit: "cover" }} />
                              : <img src={m.media_url} alt="" style={{ width: "100%", aspectRatio: "1", objectFit: "cover" }} />}
                            <div className="media-info">
                              <div style={{ display: "flex", justifyContent: "space-between", marginBottom: 6 }}>
                                <span style={{ fontSize: 13, fontWeight: 600 }}>
                                  {m.media_type === "VIDEO" ? "üé¨ Reel/Video" : m.media_type === "CAROUSEL_ALBUM" ? "üìë Carrusel" : "üì∑ Foto"}
                                </span>
                                <span style={{ fontSize: 12, color: "rgba(255,255,255,0.4)" }}>
                                  {new Date(m.timestamp).toLocaleDateString("es-ES")}
                                </span>
                              </div>
                              <div style={{ display: "flex", gap: 14, fontSize: 13 }}>
                                <span style={{ color: "#DD2A7B", fontWeight: 600 }}>‚ù§ {(m.like_count || 0).toLocaleString("es-ES")}</span>
                                <span style={{ color: "#8134AF", fontWeight: 600 }}>üí¨ {m.comments_count || 0}</span>
                              </div>
                              {m.caption && (
                                <p style={{ fontSize: 12, color: "rgba(255,255,255,0.4)", marginTop: 6, lineHeight: 1.4 }}>
                                  {m.caption.slice(0, 80)}{m.caption.length > 80 ? "..." : ""}
                                </p>
                              )}
                            </div>
                          </a>
                        ))}
                        {media.length === 0 && (
                          <div style={{ gridColumn: "1 / -1", textAlign: "center", padding: 60, color: "rgba(255,255,255,0.4)" }}>
                            No se encontraron publicaciones
                          </div>
                        )}
                      </div>
                    )}

                    {/* AUDIENCE TAB */}
                    {tab === "audiencia" && (
                      <div className="charts-grid">
                        {demographics?.data ? (
                          demographics.data.map((metric, idx) => (
                            <div key={idx} className="chart-card">
                              <h3 style={{ marginBottom: 16, fontSize: 16, fontWeight: 700 }}>
                                {metric.title || metric.name}
                              </h3>
                              {metric.total_value?.breakdowns?.[0]?.results ? (
                                <div style={{ display: "flex", flexDirection: "column", gap: 8 }}>
                                  {metric.total_value.breakdowns[0].results
                                    .sort((a, b) => b.value - a.value)
                                    .slice(0, 10)
                                    .map((item, i) => {
                                      const maxVal = metric.total_value.breakdowns[0].results[0].value;
                                      return (
                                        <div key={i}>
                                          <div style={{ display: "flex", justifyContent: "space-between", marginBottom: 4 }}>
                                            <span style={{ fontSize: 13, fontWeight: 500 }}>
                                              {Object.values(item.dimension_values || {}).join(" ¬∑ ")}
                                            </span>
                                            <span style={{ fontSize: 13, fontWeight: 600, color: COLORS[i % COLORS.length] }}>
                                              {item.value.toLocaleString("es-ES")}
                                            </span>
                                          </div>
                                          <div style={{ height: 6, borderRadius: 3, background: "rgba(255,255,255,0.06)", overflow: "hidden" }}>
                                            <div style={{
                                              height: "100%", borderRadius: 3,
                                              width: `${(item.value / maxVal) * 100}%`,
                                              background: COLORS[i % COLORS.length],
                                            }} />
                                          </div>
                                        </div>
                                      );
                                    })}
                                </div>
                              ) : (
                                <p style={{ color: "rgba(255,255,255,0.4)", fontSize: 14 }}>Sin datos disponibles</p>
                              )}
                            </div>
                          ))
                        ) : (
                          <div className="chart-card full-width" style={{ textAlign: "center", padding: 50 }}>
                            <p style={{ color: "rgba(255,255,255,0.4)", fontSize: 15, lineHeight: 1.7 }}>
                              üë• Los datos demogr√°ficos requieren al menos <strong style={{ color: "#fff" }}>100 seguidores</strong>.<br />
                              <span style={{ fontSize: 13 }}>Instagram restringe estos datos en cuentas peque√±as por privacidad.</span>
                            </p>
                          </div>
                        )}
                      </div>
                    )}
                  </>
                )}
              </>
            )}
          </div>

          {/* Toast */}
          {toast && <div className={`toast ${toast.type}`}>{toast.msg}</div>}

          {/* Click outside dropdown */}
          {dropdownOpen && (
            <div style={{ position: "fixed", inset: 0, zIndex: 150 }}
              onClick={() => setDropdownOpen(false)} />
          )}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
