<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>InstaMetrics ‚Äî Instagram Analytics</title>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script crossorigin src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
  <script crossorigin src="https://unpkg.com/recharts@2.5.0/umd/Recharts.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
  <style>
    :root {
      --bg: #09090b; --bg-card: rgba(255,255,255,0.03); --bg-card-hover: rgba(255,255,255,0.055);
      --border: rgba(255,255,255,0.07); --border-hover: rgba(255,255,255,0.13);
      --text: #fafafa; --text-muted: rgba(255,255,255,0.45); --text-dim: rgba(255,255,255,0.28);
      --accent: #e1306c; --accent2: #833ab4; --green: #22c55e; --red: #ef4444;
      --orange: #f59e0b; --blue: #3b82f6; --radius: 12px;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Plus Jakarta Sans', -apple-system, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
    ::-webkit-scrollbar { width: 5px; height: 5px; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.08); border-radius: 4px; }
    a { color: inherit; text-decoration: none; }
    button { font-family: inherit; }

    /* Layout */
    .shell { display: flex; min-height: 100vh; }
    .sidebar {
      width: 220px; border-right: 1px solid var(--border); padding: 24px 16px;
      display: flex; flex-direction: column; gap: 4px; position: fixed; top: 0; left: 0; bottom: 0;
      background: var(--bg); z-index: 50;
    }
    .sidebar-brand { display: flex; align-items: center; gap: 10px; padding: 4px 8px; margin-bottom: 24px; }
    .sidebar-logo {
      width: 32px; height: 32px; border-radius: 9px;
      background: linear-gradient(135deg, #f9ce34, #ee2a7b, #6228d7);
      display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 13px;
    }
    .sidebar-title { font-weight: 700; font-size: 15px; letter-spacing: -0.02em; }

    .nav-item {
      display: flex; align-items: center; gap: 10px; padding: 10px 12px;
      border-radius: 8px; font-size: 13px; font-weight: 500; color: var(--text-muted);
      cursor: pointer; transition: all 0.15s; border: none; background: none; width: 100%; text-align: left;
    }
    .nav-item:hover { color: var(--text); background: rgba(255,255,255,0.04); }
    .nav-item.active { color: var(--text); background: rgba(255,255,255,0.07); font-weight: 600; }
    .nav-icon { font-size: 16px; width: 20px; text-align: center; }

    .content { margin-left: 220px; flex: 1; padding: 28px 32px; }

    /* Top bar */
    .topbar {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 28px; gap: 16px; flex-wrap: wrap;
    }
    .topbar-left h1 { font-size: 22px; font-weight: 800; letter-spacing: -0.03em; }
    .topbar-left p { font-size: 13px; color: var(--text-muted); margin-top: 2px; }

    /* Buttons */
    .btn-primary {
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      border: none; border-radius: 10px; padding: 9px 18px; color: #fff;
      font-size: 13px; font-weight: 600; cursor: pointer; display: inline-flex;
      align-items: center; gap: 6px; transition: opacity 0.2s;
    }
    .btn-primary:hover { opacity: 0.9; }
    .btn-outline {
      background: transparent; border: 1px solid var(--border); border-radius: 10px;
      padding: 8px 16px; color: var(--text); font-size: 13px; font-weight: 500;
      cursor: pointer; display: inline-flex; align-items: center; gap: 6px; transition: all 0.15s;
    }
    .btn-outline:hover { border-color: var(--border-hover); background: rgba(255,255,255,0.03); }
    .btn-ghost {
      background: none; border: none; color: var(--text-muted); font-size: 12px;
      cursor: pointer; padding: 6px 8px; transition: color 0.15s;
    }
    .btn-ghost:hover { color: var(--text); }

    /* Cards */
    .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 24px; }
    .kpi {
      background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius);
      padding: 18px 20px; transition: all 0.2s;
    }
    .kpi:hover { background: var(--bg-card-hover); border-color: var(--border-hover); }
    .kpi-label { font-size: 12px; color: var(--text-muted); font-weight: 500; text-transform: uppercase; letter-spacing: 0.04em; }
    .kpi-value { font-size: 28px; font-weight: 800; letter-spacing: -0.03em; margin-top: 6px; }
    .kpi-sub { font-size: 12px; color: var(--text-dim); margin-top: 4px; }

    .panel {
      background: var(--bg-card); border: 1px solid var(--border); border-radius: 14px; padding: 22px; margin-bottom: 16px;
    }
    .panel-title { font-size: 14px; font-weight: 700; margin-bottom: 16px; letter-spacing: -0.01em; }

    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .grid-full { grid-column: 1 / -1; }

    /* Posts table */
    .posts-table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .posts-table th {
      text-align: left; padding: 10px 14px; font-size: 11px; font-weight: 600;
      color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em;
      border-bottom: 1px solid var(--border); cursor: pointer; user-select: none; white-space: nowrap;
    }
    .posts-table th:hover { color: var(--text); }
    .posts-table td { padding: 10px 14px; border-bottom: 1px solid rgba(255,255,255,0.03); vertical-align: middle; }
    .posts-table tr:hover td { background: rgba(255,255,255,0.02); }
    .posts-table .num { text-align: right; font-variant-numeric: tabular-nums; font-weight: 600; }
    .posts-table .caption-cell { max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: var(--text-muted); }

    /* Post type badges */
    .badge {
      display: inline-flex; align-items: center; gap: 4px; padding: 3px 8px;
      border-radius: 6px; font-size: 11px; font-weight: 600;
    }
    .badge-reel { background: rgba(139,92,246,0.15); color: #a78bfa; }
    .badge-photo { background: rgba(59,130,246,0.15); color: #93c5fd; }
    .badge-carousel { background: rgba(245,158,11,0.15); color: #fcd34d; }

    /* Filter tabs */
    .filter-bar { display: flex; gap: 6px; margin-bottom: 18px; flex-wrap: wrap; align-items: center; }
    .filter-chip {
      background: transparent; border: 1px solid var(--border); border-radius: 8px;
      padding: 6px 14px; font-size: 12px; font-weight: 500; color: var(--text-muted);
      cursor: pointer; transition: all 0.15s; font-family: inherit;
    }
    .filter-chip:hover { border-color: var(--border-hover); color: var(--text); }
    .filter-chip.active { background: rgba(255,255,255,0.08); border-color: rgba(255,255,255,0.15); color: var(--text); }

    /* Format comparison bars */
    .format-row { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
    .format-label { width: 90px; font-size: 12px; font-weight: 600; flex-shrink: 0; }
    .format-bar-bg { flex: 1; height: 28px; background: rgba(255,255,255,0.04); border-radius: 6px; overflow: hidden; position: relative; }
    .format-bar { height: 100%; border-radius: 6px; display: flex; align-items: center; padding-left: 10px; font-size: 11px; font-weight: 700; transition: width 0.5s ease; min-width: 40px; }
    .format-val { font-size: 13px; font-weight: 700; width: 60px; text-align: right; flex-shrink: 0; }

    /* Auth */
    .auth-wrap { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; }
    .auth-box {
      background: var(--bg-card); border: 1px solid var(--border); border-radius: 20px;
      padding: 40px 36px; width: 100%; max-width: 380px; text-align: center;
    }
    .auth-input {
      width: 100%; padding: 12px 16px; background: rgba(255,255,255,0.05);
      border: 1px solid var(--border); border-radius: 10px; color: var(--text);
      font-size: 14px; font-family: inherit; outline: none; transition: border-color 0.2s;
    }
    .auth-input:focus { border-color: var(--accent); }
    .auth-input::placeholder { color: var(--text-dim); }
    .auth-error { background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.2); border-radius: 8px; padding: 10px 12px; font-size: 12px; color: var(--red); text-align: left; }

    /* Dropdown */
    .dropdown { position: absolute; top: calc(100% + 4px); right: 0; background: #141416; border: 1px solid var(--border); border-radius: 12px; min-width: 220px; box-shadow: 0 12px 40px rgba(0,0,0,0.5); z-index: 200; overflow: hidden; }
    .dropdown-item { padding: 10px 14px; display: flex; align-items: center; gap: 10px; cursor: pointer; font-size: 13px; transition: background 0.1s; }
    .dropdown-item:hover { background: rgba(255,255,255,0.06); }

    /* Toast */
    .toast { position: fixed; bottom: 20px; right: 20px; padding: 12px 20px; border-radius: 10px; font-size: 13px; font-weight: 600; z-index: 1000; animation: slideUp 0.3s ease; }
    .toast.success { background: rgba(34,197,94,0.12); border: 1px solid rgba(34,197,94,0.25); color: var(--green); }
    .toast.error { background: rgba(239,68,68,0.12); border: 1px solid rgba(239,68,68,0.25); color: var(--red); }

    .spinner { width: 22px; height: 22px; border: 2.5px solid rgba(255,255,255,0.08); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.7s linear infinite; }
    .empty-msg { color: var(--text-dim); font-size: 14px; text-align: center; padding: 40px 20px; }

    @keyframes slideUp { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes spin { to { transform: rotate(360deg); } }

    @media (max-width: 900px) {
      .sidebar { display: none; }
      .content { margin-left: 0; padding: 16px; }
      .grid-2 { grid-template-columns: 1fr; }
      .kpi-grid { grid-template-columns: repeat(2, 1fr); }
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel" data-type="module">
    const { useState, useEffect, useRef, Component } = React;

    class ErrorBoundary extends Component {
      constructor(p) { super(p); this.state = { err: null }; }
      static getDerivedStateFromError(e) { return { err: e }; }
      render() {
        if (this.state.err) return <div style={{ padding: 40, textAlign: "center", color: "var(--red)" }}>
          <h2>Error de renderizado</h2>
          <p style={{ color: "var(--text-muted)", margin: "8px 0 16px" }}>{String(this.state.err.message)}</p>
          <button className="btn-primary" onClick={() => { this.setState({ err: null }); location.reload(); }}>Recargar</button>
        </div>;
        return this.props.children;
      }
    }

    // Recharts
    const RC = typeof Recharts !== "undefined";
    const { AreaChart, Area, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, PieChart, Pie, Cell } = RC ? Recharts : {};

    const COLORS = ["#e1306c", "#833ab4", "#f59e0b", "#3b82f6", "#22c55e", "#ef4444", "#8b5cf6", "#06b6d4"];
    let sb = null;

    async function api(path, opts) {
      const session = sb ? (await sb.auth.getSession()).data.session : null;
      const headers = { ...(opts?.headers || {}) };
      if (session) headers["Authorization"] = "Bearer " + session.access_token;
      const res = await fetch(path, { ...opts, headers });
      const text = await res.text();
      let json; try { json = JSON.parse(text); } catch { throw new Error("Respuesta inv√°lida del servidor"); }
      if (!res.ok) throw new Error(json.error || "Error " + res.status);
      return json;
    }

    function n(v) { return typeof v === "number" ? v.toLocaleString("es-ES") : (v || "‚Äî"); }

    // ‚îÄ‚îÄ Custom Tooltip ‚îÄ‚îÄ
    function Tip({ active, payload, label }) {
      if (!active || !payload?.length) return null;
      return <div style={{ background: "#1a1a1e", border: "1px solid rgba(255,255,255,0.1)", borderRadius: 10, padding: "10px 14px", fontSize: 12 }}>
        <div style={{ color: "var(--text-muted)", marginBottom: 4 }}>{label}</div>
        {payload.map((p, i) => <div key={i} style={{ color: p.color, fontWeight: 600 }}>{p.name}: {n(p.value)}</div>)}
      </div>;
    }

    // ‚îÄ‚îÄ Auth Screen ‚îÄ‚îÄ
    function AuthScreen({ onAuth }) {
      const [mode, setMode] = useState("login");
      const [email, setEmail] = useState(""); const [pw, setPw] = useState("");
      const [error, setError] = useState(null); const [loading, setLoading] = useState(false);
      const submit = async () => {
        setError(null);
        if (!email || !pw) return setError("Rellena todos los campos");
        if (pw.length < 6) return setError("M√≠nimo 6 caracteres");
        setLoading(true);
        try {
          const r = mode === "register" ? await sb.auth.signUp({ email, password: pw }) : await sb.auth.signInWithPassword({ email, password: pw });
          if (r.error) throw r.error;
          if (r.data.user && !r.data.session) { setLoading(false); return alert("Revisa tu email para confirmar."); }
          if (r.data.session) onAuth(r.data.session);
        } catch (e) {
          let m = e.message || "Error";
          if (m.includes("Invalid login")) m = "Email o contrase√±a incorrectos";
          if (m.includes("already registered")) m = "Email ya registrado ‚Äî inicia sesi√≥n";
          setError(m);
        }
        setLoading(false);
      };
      const kd = (e) => { if (e.key === "Enter") submit(); };
      return <div className="auth-wrap"><div className="auth-box">
        <div className="sidebar-logo" style={{ width: 48, height: 48, borderRadius: 14, fontSize: 18, margin: "0 auto 14px" }}>IG</div>
        <h1 style={{ fontSize: 22, fontWeight: 800, marginBottom: 2, letterSpacing: "-0.03em" }}>InstaMetrics</h1>
        <p style={{ color: "var(--text-muted)", fontSize: 13, marginBottom: 24 }}>{mode === "login" ? "Inicia sesi√≥n" : "Crea tu cuenta"}</p>
        <div style={{ display: "flex", flexDirection: "column", gap: 10 }}>
          <input className="auth-input" type="email" placeholder="Email" value={email} onChange={e => setEmail(e.target.value)} onKeyDown={kd} />
          <input className="auth-input" type="password" placeholder="Contrase√±a" value={pw} onChange={e => setPw(e.target.value)} onKeyDown={kd} />
          {error && <div className="auth-error">{error}</div>}
          <button className="btn-primary" style={{ width: "100%", justifyContent: "center", padding: "12px", marginTop: 4 }} onClick={submit} disabled={loading}>
            {loading ? "..." : mode === "login" ? "Entrar" : "Crear cuenta"}
          </button>
          <button className="btn-ghost" onClick={() => { setMode(mode === "login" ? "register" : "login"); setError(null); }}>
            {mode === "login" ? "¬øSin cuenta? Reg√≠strate" : "¬øYa tienes cuenta? Login"}
          </button>
        </div>
      </div></div>;
    }

    // ‚îÄ‚îÄ Dashboard ‚îÄ‚îÄ
    function Dashboard({ session, onLogout }) {
      const [accounts, setAccounts] = useState([]);
      const [selectedId, setSelectedId] = useState(null);
      const [tab, setTab] = useState("overview");
      const [loading, setLoading] = useState(true);
      const [toast, setToast] = useState(null);
      const [insights, setInsights] = useState(null);
      const [media, setMedia] = useState([]);
      const [detailedMedia, setDetailedMedia] = useState(null);
      const [demographics, setDemographics] = useState(null);
      const [loadingData, setLoadingData] = useState(false);
      const [loadingPosts, setLoadingPosts] = useState(false);
      const [ddOpen, setDdOpen] = useState(false);

      // Posts tab state
      const [sortCol, setSortCol] = useState("timestamp");
      const [sortDir, setSortDir] = useState("desc");
      const [typeFilter, setTypeFilter] = useState("all");

      const showToast = (msg, type) => { setToast({ msg, type: type || "success" }); setTimeout(() => setToast(null), 4000); };

      useEffect(() => {
        const p = new URLSearchParams(location.search);
        if (p.get("connected")) { showToast("@" + p.get("connected") + " conectada ‚úì"); history.replaceState({}, "", "/"); }
        if (p.get("error")) { showToast(decodeURIComponent(p.get("error")), "error"); history.replaceState({}, "", "/"); }
        loadAccounts();
      }, []);

      const loadAccounts = async () => {
        try {
          const d = await api("/api/accounts");
          const arr = Array.isArray(d) ? d : [];
          setAccounts(arr);
          if (arr.length > 0 && !selectedId) setSelectedId(arr[0].id);
        } catch (e) { console.error(e); }
        setLoading(false);
      };

      useEffect(() => { if (selectedId) fetchData(); }, [selectedId]);

      const fetchData = async () => {
        setLoadingData(true);
        const r = await Promise.allSettled([
          api("/api/accounts/" + selectedId + "/profile"),
          api("/api/accounts/" + selectedId + "/insights?period=day"),
          api("/api/accounts/" + selectedId + "/media?limit=50"),
        ]);
        if (r[1].status === "fulfilled") setInsights(r[1].value); else setInsights(null);
        if (r[2].status === "fulfilled") { const a = r[2].value?.data || []; setMedia(Array.isArray(a) ? a : []); } else setMedia([]);
        if (r[0].status === "fulfilled" && r[0].value) {
          setAccounts(prev => prev.map(a => a.id === selectedId ? { ...a, ...r[0].value, id: a.id } : a));
        }
        try { setDemographics(await api("/api/accounts/" + selectedId + "/demographics")); } catch { setDemographics(null); }
        setLoadingData(false);
      };

      // Fetch detailed media (with insights per post) ‚Äî only when Posts tab is opened
      useEffect(() => {
        if (tab === "posts" && selectedId && !detailedMedia && !loadingPosts) {
          setLoadingPosts(true);
          api("/api/accounts/" + selectedId + "/media-detailed?limit=50")
            .then(d => { setDetailedMedia(d); setLoadingPosts(false); })
            .catch(e => { console.error(e); setLoadingPosts(false); });
        }
      }, [tab, selectedId]);

      // Reset detailed media when account changes
      useEffect(() => { setDetailedMedia(null); }, [selectedId]);

      const connectIG = async () => {
        const s = (await sb.auth.getSession()).data.session;
        if (!s) return showToast("Sesi√≥n expirada", "error");
        location.href = "/auth/instagram?token=" + s.access_token;
      };

      const removeAccount = async (id) => {
        await api("/api/accounts/" + id, { method: "DELETE" });
        const u = accounts.filter(a => a.id !== id);
        setAccounts(u); if (selectedId === id) setSelectedId(u[0]?.id || null);
        showToast("Eliminada");
      };

      const acc = accounts.find(a => a.id === selectedId) || null;

      // Chart data
      const chartData = (() => {
        if (!insights?.data || !Array.isArray(insights.data)) return [];
        const reach = insights.data.find(m => m?.name === "reach");
        const views = insights.data.find(m => m?.name === "views");
        if (!reach?.values) return [];
        return reach.values.map((v, i) => ({
          date: v?.end_time ? new Date(v.end_time).toLocaleDateString("es-ES", { day: "2-digit", month: "short" }) : "",
          reach: v?.value || 0,
          views: views?.values?.[i]?.value || 0,
        }));
      })();

      // Media stats
      const mStats = (() => {
        if (!Array.isArray(media) || !media.length) return { likes: 0, comments: 0, byType: {} };
        let l = 0, c = 0, bt = {};
        media.forEach(m => { if (!m) return; l += m.like_count || 0; c += m.comments_count || 0; const t = m.media_type || "?"; bt[t] = (bt[t] || 0) + 1; });
        return { likes: l, comments: c, byType: bt };
      })();

      const engRate = acc?.followers_count && media.length
        ? ((mStats.likes + mStats.comments) / Math.max(media.length, 1) / acc.followers_count * 100).toFixed(2) + "%"
        : "‚Äî";

      // ‚îÄ‚îÄ POSTS TAB DATA ‚îÄ‚îÄ
      const posts = detailedMedia?.data || [];
      const followersCount = detailedMedia?.followers_count || acc?.followers_count || 1;

      const filteredPosts = posts.filter(p => {
        if (typeFilter === "all") return true;
        if (typeFilter === "reel") return p.media_type === "VIDEO" || p.media_product_type === "REELS";
        if (typeFilter === "photo") return p.media_type === "IMAGE";
        if (typeFilter === "carousel") return p.media_type === "CAROUSEL_ALBUM";
        return true;
      });

      const sortedPosts = [...filteredPosts].sort((a, b) => {
        let va, vb;
        if (sortCol === "timestamp") { va = new Date(a.timestamp || 0); vb = new Date(b.timestamp || 0); }
        else if (sortCol === "engagement") {
          va = ((a.insights?.total_interactions || (a.like_count || 0) + (a.comments_count || 0)) / followersCount);
          vb = ((b.insights?.total_interactions || (b.like_count || 0) + (b.comments_count || 0)) / followersCount);
        }
        else if (sortCol === "likes") { va = a.like_count || 0; vb = b.like_count || 0; }
        else if (sortCol === "comments") { va = a.comments_count || 0; vb = b.comments_count || 0; }
        else if (sortCol === "reach") { va = a.insights?.reach || 0; vb = b.insights?.reach || 0; }
        else if (sortCol === "saves") { va = a.insights?.saved || 0; vb = b.insights?.saved || 0; }
        else if (sortCol === "shares") { va = a.insights?.shares || 0; vb = b.insights?.shares || 0; }
        else { va = 0; vb = 0; }
        return sortDir === "desc" ? (vb > va ? 1 : -1) : (va > vb ? 1 : -1);
      });

      const toggleSort = (col) => {
        if (sortCol === col) setSortDir(sortDir === "desc" ? "asc" : "desc");
        else { setSortCol(col); setSortDir("desc"); }
      };
      const sortIcon = (col) => sortCol === col ? (sortDir === "desc" ? " ‚Üì" : " ‚Üë") : "";

      // Format comparison
      const formatStats = (() => {
        const types = { reel: { label: "Reels", posts: [], color: "#8b5cf6" }, photo: { label: "Fotos", posts: [], color: "#3b82f6" }, carousel: { label: "Carruseles", posts: [], color: "#f59e0b" } };
        posts.forEach(p => {
          const eng = (p.insights?.total_interactions || (p.like_count || 0) + (p.comments_count || 0)) / followersCount * 100;
          if (p.media_type === "VIDEO" || p.media_product_type === "REELS") types.reel.posts.push({ eng, reach: p.insights?.reach || 0, saves: p.insights?.saved || 0 });
          else if (p.media_type === "IMAGE") types.photo.posts.push({ eng, reach: p.insights?.reach || 0, saves: p.insights?.saved || 0 });
          else if (p.media_type === "CAROUSEL_ALBUM") types.carousel.posts.push({ eng, reach: p.insights?.reach || 0, saves: p.insights?.saved || 0 });
        });
        return Object.entries(types).map(([k, v]) => ({
          key: k, label: v.label, color: v.color, count: v.posts.length,
          avgEng: v.posts.length ? (v.posts.reduce((s, p) => s + p.eng, 0) / v.posts.length) : 0,
          avgReach: v.posts.length ? (v.posts.reduce((s, p) => s + p.reach, 0) / v.posts.length) : 0,
          avgSaves: v.posts.length ? (v.posts.reduce((s, p) => s + p.saves, 0) / v.posts.length) : 0,
        }));
      })();
      const maxEng = Math.max(...formatStats.map(f => f.avgEng), 0.01);
      const maxReach = Math.max(...formatStats.map(f => f.avgReach), 1);

      function TypeBadge({ type, productType }) {
        if (type === "VIDEO" || productType === "REELS") return <span className="badge badge-reel">üé¨ Reel</span>;
        if (type === "CAROUSEL_ALBUM") return <span className="badge badge-carousel">üìë Carrusel</span>;
        return <span className="badge badge-photo">üì∑ Foto</span>;
      }

      if (loading) return <div style={{ display: "flex", alignItems: "center", justifyContent: "center", minHeight: "100vh" }}><div className="spinner"></div></div>;

      return (
        <div className="shell">
          {/* Sidebar */}
          <div className="sidebar">
            <div className="sidebar-brand">
              <div className="sidebar-logo">IG</div>
              <span className="sidebar-title">InstaMetrics</span>
            </div>

            {[
              { id: "overview", icon: "üìä", label: "Overview" },
              { id: "posts", icon: "üìã", label: "An√°lisis de Posts" },
              { id: "audience", icon: "üë•", label: "Audiencia" },
            ].map(t => (
              <button key={t.id} className={"nav-item" + (tab === t.id ? " active" : "")} onClick={() => setTab(t.id)}>
                <span className="nav-icon">{t.icon}</span>{t.label}
              </button>
            ))}

            <div style={{ flex: 1 }} />

            {/* Account selector in sidebar */}
            {acc && (
              <div style={{ borderTop: "1px solid var(--border)", paddingTop: 12, marginTop: 8 }}>
                <div style={{ position: "relative" }}>
                  <button className="nav-item" onClick={() => setDdOpen(!ddOpen)} style={{ width: "100%" }}>
                    {acc.profile_picture_url && <img src={acc.profile_picture_url} style={{ width: 20, height: 20, borderRadius: "50%" }} />}
                    <span style={{ fontSize: 12, flex: 1, textAlign: "left" }}>@{acc.username}</span>
                    <span style={{ fontSize: 10, opacity: 0.4 }}>‚ñº</span>
                  </button>
                  {ddOpen && <div className="dropdown" style={{ bottom: "calc(100% + 4px)", top: "auto", left: 0 }}>
                    {accounts.map(a => (
                      <div key={a.id} className="dropdown-item" onClick={() => { setSelectedId(a.id); setDdOpen(false); }}>
                        {a.profile_picture_url ? <img src={a.profile_picture_url} style={{ width: 20, height: 20, borderRadius: "50%" }} /> : <span style={{ width: 20 }} />}
                        <span style={{ flex: 1 }}>@{a.username}</span>
                        <button className="btn-ghost" onClick={e => { e.stopPropagation(); removeAccount(a.id); }} style={{ fontSize: 14 }}>‚úï</button>
                      </div>
                    ))}
                  </div>}
                </div>
              </div>
            )}

            <button className="btn-primary" style={{ width: "100%", justifyContent: "center", marginTop: 8, fontSize: 12 }} onClick={connectIG}>
              + Conectar cuenta
            </button>
            <button className="btn-ghost" onClick={onLogout} style={{ textAlign: "center", marginTop: 4, fontSize: 11 }}>
              Cerrar sesi√≥n ({session.user.email?.split("@")[0]})
            </button>
          </div>

          {/* Content */}
          <div className="content">
            {!acc ? (
              <div style={{ display: "flex", flexDirection: "column", alignItems: "center", justifyContent: "center", minHeight: "60vh", gap: 16 }}>
                <div className="sidebar-logo" style={{ width: 64, height: 64, borderRadius: 18, fontSize: 28 }}>IG</div>
                <h2 style={{ fontSize: 20, fontWeight: 700 }}>Conecta tu primera cuenta</h2>
                <p style={{ color: "var(--text-muted)", fontSize: 14 }}>Necesitas una cuenta Business o Creator.</p>
                <button className="btn-primary" style={{ padding: "12px 24px", marginTop: 8 }} onClick={connectIG}>+ Conectar Instagram</button>
              </div>
            ) : (
              <div>
                <div className="topbar">
                  <div className="topbar-left">
                    <div style={{ display: "flex", alignItems: "center", gap: 12 }}>
                      {acc.profile_picture_url && <img src={acc.profile_picture_url} style={{ width: 40, height: 40, borderRadius: 12, border: "1px solid var(--border)" }} />}
                      <div>
                        <h1>@{acc.username}</h1>
                        <p>{acc.account_type || ""}{acc.name && acc.name !== acc.username ? " ¬∑ " + acc.name : ""}</p>
                      </div>
                    </div>
                  </div>
                  <button className="btn-outline" onClick={() => { fetchData(); setDetailedMedia(null); }}>üîÑ Actualizar</button>
                </div>

                {loadingData ? <div style={{ display: "flex", justifyContent: "center", padding: 60 }}><div className="spinner"></div></div> : (
                  <div>
                    {/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê OVERVIEW ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */}
                    {tab === "overview" && <>
                      <div className="kpi-grid">
                        <div className="kpi"><div className="kpi-label">Seguidores</div><div className="kpi-value">{n(acc.followers_count || 0)}</div></div>
                        <div className="kpi"><div className="kpi-label">Siguiendo</div><div className="kpi-value">{n(acc.follows_count || 0)}</div></div>
                        <div className="kpi"><div className="kpi-label">Publicaciones</div><div className="kpi-value">{n(acc.media_count || 0)}</div></div>
                        <div className="kpi"><div className="kpi-label">Likes (√∫lt. posts)</div><div className="kpi-value">{n(mStats.likes)}</div></div>
                        <div className="kpi"><div className="kpi-label">Comentarios</div><div className="kpi-value">{n(mStats.comments)}</div></div>
                        <div className="kpi"><div className="kpi-label">Eng. Rate</div><div className="kpi-value">{engRate}</div><div className="kpi-sub">media interacciones / seguidores</div></div>
                      </div>

                      <div className="grid-2">
                        {RC && chartData.length > 0 && (
                          <div className="panel grid-full">
                            <div className="panel-title">Alcance y Visualizaciones (diario)</div>
                            <ResponsiveContainer width="100%" height={260}>
                              <AreaChart data={chartData}>
                                <defs>
                                  <linearGradient id="gR" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stopColor="#e1306c" stopOpacity={0.2} /><stop offset="100%" stopColor="#e1306c" stopOpacity={0} /></linearGradient>
                                  <linearGradient id="gV" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stopColor="#3b82f6" stopOpacity={0.2} /><stop offset="100%" stopColor="#3b82f6" stopOpacity={0} /></linearGradient>
                                </defs>
                                <CartesianGrid strokeDasharray="3 3" stroke="rgba(255,255,255,0.04)" />
                                <XAxis dataKey="date" stroke="rgba(255,255,255,0.15)" fontSize={11} tickLine={false} />
                                <YAxis stroke="rgba(255,255,255,0.15)" fontSize={11} tickLine={false} tickFormatter={v => v >= 1000 ? (v/1000).toFixed(1)+"k" : v} />
                                <Tooltip content={<Tip />} />
                                <Area type="monotone" dataKey="reach" stroke="#e1306c" strokeWidth={2} fill="url(#gR)" name="Alcance" />
                                <Area type="monotone" dataKey="views" stroke="#3b82f6" strokeWidth={2} fill="url(#gV)" name="Visualizaciones" />
                              </AreaChart>
                            </ResponsiveContainer>
                          </div>
                        )}

                        {/* Top 5 posts quick view */}
                        <div className="panel">
                          <div className="panel-title">üèÜ Top Posts (por likes)</div>
                          <div style={{ display: "flex", flexDirection: "column", gap: 8 }}>
                            {media.slice().sort((a, b) => (b.like_count || 0) - (a.like_count || 0)).slice(0, 5).map((m, i) => (
                              <a key={m.id || i} href={m.permalink || "#"} target="_blank" rel="noopener"
                                style={{ display: "flex", alignItems: "center", gap: 10, padding: "8px 10px", borderRadius: 8, background: "rgba(255,255,255,0.02)", transition: "background 0.15s" }}>
                                {(m.thumbnail_url || m.media_url) && <img src={m.thumbnail_url || m.media_url} style={{ width: 38, height: 38, borderRadius: 6, objectFit: "cover" }} onError={e => e.target.style.display="none"} />}
                                <div style={{ flex: 1, minWidth: 0 }}>
                                  <div style={{ fontSize: 12, fontWeight: 600, overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>
                                    {m.caption ? m.caption.slice(0, 40) : "Sin caption"}
                                  </div>
                                  <div style={{ fontSize: 11, color: "var(--text-dim)" }}>{m.timestamp ? new Date(m.timestamp).toLocaleDateString("es-ES") : ""}</div>
                                </div>
                                <div style={{ fontSize: 13, fontWeight: 700, color: "var(--accent)" }}>‚ù§ {n(m.like_count || 0)}</div>
                              </a>
                            ))}
                            {media.length === 0 && <p className="empty-msg">No hay publicaciones</p>}
                          </div>
                        </div>

                        {/* Content distribution */}
                        <div className="panel">
                          <div className="panel-title">Distribuci√≥n de contenido</div>
                          {Object.entries(mStats.byType).length > 0 ? (
                            <div style={{ display: "flex", flexDirection: "column", gap: 10 }}>
                              {Object.entries(mStats.byType).map(([type, count], i) => {
                                const labels = { IMAGE: "Fotos", VIDEO: "Reels/Video", CAROUSEL_ALBUM: "Carruseles" };
                                const pct = (count / Math.max(media.length, 1) * 100);
                                return <div key={type}>
                                  <div style={{ display: "flex", justifyContent: "space-between", fontSize: 12, marginBottom: 4 }}>
                                    <span style={{ fontWeight: 600 }}>{labels[type] || type}</span>
                                    <span style={{ color: "var(--text-muted)" }}>{count} ({pct.toFixed(0)}%)</span>
                                  </div>
                                  <div style={{ height: 6, borderRadius: 3, background: "rgba(255,255,255,0.04)", overflow: "hidden" }}>
                                    <div style={{ height: "100%", borderRadius: 3, width: pct + "%", background: COLORS[i % COLORS.length] }} />
                                  </div>
                                </div>;
                              })}
                            </div>
                          ) : <p className="empty-msg">Sin datos</p>}
                        </div>

                        {chartData.length === 0 && <div className="panel grid-full"><p className="empty-msg">üìà Los insights aparecer√°n cuando Instagram tenga datos suficientes.</p></div>}
                      </div>
                    </>}

                    {/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê POSTS ANALYSIS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */}
                    {tab === "posts" && <>
                      {loadingPosts ? (
                        <div style={{ display: "flex", flexDirection: "column", alignItems: "center", gap: 12, padding: 60 }}>
                          <div className="spinner"></div>
                          <p style={{ fontSize: 13, color: "var(--text-muted)" }}>Cargando insights de cada post... (puede tardar unos segundos)</p>
                        </div>
                      ) : posts.length === 0 ? (
                        <p className="empty-msg">No hay posts con insights disponibles</p>
                      ) : <>
                        {/* Format Comparison */}
                        <div className="grid-2" style={{ marginBottom: 16 }}>
                          <div className="panel">
                            <div className="panel-title">Engagement medio por formato</div>
                            {formatStats.map(f => f.count > 0 && (
                              <div className="format-row" key={f.key}>
                                <div className="format-label" style={{ color: f.color }}>{f.label} <span style={{ color: "var(--text-dim)", fontWeight: 400 }}>({f.count})</span></div>
                                <div className="format-bar-bg">
                                  <div className="format-bar" style={{ width: (f.avgEng / maxEng * 100) + "%", background: f.color + "30" }}></div>
                                </div>
                                <div className="format-val">{f.avgEng.toFixed(2)}%</div>
                              </div>
                            ))}
                          </div>
                          <div className="panel">
                            <div className="panel-title">Alcance medio por formato</div>
                            {formatStats.map(f => f.count > 0 && (
                              <div className="format-row" key={f.key}>
                                <div className="format-label" style={{ color: f.color }}>{f.label}</div>
                                <div className="format-bar-bg">
                                  <div className="format-bar" style={{ width: (f.avgReach / maxReach * 100) + "%", background: f.color + "30" }}></div>
                                </div>
                                <div className="format-val">{n(Math.round(f.avgReach))}</div>
                              </div>
                            ))}
                          </div>
                        </div>

                        {/* Filter + Table */}
                        <div className="panel">
                          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 14 }}>
                            <div className="panel-title" style={{ margin: 0 }}>Todos los posts ({filteredPosts.length})</div>
                          </div>
                          <div className="filter-bar">
                            {[
                              { id: "all", label: "Todos" },
                              { id: "reel", label: "üé¨ Reels" },
                              { id: "photo", label: "üì∑ Fotos" },
                              { id: "carousel", label: "üìë Carruseles" },
                            ].map(f => (
                              <button key={f.id} className={"filter-chip" + (typeFilter === f.id ? " active" : "")} onClick={() => setTypeFilter(f.id)}>
                                {f.label}
                              </button>
                            ))}
                          </div>

                          <div style={{ overflowX: "auto" }}>
                            <table className="posts-table">
                              <thead>
                                <tr>
                                  <th style={{ width: 40 }}>#</th>
                                  <th>Tipo</th>
                                  <th onClick={() => toggleSort("timestamp")}>Fecha{sortIcon("timestamp")}</th>
                                  <th style={{ maxWidth: 200 }}>Caption</th>
                                  <th className="num" onClick={() => toggleSort("likes")}>‚ù§ Likes{sortIcon("likes")}</th>
                                  <th className="num" onClick={() => toggleSort("comments")}>üí¨ Com.{sortIcon("comments")}</th>
                                  <th className="num" onClick={() => toggleSort("reach")}>üëÅ Reach{sortIcon("reach")}</th>
                                  <th className="num" onClick={() => toggleSort("saves")}>üîñ Saves{sortIcon("saves")}</th>
                                  <th className="num" onClick={() => toggleSort("shares")}>‚Üó Shares{sortIcon("shares")}</th>
                                  <th className="num" onClick={() => toggleSort("engagement")}>üìä Eng%{sortIcon("engagement")}</th>
                                </tr>
                              </thead>
                              <tbody>
                                {sortedPosts.map((p, i) => {
                                  const eng = ((p.insights?.total_interactions || (p.like_count || 0) + (p.comments_count || 0)) / followersCount * 100);
                                  return (
                                    <tr key={p.id || i}>
                                      <td style={{ color: "var(--text-dim)", fontSize: 11 }}>{i + 1}</td>
                                      <td><TypeBadge type={p.media_type} productType={p.media_product_type} /></td>
                                      <td style={{ fontSize: 12, whiteSpace: "nowrap" }}>{p.timestamp ? new Date(p.timestamp).toLocaleDateString("es-ES") : "‚Äî"}</td>
                                      <td className="caption-cell">
                                        <a href={p.permalink || "#"} target="_blank" rel="noopener" style={{ color: "var(--text-muted)" }}>
                                          {p.caption ? p.caption.slice(0, 50) + (p.caption.length > 50 ? "..." : "") : "‚Äî"}
                                        </a>
                                      </td>
                                      <td className="num">{n(p.like_count || 0)}</td>
                                      <td className="num">{n(p.comments_count || 0)}</td>
                                      <td className="num">{n(p.insights?.reach || 0)}</td>
                                      <td className="num">{n(p.insights?.saved || 0)}</td>
                                      <td className="num">{n(p.insights?.shares || 0)}</td>
                                      <td className="num" style={{ color: eng > 5 ? "var(--green)" : eng > 2 ? "var(--orange)" : "var(--text-muted)", fontWeight: 700 }}>
                                        {eng.toFixed(2)}%
                                      </td>
                                    </tr>
                                  );
                                })}
                              </tbody>
                            </table>
                          </div>
                        </div>
                      </>}
                    </>}

                    {/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AUDIENCE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */}
                    {tab === "audience" && (
                      <div className="grid-2">
                        {demographics?.data && Array.isArray(demographics.data) ? demographics.data.map((metric, idx) => {
                          const br = metric?.total_value?.breakdowns?.[0]?.results;
                          if (!br) return <div key={idx} className="panel"><div className="panel-title">{metric?.title || metric?.name}</div><p className="empty-msg">Sin datos</p></div>;
                          const sorted = [...br].sort((a, b) => (b.value || 0) - (a.value || 0));
                          const max = sorted[0]?.value || 1;
                          return (
                            <div key={idx} className="panel">
                              <div className="panel-title">{metric.title || metric.name}</div>
                              <div style={{ display: "flex", flexDirection: "column", gap: 8 }}>
                                {sorted.slice(0, 12).map((item, i) => (
                                  <div key={i}>
                                    <div style={{ display: "flex", justifyContent: "space-between", fontSize: 12, marginBottom: 3 }}>
                                      <span style={{ fontWeight: 500 }}>{Object.values(item.dimension_values || {}).join(" ¬∑ ") || "‚Äî"}</span>
                                      <span style={{ fontWeight: 600, color: COLORS[i % COLORS.length] }}>{n(item.value || 0)}</span>
                                    </div>
                                    <div style={{ height: 5, borderRadius: 3, background: "rgba(255,255,255,0.04)", overflow: "hidden" }}>
                                      <div style={{ height: "100%", borderRadius: 3, width: ((item.value || 0) / max * 100) + "%", background: COLORS[i % COLORS.length] }} />
                                    </div>
                                  </div>
                                ))}
                              </div>
                            </div>
                          );
                        }) : (
                          <div className="panel grid-full">
                            <p className="empty-msg">üë• Los datos demogr√°ficos requieren al menos 100 seguidores.</p>
                          </div>
                        )}
                      </div>
                    )}
                  </div>
                )}
              </div>
            )}
          </div>

          {toast && <div className={"toast " + toast.type}>{toast.msg}</div>}
          {ddOpen && <div style={{ position: "fixed", inset: 0, zIndex: 49 }} onClick={() => setDdOpen(false)} />}
        </div>
      );
    }

    // ‚îÄ‚îÄ Root ‚îÄ‚îÄ
    function App() {
      const [session, setSession] = useState(null);
      const [loading, setLoading] = useState(true);
      useEffect(() => {
        fetch("/api/config").then(r => r.json()).then(cfg => {
          sb = window.supabase.createClient(cfg.supabaseUrl, cfg.supabaseAnonKey);
          sb.auth.getSession().then(r => { if (r.data.session) setSession(r.data.session); setLoading(false); });
          sb.auth.onAuthStateChange((_, s) => setSession(s));
        }).catch(() => setLoading(false));
      }, []);
      if (loading) return <div style={{ display: "flex", alignItems: "center", justifyContent: "center", minHeight: "100vh" }}><div className="spinner"></div></div>;
      if (!session) return <AuthScreen onAuth={s => setSession(s)} />;
      return <Dashboard session={session} onLogout={async () => { await sb.auth.signOut(); setSession(null); }} />;
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<ErrorBoundary><App /></ErrorBoundary>);
  </script>
</body>
</html>
