<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>InstaMetrics ‚Äî Instagram Analytics</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script crossorigin src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
  <script crossorigin src="https://unpkg.com/recharts@2.5.0/umd/Recharts.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'DM Sans', -apple-system, sans-serif;
      background: #0a0a14;
      color: #fff;
      min-height: 100vh;
    }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }
    a { color: inherit; text-decoration: none; }

    .header {
      border-bottom: 1px solid rgba(255,255,255,0.06);
      padding: 16px 28px;
      display: flex; align-items: center; justify-content: space-between;
      backdrop-filter: blur(20px);
      position: sticky; top: 0; z-index: 100;
      background: rgba(10,10,20,0.88);
    }
    .header-brand { display: flex; align-items: center; gap: 12px; }
    .header-logo {
      width: 38px; height: 38px; border-radius: 12px;
      background: linear-gradient(135deg, #F58529, #DD2A7B, #8134AF);
      display: flex; align-items: center; justify-content: center;
      font-weight: 800; font-size: 16px; color: #fff;
    }
    .header-title { font-weight: 700; font-size: 17px; letter-spacing: -0.01em; }
    .header-sub { font-size: 12px; color: rgba(255,255,255,0.4); font-weight: 500; }

    .btn-connect {
      background: linear-gradient(135deg, #DD2A7B, #8134AF);
      border: none; border-radius: 12px; padding: 10px 20px;
      color: #fff; font-size: 14px; font-weight: 600; cursor: pointer;
      font-family: inherit; display: flex; align-items: center; gap: 7px;
      transition: transform 0.2s, box-shadow 0.2s;
      box-shadow: 0 4px 16px rgba(221,42,123,0.3);
    }
    .btn-connect:hover { transform: scale(1.03); box-shadow: 0 6px 24px rgba(221,42,123,0.4); }

    .btn-secondary {
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px; padding: 10px 16px;
      color: #fff; font-size: 14px; font-weight: 600;
      cursor: pointer; font-family: inherit;
      display: flex; align-items: center; gap: 8px;
      transition: all 0.2s;
    }
    .btn-secondary:hover { background: rgba(255,255,255,0.1); }

    .btn-ghost {
      background: none; border: none; color: rgba(255,255,255,0.5);
      font-size: 13px; cursor: pointer; font-family: inherit;
      padding: 4px 0; transition: color 0.2s;
    }
    .btn-ghost:hover { color: #fff; }

    .main { padding: 24px 28px; max-width: 1300px; margin: 0 auto; }

    .card {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 16px; padding: 20px 22px;
      transition: all 0.3s ease;
    }
    .card:hover { background: rgba(255,255,255,0.06); border-color: rgba(255,255,255,0.12); }

    .chart-card {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 18px; padding: 24px;
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
      gap: 14px; margin-bottom: 24px;
    }
    .charts-grid {
      display: grid; grid-template-columns: 1fr 1fr; gap: 16px;
    }
    .charts-grid .full-width { grid-column: 1 / -1; }

    .account-selector { position: relative; display: inline-block; }
    .dropdown {
      position: absolute; top: calc(100% + 6px); right: 0;
      background: #1a1a2e; border: 1px solid rgba(255,255,255,0.1);
      border-radius: 14px; overflow: hidden; min-width: 240px;
      box-shadow: 0 16px 48px rgba(0,0,0,0.5); z-index: 200;
    }
    .dropdown-item {
      padding: 12px 16px; display: flex; align-items: center;
      justify-content: space-between; cursor: pointer; transition: background 0.15s;
    }
    .dropdown-item:hover { background: rgba(255,255,255,0.08); }

    .tabs {
      display: flex; gap: 4px; background: rgba(255,255,255,0.04);
      border-radius: 12px; padding: 4px;
    }
    .tab {
      background: transparent; border: none; border-radius: 9px;
      padding: 8px 18px; color: rgba(255,255,255,0.4);
      font-size: 13px; font-weight: 600; cursor: pointer;
      font-family: inherit; text-transform: capitalize; transition: all 0.2s;
    }
    .tab.active { background: rgba(255,255,255,0.1); color: #fff; }

    .media-grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 14px;
    }
    .media-item {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 14px; overflow: hidden; transition: all 0.3s;
    }
    .media-item:hover { border-color: rgba(255,255,255,0.15); transform: translateY(-2px); }
    .media-info { padding: 12px 14px; }

    .toast {
      position: fixed; bottom: 24px; right: 24px;
      padding: 14px 22px; border-radius: 14px;
      font-size: 14px; font-weight: 600; z-index: 1000;
      animation: slideIn 0.3s ease;
    }
    .toast.success { background: #38EF7D22; border: 1px solid #38EF7D44; color: #38EF7D; }
    .toast.error { background: #FF6B6B22; border: 1px solid #FF6B6B44; color: #FF6B6B; }

    .loading-spinner {
      width: 24px; height: 24px; border: 3px solid rgba(255,255,255,0.1);
      border-top-color: #DD2A7B; border-radius: 50%;
      animation: spin 0.8s linear infinite; margin: 40px auto;
    }

    .token-warning {
      background: rgba(255,152,0,0.1); border: 1px solid rgba(255,152,0,0.3);
      border-radius: 12px; padding: 12px 18px; margin-bottom: 16px;
      font-size: 13px; color: #FFB74D; display: flex; align-items: center; gap: 10px;
    }

    /* AUTH FORMS */
    .auth-container {
      display: flex; align-items: center; justify-content: center;
      min-height: 100vh; padding: 20px;
    }
    .auth-box {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 24px; padding: 40px 36px;
      width: 100%; max-width: 400px;
      text-align: center;
    }
    .auth-input {
      width: 100%; padding: 14px 18px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px; color: #fff;
      font-size: 15px; font-family: inherit;
      outline: none; transition: border-color 0.2s;
    }
    .auth-input:focus { border-color: rgba(221,42,123,0.5); }
    .auth-input::placeholder { color: rgba(255,255,255,0.3); }
    .auth-error {
      background: rgba(255,100,100,0.08); border: 1px solid rgba(255,100,100,0.2);
      border-radius: 10px; padding: 10px 14px;
      font-size: 13px; color: #FF6B6B; text-align: left;
    }

    @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes spin { to { transform: rotate(360deg); } }

    @media (max-width: 768px) {
      .header { padding: 12px 16px; flex-wrap: wrap; gap: 12px; }
      .main { padding: 16px; }
      .charts-grid { grid-template-columns: 1fr; }
      .metrics-grid { grid-template-columns: repeat(2, 1fr); }
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel" data-type="module">
    if (typeof React === 'undefined' || typeof ReactDOM === 'undefined') {
      document.getElementById('root').innerHTML = '<div style="padding:40px;text-align:center;color:#FF6B6B">Error cargando React</div>';
      throw new Error('React failed');
    }

    const { useState, useEffect, useRef, Component } = React;

    // ================================================================
    // ErrorBoundary
    // ================================================================
    class ErrorBoundary extends Component {
      constructor(props) { super(props); this.state = { hasError: false, error: null }; }
      static getDerivedStateFromError(error) { return { hasError: true, error }; }
      componentDidCatch(error, info) { console.error("Render crash:", error, info); }
      render() {
        if (this.state.hasError) {
          return (
            <div style={{ padding: 40, textAlign: "center", color: "#FF6B6B" }}>
              <div style={{ fontSize: 48, marginBottom: 16 }}>üí•</div>
              <h2 style={{ marginBottom: 8 }}>Error de renderizado</h2>
              <p style={{ color: "rgba(255,255,255,0.5)", marginBottom: 16 }}>{this.state.error ? String(this.state.error.message) : ""}</p>
              <button className="btn-connect" style={{ margin: "0 auto" }}
                onClick={() => { this.setState({ hasError: false }); window.location.reload(); }}>Recargar</button>
            </div>
          );
        }
        return this.props.children;
      }
    }

    // ================================================================
    // Recharts
    // ================================================================
    const RC = typeof Recharts !== 'undefined';
    const AreaChart = RC ? Recharts.AreaChart : function() { return null; };
    const Area = RC ? Recharts.Area : function() { return null; };
    const XAxis = RC ? Recharts.XAxis : function() { return null; };
    const YAxis = RC ? Recharts.YAxis : function() { return null; };
    const CartesianGrid = RC ? Recharts.CartesianGrid : function() { return null; };
    const Tooltip = RC ? Recharts.Tooltip : function() { return null; };
    const ResponsiveContainer = RC ? Recharts.ResponsiveContainer : function(p) { return React.createElement('div', null, p.children); };
    const PieChart = RC ? Recharts.PieChart : function() { return null; };
    const Pie = RC ? Recharts.Pie : function() { return null; };
    const Cell = RC ? Recharts.Cell : function() { return null; };

    const COLORS = ["#DD2A7B", "#8134AF", "#F58529", "#515BD4", "#1DA1F2", "#38EF7D", "#FC466B", "#FFD200"];
    const PIE_COLORS = ["#DD2A7B", "#8134AF", "#F58529", "#515BD4"];

    // ================================================================
    // Supabase client (initialized after loading config)
    // ================================================================
    let sb = null;

    // API helper ‚Äî includes auth token
    async function api(path, opts) {
      var session = sb ? (await sb.auth.getSession()).data.session : null;
      var headers = (opts && opts.headers) ? opts.headers : {};
      if (session) headers["Authorization"] = "Bearer " + session.access_token;
      var res = await fetch(path, Object.assign({}, opts || {}, { headers: headers }));
      var body = await res.text();
      var json;
      try { json = JSON.parse(body); } catch(e) { throw new Error("Non-JSON response"); }
      if (!res.ok) throw new Error(json.error || "Error " + res.status);
      return json;
    }

    // ================================================================
    // Auth Screen (Login / Register)
    // ================================================================
    function AuthScreen({ onAuth }) {
      var [mode, setMode] = useState("login");
      var [email, setEmail] = useState("");
      var [password, setPassword] = useState("");
      var [error, setError] = useState(null);
      var [loading, setLoading] = useState(false);

      var handleSubmit = async function() {
        setError(null);
        if (!email || !password) return setError("Rellena todos los campos");
        if (password.length < 6) return setError("La contrase√±a debe tener al menos 6 caracteres");
        setLoading(true);

        try {
          var result;
          if (mode === "register") {
            result = await sb.auth.signUp({ email: email, password: password });
            if (result.error) throw result.error;
            // Supabase may require email confirmation ‚Äî check
            if (result.data.user && !result.data.session) {
              setError(null);
              setLoading(false);
              return alert("Revisa tu email para confirmar tu cuenta. Si no llega, mira en spam.");
            }
          } else {
            result = await sb.auth.signInWithPassword({ email: email, password: password });
            if (result.error) throw result.error;
          }
          if (result.data.session) onAuth(result.data.session);
        } catch (e) {
          var msg = e.message || "Error desconocido";
          if (msg.includes("Invalid login")) msg = "Email o contrase√±a incorrectos";
          if (msg.includes("already registered")) msg = "Este email ya est√° registrado. Haz login.";
          setError(msg);
        }
        setLoading(false);
      };

      var handleKeyDown = function(e) { if (e.key === "Enter") handleSubmit(); };

      return (
        <div className="auth-container">
          <div className="auth-box">
            <div className="header-logo" style={{ width: 56, height: 56, borderRadius: 18, fontSize: 22, margin: "0 auto 16px" }}>IG</div>
            <h1 style={{ fontSize: 26, fontWeight: 800, marginBottom: 4, letterSpacing: "-0.02em" }}>InstaMetrics</h1>
            <p style={{ color: "rgba(255,255,255,0.4)", fontSize: 14, marginBottom: 28 }}>
              {mode === "login" ? "Inicia sesi√≥n para ver tus m√©tricas" : "Crea tu cuenta"}
            </p>

            <div style={{ display: "flex", flexDirection: "column", gap: 12 }}>
              <input className="auth-input" type="email" placeholder="Email"
                value={email} onChange={function(e) { setEmail(e.target.value); }} onKeyDown={handleKeyDown} />
              <input className="auth-input" type="password" placeholder="Contrase√±a (m√≠n. 6 caracteres)"
                value={password} onChange={function(e) { setPassword(e.target.value); }} onKeyDown={handleKeyDown} />

              {error && <div className="auth-error">{error}</div>}

              <button className="btn-connect" style={{ width: "100%", justifyContent: "center", padding: "14px 20px", marginTop: 4 }}
                onClick={handleSubmit} disabled={loading}>
                {loading ? "Cargando..." : (mode === "login" ? "Entrar" : "Crear cuenta")}
              </button>

              <button className="btn-ghost" style={{ marginTop: 4 }}
                onClick={function() { setMode(mode === "login" ? "register" : "login"); setError(null); }}>
                {mode === "login" ? "¬øNo tienes cuenta? Reg√≠strate" : "¬øYa tienes cuenta? Inicia sesi√≥n"}
              </button>
            </div>
          </div>
        </div>
      );
    }

    // ================================================================
    // Chart Tooltip
    // ================================================================
    function ChartTooltip({ active, payload, label }) {
      if (!active || !payload || !payload.length) return null;
      return React.createElement('div', {
        style: { background: "#1a1a2e", border: "1px solid rgba(255,255,255,0.12)", borderRadius: 12, padding: "12px 16px" }
      },
        React.createElement('div', { style: { fontSize: 12, color: "rgba(255,255,255,0.5)", marginBottom: 6 } }, label || ""),
        ...(Array.isArray(payload) ? payload : []).map(function(p, i) {
          return React.createElement('div', { key: i, style: { fontSize: 13, color: p.color, fontWeight: 600, marginBottom: 2 } },
            (p.name || "") + ": " + (typeof p.value === "number" ? p.value.toLocaleString("es-ES") : p.value));
        })
      );
    }

    // ================================================================
    // Metric Card
    // ================================================================
    function MetricCard({ icon, label, value, color }) {
      return (
        <div className="card" style={{ display: "flex", flexDirection: "column", gap: 10, cursor: "default" }}>
          <div style={{ width: 36, height: 36, borderRadius: 10, background: (color || "#888") + "20",
            display: "flex", alignItems: "center", justifyContent: "center", fontSize: 18 }}>{icon}</div>
          <div>
            <div style={{ fontSize: 26, fontWeight: 700, letterSpacing: "-0.02em" }}>
              {typeof value === "number" ? value.toLocaleString("es-ES") : (value || "‚Äî")}
            </div>
            <div style={{ fontSize: 13, color: "rgba(255,255,255,0.45)", marginTop: 2, fontWeight: 500 }}>{label}</div>
          </div>
        </div>
      );
    }

    // ================================================================
    // Dashboard (authenticated)
    // ================================================================
    function Dashboard({ session, onLogout }) {
      var [accounts, setAccounts] = useState([]);
      var [selectedId, setSelectedId] = useState(null);
      var [dropdownOpen, setDropdownOpen] = useState(false);
      var [tab, setTab] = useState("overview");
      var [loading, setLoading] = useState(true);
      var [toast, setToast] = useState(null);
      var [insights, setInsights] = useState(null);
      var [media, setMedia] = useState([]);
      var [demographics, setDemographics] = useState(null);
      var [loadingData, setLoadingData] = useState(false);

      var showToast = function(msg, type) {
        setToast({ msg: msg, type: type || "success" });
        setTimeout(function() { setToast(null); }, 4000);
      };

      useEffect(function() {
        var params = new URLSearchParams(window.location.search);
        if (params.get("connected")) {
          showToast("@" + params.get("connected") + " conectada ‚úì");
          window.history.replaceState({}, "", "/");
        }
        if (params.get("error")) {
          showToast(decodeURIComponent(params.get("error")), "error");
          window.history.replaceState({}, "", "/");
        }
        loadAccountsList();
      }, []);

      var loadAccountsList = async function() {
        try {
          var data = await api("/api/accounts");
          var arr = Array.isArray(data) ? data : [];
          setAccounts(arr);
          if (arr.length > 0 && !selectedId) setSelectedId(arr[0].id);
        } catch (e) {
          console.error("Load accounts error:", e.message);
        }
        setLoading(false);
      };

      useEffect(function() {
        if (!selectedId) return;
        fetchAccountData();
      }, [selectedId]);

      var fetchAccountData = async function() {
        setLoadingData(true);
        try {
          var results = await Promise.allSettled([
            api("/api/accounts/" + selectedId + "/profile"),
            api("/api/accounts/" + selectedId + "/insights?period=day"),
            api("/api/accounts/" + selectedId + "/media?limit=25"),
          ]);

          if (results[1].status === "fulfilled" && results[1].value) setInsights(results[1].value);
          else setInsights(null);

          if (results[2].status === "fulfilled" && results[2].value) {
            var arr = (results[2].value && results[2].value.data) || [];
            setMedia(Array.isArray(arr) ? arr : []);
          } else setMedia([]);

          if (results[0].status === "fulfilled" && results[0].value) {
            setAccounts(function(prev) {
              return prev.map(function(a) {
                return a.id === selectedId ? Object.assign({}, a, results[0].value, { id: a.id }) : a;
              });
            });
          }

          try {
            var demo = await api("/api/accounts/" + selectedId + "/demographics");
            setDemographics(demo);
          } catch(e) { setDemographics(null); }
        } catch (e) {
          showToast("Error: " + e.message, "error");
        }
        setLoadingData(false);
      };

      var connectInstagram = async function() {
        var sess = (await sb.auth.getSession()).data.session;
        if (!sess) return showToast("Sesi√≥n expirada, recarga la p√°gina", "error");
        window.location.href = "/auth/instagram?token=" + sess.access_token;
      };

      var removeAccount = async function(id) {
        try {
          await api("/api/accounts/" + id, { method: "DELETE" });
          var updated = accounts.filter(function(a) { return a.id !== id; });
          setAccounts(updated);
          if (selectedId === id) setSelectedId(updated[0] ? updated[0].id : null);
          showToast("Cuenta eliminada");
        } catch (e) { showToast("Error: " + e.message, "error"); }
      };

      var refreshToken = async function(id) {
        try {
          await api("/api/accounts/" + id + "/refresh-token", { method: "POST" });
          showToast("Token renovado ‚úì");
          loadAccountsList();
        } catch (e) { showToast("Error: " + e.message, "error"); }
      };

      var acc = accounts.find(function(a) { return a.id === selectedId; }) || null;

      var chartData = (function() {
        if (!insights || !insights.data || !Array.isArray(insights.data)) return [];
        var reach = insights.data.find(function(m) { return m && m.name === "reach"; });
        var views = insights.data.find(function(m) { return m && m.name === "views"; });
        if (!reach || !reach.values || !Array.isArray(reach.values)) return [];
        return reach.values.map(function(v, i) {
          return {
            date: v && v.end_time ? new Date(v.end_time).toLocaleDateString("es-ES", { day: "2-digit", month: "short" }) : "",
            reach: (v && v.value) || 0,
            views: views && views.values && views.values[i] ? (views.values[i].value || 0) : 0,
          };
        });
      })();

      var mediaStats = (function() {
        if (!Array.isArray(media) || !media.length) return { totalLikes: 0, totalComments: 0, byType: {} };
        var tl = 0, tc = 0, bt = {};
        media.forEach(function(m) {
          if (!m) return;
          tl += m.like_count || 0; tc += m.comments_count || 0;
          var t = m.media_type || "UNKNOWN"; bt[t] = (bt[t] || 0) + 1;
        });
        return { totalLikes: tl, totalComments: tc, byType: bt };
      })();

      var contentDistribution = Object.entries(mediaStats.byType).map(function(e) {
        var labels = { IMAGE: "Fotos", VIDEO: "Reels/Video", CAROUSEL_ALBUM: "Carruseles" };
        return { name: labels[e[0]] || e[0], value: e[1] };
      });

      var daysUntilExpiry = acc && acc.token_expires_at
        ? Math.floor((acc.token_expires_at - Date.now()) / 86400000)
        : null;

      var engRate = (function() {
        if (!acc || !acc.followers_count || !media.length) return "‚Äî";
        return ((mediaStats.totalLikes + mediaStats.totalComments) / Math.max(media.length, 1) / acc.followers_count * 100).toFixed(2) + "%";
      })();

      if (loading) {
        return <div style={{ display: "flex", alignItems: "center", justifyContent: "center", minHeight: "100vh" }}>
          <div className="loading-spinner"></div>
        </div>;
      }

      return (
        <div>
          {/* Header */}
          <div className="header">
            <div className="header-brand">
              <div className="header-logo">IG</div>
              <div>
                <div className="header-title">InstaMetrics</div>
                <div className="header-sub">{session.user.email}</div>
              </div>
            </div>
            <div style={{ display: "flex", alignItems: "center", gap: 12 }}>
              {accounts.length > 0 && acc && (
                <div className="account-selector">
                  <button className="btn-secondary" onClick={function() { setDropdownOpen(!dropdownOpen); }}>
                    {acc.profile_picture_url && <img src={acc.profile_picture_url} style={{ width: 22, height: 22, borderRadius: "50%" }} />}
                    {"@" + (acc.username || "Seleccionar")}
                    <span style={{ opacity: 0.4, fontSize: 12 }}>‚ñº</span>
                  </button>
                  {dropdownOpen && (
                    <div className="dropdown">
                      {accounts.map(function(a, i) {
                        return (
                          <div key={a.id} className="dropdown-item"
                            onClick={function() { setSelectedId(a.id); setDropdownOpen(false); }}>
                            <div style={{ display: "flex", alignItems: "center", gap: 10 }}>
                              {a.profile_picture_url
                                ? <img src={a.profile_picture_url} style={{ width: 24, height: 24, borderRadius: "50%" }} />
                                : <span style={{ width: 8, height: 8, borderRadius: "50%", background: COLORS[i % COLORS.length], display: "inline-block" }}></span>}
                              <span style={{ fontSize: 14, fontWeight: 500 }}>{"@" + a.username}</span>
                            </div>
                            <button onClick={function(e) { e.stopPropagation(); removeAccount(a.id); }}
                              style={{ background: "none", border: "none", cursor: "pointer", color: "rgba(255,255,255,0.3)", fontSize: 16, padding: "2px 6px" }}>‚úï</button>
                          </div>
                        );
                      })}
                    </div>
                  )}
                </div>
              )}
              <button className="btn-connect" onClick={connectInstagram}>+ Conectar cuenta</button>
              <button className="btn-ghost" onClick={onLogout} style={{ fontSize: 12 }}>Cerrar sesi√≥n</button>
            </div>
          </div>

          {/* Main */}
          <div className="main">
            {!acc ? (
              <div style={{ display: "flex", flexDirection: "column", alignItems: "center", justifyContent: "center", minHeight: "60vh", gap: 18, textAlign: "center" }}>
                <div style={{ width: 80, height: 80, borderRadius: 24, background: "linear-gradient(135deg, #F58529, #DD2A7B, #8134AF, #515BD4)",
                  display: "flex", alignItems: "center", justifyContent: "center", fontSize: 36 }}>üìä</div>
                <h2 style={{ fontSize: 24, fontWeight: 700 }}>Conecta tu primera cuenta</h2>
                <p style={{ color: "rgba(255,255,255,0.45)", fontSize: 15, maxWidth: 400, lineHeight: 1.6 }}>
                  Pulsa el bot√≥n para conectar tu cuenta de Instagram (Business o Creator).
                </p>
                <button className="btn-connect" style={{ padding: "14px 28px", fontSize: 16, marginTop: 8 }}
                  onClick={connectInstagram}>+ Conectar cuenta de Instagram</button>
              </div>
            ) : (
              <div>
                {daysUntilExpiry !== null && daysUntilExpiry < 10 && (
                  <div className="token-warning">
                    {"‚ö†Ô∏è Token de @" + acc.username + " expira en " + daysUntilExpiry + " d√≠as"}
                    <button onClick={function() { refreshToken(acc.id); }}
                      style={{ background: "rgba(255,152,0,0.2)", border: "1px solid rgba(255,152,0,0.4)",
                        borderRadius: 8, padding: "4px 14px", color: "#FFB74D", fontSize: 13, fontWeight: 600, cursor: "pointer", fontFamily: "inherit" }}>Renovar</button>
                  </div>
                )}

                {/* Account header */}
                <div style={{ marginBottom: 24, display: "flex", alignItems: "center", justifyContent: "space-between", flexWrap: "wrap", gap: 16 }}>
                  <div style={{ display: "flex", alignItems: "center", gap: 16 }}>
                    {acc.profile_picture_url && <img src={acc.profile_picture_url} style={{ width: 52, height: 52, borderRadius: 16, border: "2px solid rgba(255,255,255,0.1)" }} />}
                    <div>
                      <h1 style={{ fontSize: 26, fontWeight: 800, letterSpacing: "-0.02em" }}>{"@" + acc.username}</h1>
                      <p style={{ color: "rgba(255,255,255,0.4)", fontSize: 14, fontWeight: 500 }}>
                        {(acc.account_type || "") + (acc.name && acc.name !== acc.username ? " ¬∑ " + acc.name : "")}
                      </p>
                    </div>
                  </div>
                  <div style={{ display: "flex", alignItems: "center", gap: 10 }}>
                    <button className="btn-secondary" onClick={fetchAccountData} style={{ fontSize: 13, padding: "8px 14px" }}>üîÑ Actualizar</button>
                    <div className="tabs">
                      {["overview", "media", "audiencia"].map(function(t) {
                        return <button key={t} className={"tab" + (tab === t ? " active" : "")} onClick={function() { setTab(t); }}>{t}</button>;
                      })}
                    </div>
                  </div>
                </div>

                {loadingData && <div style={{ display: "flex", justifyContent: "center", padding: 40 }}><div className="loading-spinner"></div></div>}

                {!loadingData && (
                  <div>
                    {/* Metrics */}
                    <div className="metrics-grid">
                      <MetricCard icon="üë•" label="Seguidores" value={acc.followers_count || 0} color="#DD2A7B" />
                      <MetricCard icon="‚û°Ô∏è" label="Siguiendo" value={acc.follows_count || 0} color="#8134AF" />
                      <MetricCard icon="üì∏" label="Publicaciones" value={acc.media_count || 0} color="#F58529" />
                      <MetricCard icon="‚ù§Ô∏è" label="Likes (√∫lt. posts)" value={mediaStats.totalLikes} color="#FC466B" />
                      <MetricCard icon="üí¨" label="Comentarios" value={mediaStats.totalComments} color="#515BD4" />
                      <MetricCard icon="üìä" label="Eng. Rate" value={engRate} color="#38EF7D" />
                    </div>

                    {/* OVERVIEW */}
                    {tab === "overview" && (
                      <div className="charts-grid">
                        {RC && chartData.length > 0 && (
                          <div className="chart-card full-width">
                            <h3 style={{ marginBottom: 20, fontSize: 16, fontWeight: 700 }}>Alcance y Visualizaciones (diario)</h3>
                            <ResponsiveContainer width="100%" height={280}>
                              <AreaChart data={chartData}>
                                <defs>
                                  <linearGradient id="rG" x1="0" y1="0" x2="0" y2="1">
                                    <stop offset="0%" stopColor="#DD2A7B" stopOpacity={0.3} /><stop offset="100%" stopColor="#DD2A7B" stopOpacity={0} />
                                  </linearGradient>
                                  <linearGradient id="vG" x1="0" y1="0" x2="0" y2="1">
                                    <stop offset="0%" stopColor="#515BD4" stopOpacity={0.3} /><stop offset="100%" stopColor="#515BD4" stopOpacity={0} />
                                  </linearGradient>
                                </defs>
                                <CartesianGrid strokeDasharray="3 3" stroke="rgba(255,255,255,0.05)" />
                                <XAxis dataKey="date" stroke="rgba(255,255,255,0.2)" fontSize={11} tickLine={false} />
                                <YAxis stroke="rgba(255,255,255,0.2)" fontSize={11} tickLine={false}
                                  tickFormatter={function(v) { return v >= 1000 ? (v/1000).toFixed(1) + "k" : v; }} />
                                <Tooltip content={ChartTooltip} />
                                <Area type="monotone" dataKey="reach" stroke="#DD2A7B" strokeWidth={2.5} fill="url(#rG)" name="Alcance" />
                                <Area type="monotone" dataKey="views" stroke="#515BD4" strokeWidth={2} fill="url(#vG)" name="Visualizaciones" />
                              </AreaChart>
                            </ResponsiveContainer>
                          </div>
                        )}

                        {RC && contentDistribution.length > 0 && (
                          <div className="chart-card">
                            <h3 style={{ marginBottom: 20, fontSize: 16, fontWeight: 700 }}>Tipo de contenido</h3>
                            <ResponsiveContainer width="100%" height={240}>
                              <PieChart>
                                <Pie data={contentDistribution} cx="50%" cy="50%" innerRadius={55} outerRadius={90} paddingAngle={4} dataKey="value">
                                  {contentDistribution.map(function(_, i) { return <Cell key={i} fill={PIE_COLORS[i % PIE_COLORS.length]} />; })}
                                </Pie>
                                <Tooltip content={ChartTooltip} />
                              </PieChart>
                            </ResponsiveContainer>
                            <div style={{ display: "flex", justifyContent: "center", gap: 16, marginTop: 8, flexWrap: "wrap" }}>
                              {contentDistribution.map(function(ct, i) {
                                return <div key={ct.name} style={{ display: "flex", alignItems: "center", gap: 6, fontSize: 12 }}>
                                  <span style={{ width: 10, height: 10, borderRadius: 3, background: PIE_COLORS[i % PIE_COLORS.length], display: "inline-block" }}></span>
                                  <span style={{ color: "rgba(255,255,255,0.6)" }}>{ct.name + " (" + ct.value + ")"}</span>
                                </div>;
                              })}
                            </div>
                          </div>
                        )}

                        {/* Top posts */}
                        <div className={"chart-card" + (contentDistribution.length === 0 ? " full-width" : "")}>
                          <h3 style={{ marginBottom: 16, fontSize: 16, fontWeight: 700 }}>Top publicaciones</h3>
                          <div style={{ display: "flex", flexDirection: "column", gap: 10 }}>
                            {Array.isArray(media) && media.length > 0 && media.slice().sort(function(a, b) { return (b.like_count || 0) - (a.like_count || 0); }).slice(0, 6).map(function(m, i) {
                              if (!m) return null;
                              return (
                                <a key={m.id || i} href={m.permalink || "#"} target="_blank" rel="noopener"
                                  style={{ display: "flex", alignItems: "center", gap: 12, padding: "10px 12px", background: "rgba(255,255,255,0.03)", borderRadius: 12 }}>
                                  {(m.media_url || m.thumbnail_url) && (
                                    <img src={m.thumbnail_url || m.media_url} style={{ width: 44, height: 44, borderRadius: 8, objectFit: "cover" }}
                                      onError={function(e) { e.target.style.display = "none"; }} />
                                  )}
                                  <div style={{ flex: 1, minWidth: 0 }}>
                                    <div style={{ fontSize: 13, fontWeight: 600 }}>
                                      {(m.media_type === "VIDEO" ? "üé¨ " : m.media_type === "CAROUSEL_ALBUM" ? "üìë " : "üì∑ ") +
                                        (m.caption ? m.caption.slice(0, 35) + (m.caption.length > 35 ? "..." : "") : "Sin caption")}
                                    </div>
                                    <div style={{ fontSize: 11, color: "rgba(255,255,255,0.4)", marginTop: 2 }}>
                                      {m.timestamp ? new Date(m.timestamp).toLocaleDateString("es-ES") : ""}
                                    </div>
                                  </div>
                                  <div style={{ textAlign: "right", flexShrink: 0 }}>
                                    <div style={{ fontSize: 14, fontWeight: 700, color: "#DD2A7B" }}>{"‚ù§ " + (m.like_count || 0).toLocaleString("es-ES")}</div>
                                    <div style={{ fontSize: 11, color: "rgba(255,255,255,0.4)" }}>{"üí¨ " + (m.comments_count || 0)}</div>
                                  </div>
                                </a>
                              );
                            })}
                            {(!Array.isArray(media) || media.length === 0) && (
                              <p style={{ color: "rgba(255,255,255,0.4)", fontSize: 14, textAlign: "center", padding: 20 }}>No hay publicaciones todav√≠a</p>
                            )}
                          </div>
                        </div>

                        {chartData.length === 0 && (
                          <div className="chart-card full-width" style={{ textAlign: "center", padding: 40 }}>
                            <p style={{ color: "rgba(255,255,255,0.4)", fontSize: 15 }}>
                              üìà Los insights aparecer√°n cuando Instagram tenga datos suficientes.
                            </p>
                          </div>
                        )}
                      </div>
                    )}

                    {/* MEDIA TAB */}
                    {tab === "media" && (
                      <div className="media-grid">
                        {Array.isArray(media) && media.map(function(m) {
                          if (!m) return null;
                          return (
                            <a key={m.id} href={m.permalink || "#"} target="_blank" rel="noopener" className="media-item">
                              {(m.thumbnail_url || m.media_url) && (
                                <img src={m.thumbnail_url || m.media_url} alt=""
                                  style={{ width: "100%", aspectRatio: "1", objectFit: "cover" }}
                                  onError={function(e) { e.target.style.display = "none"; }} />
                              )}
                              <div className="media-info">
                                <div style={{ display: "flex", justifyContent: "space-between", marginBottom: 6 }}>
                                  <span style={{ fontSize: 13, fontWeight: 600 }}>
                                    {m.media_type === "VIDEO" ? "üé¨ Reel" : m.media_type === "CAROUSEL_ALBUM" ? "üìë Carrusel" : "üì∑ Foto"}
                                  </span>
                                  <span style={{ fontSize: 12, color: "rgba(255,255,255,0.4)" }}>
                                    {m.timestamp ? new Date(m.timestamp).toLocaleDateString("es-ES") : ""}
                                  </span>
                                </div>
                                <div style={{ display: "flex", gap: 14, fontSize: 13 }}>
                                  <span style={{ color: "#DD2A7B", fontWeight: 600 }}>{"‚ù§ " + (m.like_count || 0).toLocaleString("es-ES")}</span>
                                  <span style={{ color: "#8134AF", fontWeight: 600 }}>{"üí¨ " + (m.comments_count || 0)}</span>
                                </div>
                                {m.caption && (
                                  <p style={{ fontSize: 12, color: "rgba(255,255,255,0.4)", marginTop: 6, lineHeight: 1.4 }}>
                                    {m.caption.slice(0, 80) + (m.caption.length > 80 ? "..." : "")}
                                  </p>
                                )}
                              </div>
                            </a>
                          );
                        })}
                        {(!Array.isArray(media) || media.length === 0) && (
                          <div style={{ gridColumn: "1 / -1", textAlign: "center", padding: 60, color: "rgba(255,255,255,0.4)" }}>
                            No se encontraron publicaciones
                          </div>
                        )}
                      </div>
                    )}

                    {/* AUDIENCE TAB */}
                    {tab === "audiencia" && (
                      <div className="charts-grid">
                        {demographics && demographics.data && Array.isArray(demographics.data) ? (
                          demographics.data.map(function(metric, idx) {
                            if (!metric) return null;
                            var br = (metric.total_value && metric.total_value.breakdowns && Array.isArray(metric.total_value.breakdowns) &&
                              metric.total_value.breakdowns[0] && Array.isArray(metric.total_value.breakdowns[0].results))
                              ? metric.total_value.breakdowns[0].results : null;
                            return (
                              <div key={idx} className="chart-card">
                                <h3 style={{ marginBottom: 16, fontSize: 16, fontWeight: 700 }}>{metric.title || metric.name || "M√©trica"}</h3>
                                {br ? (
                                  <div style={{ display: "flex", flexDirection: "column", gap: 8 }}>
                                    {br.slice().sort(function(a, b) { return (b.value || 0) - (a.value || 0); }).slice(0, 10).map(function(item, i) {
                                      var maxV = br[0] ? (br[0].value || 1) : 1;
                                      return (
                                        <div key={i}>
                                          <div style={{ display: "flex", justifyContent: "space-between", marginBottom: 4 }}>
                                            <span style={{ fontSize: 13, fontWeight: 500 }}>{Object.values(item.dimension_values || {}).join(" ¬∑ ") || "‚Äî"}</span>
                                            <span style={{ fontSize: 13, fontWeight: 600, color: COLORS[i % COLORS.length] }}>{(item.value || 0).toLocaleString("es-ES")}</span>
                                          </div>
                                          <div style={{ height: 6, borderRadius: 3, background: "rgba(255,255,255,0.06)", overflow: "hidden" }}>
                                            <div style={{ height: "100%", borderRadius: 3, width: ((item.value || 0) / maxV * 100) + "%", background: COLORS[i % COLORS.length] }}></div>
                                          </div>
                                        </div>
                                      );
                                    })}
                                  </div>
                                ) : (
                                  <p style={{ color: "rgba(255,255,255,0.4)", fontSize: 14 }}>Sin datos disponibles</p>
                                )}
                              </div>
                            );
                          })
                        ) : (
                          <div className="chart-card full-width" style={{ textAlign: "center", padding: 50 }}>
                            <p style={{ color: "rgba(255,255,255,0.4)", fontSize: 15, lineHeight: 1.7 }}>
                              üë• Los datos demogr√°ficos requieren al menos <strong style={{ color: "#fff" }}>100 seguidores</strong>.
                            </p>
                          </div>
                        )}
                      </div>
                    )}
                  </div>
                )}
              </div>
            )}
          </div>

          {toast && <div className={"toast " + toast.type}>{toast.msg}</div>}
          {dropdownOpen && <div style={{ position: "fixed", inset: 0, zIndex: 150 }} onClick={function() { setDropdownOpen(false); }}></div>}
        </div>
      );
    }

    // ================================================================
    // Root App ‚Äî manages auth state
    // ================================================================
    function App() {
      var [session, setSession] = useState(null);
      var [authLoading, setAuthLoading] = useState(true);
      var [configLoaded, setConfigLoaded] = useState(false);

      // Load Supabase config and init client
      useEffect(function() {
        fetch("/api/config").then(function(r) { return r.json(); }).then(function(cfg) {
          sb = window.supabase.createClient(cfg.supabaseUrl, cfg.supabaseAnonKey);

          // Check existing session
          sb.auth.getSession().then(function(result) {
            if (result.data.session) setSession(result.data.session);
            setAuthLoading(false);
          });

          // Listen for auth changes
          sb.auth.onAuthStateChange(function(event, sess) {
            setSession(sess);
          });

          setConfigLoaded(true);
        }).catch(function(e) {
          console.error("Config load error:", e);
          setAuthLoading(false);
        });
      }, []);

      var handleLogout = async function() {
        await sb.auth.signOut();
        setSession(null);
      };

      if (authLoading || !configLoaded) {
        return <div style={{ display: "flex", alignItems: "center", justifyContent: "center", minHeight: "100vh" }}>
          <div className="loading-spinner"></div>
        </div>;
      }

      if (!session) {
        return <AuthScreen onAuth={function(sess) { setSession(sess); }} />;
      }

      return <Dashboard session={session} onLogout={handleLogout} />;
    }

    // Mount
    ReactDOM.createRoot(document.getElementById("root")).render(
      React.createElement(ErrorBoundary, null, React.createElement(App))
    );
  </script>
</body>
</html>
