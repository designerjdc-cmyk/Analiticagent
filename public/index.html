<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>InstaMetrics ‚Äî Analytics Pro</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect width='32' height='32' rx='8' fill='url(%23g)'/><defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'><stop stop-color='%23f9ce34'/><stop offset='.5' stop-color='%23ee2a7b'/><stop offset='1' stop-color='%236228d7'/></linearGradient></defs><text x='16' y='22' text-anchor='middle' fill='white' font-size='16' font-weight='800' font-family='system-ui'>M</text></svg>"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet"/>
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script crossorigin src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
<script crossorigin src="https://unpkg.com/recharts@2.5.0/umd/Recharts.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
<style>
:root{
  --bg:#07060b;--s1:#0e0d14;--s2:#13121a;--card:rgba(255,255,255,0.025);--ch:rgba(255,255,255,0.05);
  --bdr:rgba(255,255,255,0.055);--bh:rgba(255,255,255,0.1);
  --t:#f0eef5;--tm:rgba(240,238,245,0.5);--td:rgba(240,238,245,0.25);
  --p1:#e1306c;--p2:#c13584;--p3:#833ab4;--p4:#6228d7;
  --grn:#34d399;--red:#f87171;--org:#fbbf24;--blu:#60a5fa;
  --glow:0 0 20px rgba(225,48,108,.08);--r:14px
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',-apple-system,sans-serif;background:var(--bg);color:var(--t);min-height:100vh;font-size:13px;-webkit-font-smoothing:antialiased}
::-webkit-scrollbar{width:5px;height:5px}::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.06);border-radius:4px}
a{color:inherit;text-decoration:none}button{font-family:inherit;cursor:pointer}

/* SIDEBAR */
.shell{display:flex;min-height:100vh}
.sb{width:230px;padding:20px 14px;display:flex;flex-direction:column;gap:2px;position:fixed;top:0;left:0;bottom:0;z-index:50;overflow-y:auto;transition:transform .3s;
  background:linear-gradient(180deg,#0f0e16 0%,#0c0b12 50%,#0a0914 100%);border-right:1px solid rgba(255,255,255,.04)}
.sb::after{content:'';position:absolute;top:0;right:0;bottom:0;width:1px;background:linear-gradient(180deg,rgba(225,48,108,.15),rgba(131,58,180,.1),transparent)}
.sb-brand{display:flex;align-items:center;gap:11px;padding:6px 10px;margin-bottom:6px}
.sb-logo{width:34px;height:34px;border-radius:10px;background:linear-gradient(135deg,#f9ce34,#ee2a7b 50%,#6228d7);display:flex;align-items:center;justify-content:center;font-weight:900;font-size:15px;color:#fff;flex-shrink:0;box-shadow:0 2px 12px rgba(225,48,108,.25)}
.sb-sep{height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.06),transparent);margin:10px 8px}

/* Account card in sidebar */
.sb-account{margin:0 2px 8px;padding:12px;border-radius:12px;background:rgba(255,255,255,.025);border:1px solid rgba(255,255,255,.04);display:flex;align-items:center;gap:10px;cursor:pointer;transition:all .2s;position:relative}
.sb-account:hover{background:rgba(255,255,255,.04);border-color:rgba(255,255,255,.07)}
.sb-account img{width:32px;height:32px;border-radius:9px;border:1.5px solid rgba(255,255,255,.08)}

.nv{display:flex;align-items:center;gap:10px;padding:9px 12px;border-radius:10px;font-size:12.5px;font-weight:500;color:var(--tm);transition:all .2s;border:none;background:none;width:100%;text-align:left}
.nv:hover{color:var(--t);background:rgba(255,255,255,0.04)}
.nv.on{color:var(--t);background:linear-gradient(135deg,rgba(225,48,108,.1),rgba(131,58,180,.08));font-weight:600;border:1px solid rgba(225,48,108,.12)}
.nv-icon{font-size:15px;width:20px;text-align:center;flex-shrink:0}

/* CONTENT */
.cnt{margin-left:230px;flex:1;padding:28px 32px;max-width:1160px}

/* BUTTONS */
.bp{background:linear-gradient(135deg,var(--p1),var(--p3));border:none;border-radius:11px;padding:9px 20px;color:#fff;font-size:12.5px;font-weight:600;display:inline-flex;align-items:center;gap:7px;transition:all .2s;box-shadow:0 2px 12px rgba(225,48,108,.2)}.bp:hover{opacity:.9;box-shadow:0 4px 20px rgba(225,48,108,.3);transform:translateY(-1px)}
.bo{background:rgba(255,255,255,.03);border:1px solid var(--bdr);border-radius:11px;padding:8px 16px;color:var(--t);font-size:12.5px;font-weight:500;display:inline-flex;align-items:center;gap:6px;transition:all .2s}.bo:hover{border-color:var(--bh);background:rgba(255,255,255,.05)}
.bo.loading{opacity:.6;pointer-events:none}
.bg{background:none;border:none;color:var(--tm);font-size:11.5px;padding:5px 8px;transition:color .15s}.bg:hover{color:var(--t)}

/* KPI GRID */
.kg{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;margin-bottom:22px}
.kpi{background:var(--card);border:1px solid var(--bdr);border-radius:var(--r);padding:18px;transition:all .25s;position:relative;overflow:hidden}
.kpi::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--p1),var(--p3));opacity:0;transition:opacity .25s}
.kpi:hover{background:var(--ch);border-color:var(--bh);transform:translateY(-1px);box-shadow:var(--glow)}.kpi:hover::before{opacity:1}
.kl{font-size:10.5px;color:var(--tm);font-weight:600;text-transform:uppercase;letter-spacing:.06em}
.kv{font-size:22px;font-weight:800;letter-spacing:-.03em;margin-top:5px;background:linear-gradient(135deg,var(--t),rgba(240,238,245,.7));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.ks{font-size:10.5px;margin-top:4px}

/* PANELS */
.pnl{background:var(--card);border:1px solid var(--bdr);border-radius:16px;padding:22px;margin-bottom:14px;transition:border-color .2s}
.pnl:hover{border-color:rgba(255,255,255,.07)}
.pt{font-size:14px;font-weight:700;margin-bottom:16px;letter-spacing:-.01em;display:flex;align-items:center;gap:8px}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:14px}.gf{grid-column:1/-1}

/* DATE PICKER */
.dr{display:flex;align-items:center;gap:5px;flex-wrap:wrap}
.drb{background:rgba(255,255,255,.03);border:1px solid var(--bdr);border-radius:9px;padding:6px 12px;font-size:11px;font-weight:500;color:var(--tm);font-family:inherit;transition:all .2s}.drb:hover{border-color:var(--bh);color:var(--t)}.drb.on{background:linear-gradient(135deg,rgba(225,48,108,.12),rgba(131,58,180,.08));border-color:rgba(225,48,108,.2);color:var(--t)}
.dri{background:rgba(255,255,255,.04);border:1px solid var(--bdr);border-radius:8px;padding:5px 10px;font-size:11px;color:var(--t);font-family:inherit;outline:none}.dri:focus{border-color:var(--p1)}

/* TABLE */
.tbl{width:100%;border-collapse:separate;border-spacing:0;font-size:12.5px}
.tbl th{text-align:left;padding:10px 10px;font-size:10px;font-weight:600;color:var(--tm);text-transform:uppercase;letter-spacing:.06em;border-bottom:1px solid var(--bdr);cursor:pointer;user-select:none;white-space:nowrap;transition:color .15s}.tbl th:hover{color:var(--t)}
.tbl td{padding:10px;border-bottom:1px solid rgba(255,255,255,.025);vertical-align:middle}
.tbl tr{transition:background .15s}.tbl tbody tr:hover td{background:rgba(225,48,108,.02)}
.num{text-align:right;font-variant-numeric:tabular-nums;font-weight:600}

/* BADGES */
.bdg{display:inline-flex;align-items:center;gap:3px;padding:3px 9px;border-radius:7px;font-size:10.5px;font-weight:600}
.bdg-r{background:rgba(139,92,246,.1);color:#a78bfa}.bdg-p{background:rgba(96,165,250,.1);color:#93c5fd}.bdg-c{background:rgba(251,191,36,.1);color:#fcd34d}
.bdg-viral{background:rgba(248,113,113,.1);color:#fca5a5}.bdg-good{background:rgba(52,211,153,.1);color:#86efac}.bdg-normal{background:rgba(255,255,255,.04);color:var(--tm)}.bdg-low{background:rgba(255,255,255,.02);color:var(--td)}

/* FILTER CHIPS */
.fc{display:flex;gap:5px;margin-bottom:14px;flex-wrap:wrap}
.fch{background:rgba(255,255,255,.03);border:1px solid var(--bdr);border-radius:9px;padding:6px 14px;font-size:11px;font-weight:500;color:var(--tm);transition:all .2s;font-family:inherit}.fch:hover{border-color:var(--bh);color:var(--t)}.fch.on{background:linear-gradient(135deg,rgba(225,48,108,.1),rgba(131,58,180,.06));border-color:rgba(225,48,108,.18);color:var(--t)}

/* FORMAT BARS */
.fmr{display:flex;align-items:center;gap:10px;margin-bottom:11px}.fml{width:95px;font-size:11.5px;font-weight:600;flex-shrink:0}.fmbg{flex:1;height:22px;background:rgba(255,255,255,.03);border-radius:6px;overflow:hidden}.fmb{height:100%;border-radius:6px;transition:width .6s ease}.fmv{font-size:12px;font-weight:700;width:55px;text-align:right;flex-shrink:0}

/* HEATMAP */
.hm-cell{border-radius:4px;font-size:8.5px;display:flex;align-items:center;justify-content:center;color:rgba(255,255,255,.6);font-weight:600;min-height:26px;transition:transform .1s}.hm-cell:hover{transform:scale(1.15);z-index:1}

/* INSIGHT CARDS */
.ins-card{border-radius:14px;padding:20px;margin-bottom:12px;transition:transform .2s}.ins-card:hover{transform:translateY(-1px)}
.ins-card h3{font-size:14px;font-weight:700;margin-bottom:8px}.ins-card p{font-size:12.5px;color:var(--tm);line-height:1.65}

/* SCORE RING */
.score-ring{width:38px;height:38px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12.5px;font-weight:800;flex-shrink:0;transition:transform .2s}.score-ring:hover{transform:scale(1.1)}

/* AUTH */
.auth-w{display:flex;align-items:center;justify-content:center;min-height:100vh;padding:20px;background:radial-gradient(ellipse at 50% 0%,rgba(225,48,108,.06),transparent 60%)}
.auth-b{background:var(--s1);border:1px solid var(--bdr);border-radius:24px;padding:44px 36px;width:100%;max-width:400px;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,.4)}
.ai{width:100%;padding:12px 16px;background:rgba(255,255,255,.04);border:1px solid var(--bdr);border-radius:11px;color:var(--t);font-size:14px;font-family:inherit;outline:none;transition:all .2s}.ai:focus{border-color:var(--p1);box-shadow:0 0 0 3px rgba(225,48,108,.08)}.ai::placeholder{color:var(--td)}
.ae{background:rgba(248,113,113,.06);border:1px solid rgba(248,113,113,.15);border-radius:10px;padding:10px 14px;font-size:12px;color:var(--red);text-align:left}

/* DROPDOWNS */
.dd{position:absolute;top:calc(100% + 6px);left:0;right:0;background:#151419;border:1px solid rgba(255,255,255,.06);border-radius:14px;box-shadow:0 16px 48px rgba(0,0,0,.5);z-index:200;overflow:hidden;max-height:240px;overflow-y:auto}
.ddi{padding:10px 14px;display:flex;align-items:center;gap:10px;font-size:12.5px;transition:background .15s;cursor:pointer}.ddi:hover{background:rgba(225,48,108,.06)}

/* TOAST */
.toast{position:fixed;bottom:24px;right:24px;padding:13px 22px;border-radius:12px;font-size:12.5px;font-weight:600;z-index:1000;animation:su .35s ease;backdrop-filter:blur(12px)}.toast.ok{background:rgba(52,211,153,.1);border:1px solid rgba(52,211,153,.18);color:var(--grn)}.toast.err{background:rgba(248,113,113,.1);border:1px solid rgba(248,113,113,.18);color:var(--red)}

/* MISC */
.spin{width:24px;height:24px;border:2.5px solid rgba(255,255,255,.06);border-top-color:var(--p1);border-radius:50%;animation:sp .7s linear infinite}
.empty{color:var(--td);font-size:13px;text-align:center;padding:44px 20px}
.sett-row{display:flex;align-items:center;justify-content:space-between;padding:14px 0;border-bottom:1px solid var(--bdr)}.sett-row:last-child{border:none}
.sett-label{font-size:12.5px;color:var(--tm)}.sett-value{font-size:13px;font-weight:600}
.skel{background:linear-gradient(90deg,rgba(255,255,255,.03) 25%,rgba(255,255,255,.06) 50%,rgba(255,255,255,.03) 75%);background-size:200% 100%;animation:skel 1.5s ease infinite;border-radius:8px}
.pag{display:flex;align-items:center;justify-content:center;gap:6px;margin-top:16px;padding-top:14px;border-top:1px solid var(--bdr)}
.pag button{width:32px;height:32px;border-radius:8px;border:1px solid var(--bdr);background:none;color:var(--tm);font-size:12px;font-weight:600;transition:all .15s;font-family:inherit}
.pag button:hover{border-color:var(--bh);color:var(--t)}.pag button.on{background:linear-gradient(135deg,rgba(225,48,108,.15),rgba(131,58,180,.1));border-color:rgba(225,48,108,.2);color:var(--t)}
.hamburger{display:none;position:fixed;top:14px;left:14px;z-index:60;width:40px;height:40px;border-radius:10px;background:var(--s1);border:1px solid var(--bdr);align-items:center;justify-content:center;font-size:18px;color:var(--t);box-shadow:0 4px 12px rgba(0,0,0,.3)}
.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:45;backdrop-filter:blur(4px)}
@keyframes su{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
@keyframes sp{to{transform:rotate(360deg)}}
@keyframes skel{0%{background-position:200% 0}100%{background-position:-200% 0}}
@media print{.sb,.no-print,.hamburger{display:none!important}.cnt{margin-left:0!important;padding:16px!important;max-width:100%!important}body{background:#fff!important;color:#1a1a1a!important}.pnl,.kpi{border:1px solid #e0e0e0!important;background:#fafafa!important;box-shadow:none!important}.pnl:hover,.kpi:hover{transform:none!important}.kv{background:none!important;-webkit-text-fill-color:#1a1a1a!important;color:#1a1a1a!important}.kl,.pt{color:#333!important}.ins-card{background:#f5f5f5!important;border:1px solid #ddd!important}.ins-card h3{color:#1a1a1a!important}.ins-card p,.sett-label{color:#555!important}.bdg{border:1px solid #ccc!important}.toast,.overlay,.dd{display:none!important}*{-webkit-print-color-adjust:exact!important;print-color-adjust:exact!important}}
@media(max-width:900px){.sb{transform:translateX(-100%)}.sb.open{transform:translateX(0)}.hamburger{display:flex}.overlay.show{display:block}.cnt{margin-left:0;padding:16px;padding-top:60px}.g2{grid-template-columns:1fr}.kg{grid-template-columns:repeat(2,1fr)}}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel" data-type="module">
const{useState,useEffect,useMemo,Component}=React;
class EB extends Component{constructor(p){super(p);this.state={e:null}}static getDerivedStateFromError(e){return{e}}render(){return this.state.e?<div style={{padding:40,textAlign:"center",color:"var(--red)"}}><h2>Algo sali√≥ mal</h2><p style={{color:"var(--tm)",margin:"10px 0"}}>{String(this.state.e.message)}</p><button className="bp" onClick={()=>{this.setState({e:null});location.reload()}}>Recargar</button></div>:this.props.children}}
const RC=typeof Recharts!=="undefined";const{AreaChart,Area,BarChart,Bar,XAxis,YAxis,CartesianGrid,Tooltip,ResponsiveContainer}=RC?Recharts:{};
const C=["#e1306c","#c13584","#f59e0b","#60a5fa","#34d399","#f87171","#a78bfa","#06b6d4"];let sb=null;
async function api(u,o){const s=sb?(await sb.auth.getSession()).data.session:null;const h={...(o?.headers||{})};if(s)h.Authorization="Bearer "+s.access_token;const r=await fetch(u,{...o,headers:h});const t=await r.text();let j;try{j=JSON.parse(t)}catch{throw new Error("Bad response")}if(!r.ok)throw new Error(j.error||"Error "+r.status);return j}
function n(v){return typeof v==="number"?v.toLocaleString("es-ES"):(v||"‚Äî")}
function Tip({active,payload,label}){if(!active||!payload?.length)return null;return<div style={{background:"#16141e",border:"1px solid rgba(225,48,108,.15)",borderRadius:10,padding:"10px 14px",fontSize:11.5,boxShadow:"0 8px 24px rgba(0,0,0,.4)"}}><div style={{color:"var(--tm)",marginBottom:4,fontSize:10}}>{label}</div>{payload.map((p,i)=><div key={i} style={{color:p.color,fontWeight:600}}>{p.name}: {n(p.value)}</div>)}</div>}
function Skel({h=20,w="100%"}){return<div className="skel" style={{height:h,width:w}}/>}

function useAnalytics(posts,fc){return useMemo(()=>{if(!posts?.length)return null;const F=fc||1;
  const m=posts.map(p=>{const l=p.like_count||0,c=p.comments_count||0,r=p.insights?.reach||0,sv=p.insights?.saved||0,sh=p.insights?.shares||0,it=p.insights?.total_interactions||(l+c);return{...p,likes:l,comments:c,reach:r,saves:sv,shares:sh,interactions:it,engRate:it/F}});
  const aR=m.reduce((s,x)=>s+x.reach,0)/m.length||1,aE=m.reduce((s,x)=>s+x.engRate,0)/m.length||.01,aS=m.reduce((s,x)=>s+x.saves,0)/m.length||1,aSh=m.reduce((s,x)=>s+x.shares,0)/m.length||1;
  const scored=m.map(x=>{const sc=Math.round(Math.min(Math.min(x.reach/aR,3)/3*30+Math.min(x.engRate/aE,3)/3*35+Math.min(x.saves/aS,3)/3*20+Math.min(x.shares/aSh,3)/3*15,100));return{...x,score:sc}});
  const labeled=scored.map(p=>{let lb="Normal",lc="bdg-normal";if(p.reach>F*2){lb="üî• Viral";lc="bdg-viral"}else if(p.reach>F){lb="‚ú® Destacado";lc="bdg-good"}else if(p.reach<aR*.5){lb="‚Üì Bajo";lc="bdg-low"}return{...p,label:lb,labelClass:lc}});
  const chrono=[...labeled].sort((a,b)=>new Date(a.timestamp||0)-new Date(b.timestamp||0));
  const engTrend=chrono.map((p,i)=>{const start=Math.max(0,i-4),w=chrono.slice(start,i+1);return{date:p.timestamp?new Date(p.timestamp).toLocaleDateString("es-ES",{day:"2-digit",month:"short"}):"",eng:+(p.engRate*100).toFixed(2),rolling:+(w.reduce((s,x)=>s+x.engRate*100,0)/w.length).toFixed(2)}});
  const r5=engTrend.slice(-5),p5=engTrend.slice(-10,-5);const rA=r5.length?r5.reduce((s,x)=>s+x.eng,0)/r5.length:0;const pA=p5.length?p5.reduce((s,x)=>s+x.eng,0)/p5.length:rA;
  const fatigue=pA>0?((rA-pA)/pA*100):0;const fatSt=fatigue<-15?"critical":fatigue<-5?"warning":"healthy";
  const dn=["Dom","Lun","Mar","Mi√©","Jue","Vie","S√°b"];const hm={};labeled.forEach(p=>{if(!p.timestamp)return;const d=new Date(p.timestamp),k=d.getDay()+"-"+d.getHours();if(!hm[k])hm[k]={t:0,c:0};hm[k].t+=p.engRate*100;hm[k].c++});
  const hmD=[];let hmM=0;for(let d=0;d<7;d++)for(let h=0;h<24;h++){const k=d+"-"+h,a=hm[k]?hm[k].t/hm[k].c:0;if(a>hmM)hmM=a;hmD.push({day:d,hour:h,avg:a,count:hm[k]?.c||0})}
  const cb=[{l:"Sin caption",n:0,x:0,p:[]},{l:"Corto (<50)",n:1,x:50,p:[]},{l:"Medio (50-150)",n:50,x:150,p:[]},{l:"Largo (150-300)",n:150,x:300,p:[]},{l:"Muy largo (300+)",n:300,x:99999,p:[]}];
  labeled.forEach(p=>{const len=(p.caption||"").length;for(const b of cb)if(len>=b.n&&(b.x===0?len===0:len<b.x)){b.p.push(p);break}});
  const capStats=cb.filter(b=>b.p.length>0).map(b=>({label:b.l,count:b.p.length,avgEng:b.p.reduce((s,p)=>s+p.engRate*100,0)/b.p.length}));
  const fm={reel:{l:"Reels",c:"#a78bfa",p:[]},photo:{l:"Fotos",c:"#60a5fa",p:[]},carousel:{l:"Carruseles",c:"#fbbf24",p:[]}};
  labeled.forEach(p=>{if(p.media_type==="VIDEO"||p.media_product_type==="REELS")fm.reel.p.push(p);else if(p.media_type==="IMAGE")fm.photo.p.push(p);else if(p.media_type==="CAROUSEL_ALBUM")fm.carousel.p.push(p)});
  const fmStats=Object.entries(fm).map(([k,v])=>({key:k,label:v.l,color:v.c,count:v.p.length,avgEng:v.p.length?v.p.reduce((s,x)=>s+x.engRate*100,0)/v.p.length:0,avgReach:v.p.length?v.p.reduce((s,x)=>s+x.reach,0)/v.p.length:0}));
  const now=new Date(),cDay=now.getDay(),cHr=now.getHours();const bestFmt=[...fmStats].filter(f=>f.count>0).sort((a,b)=>b.avgEng-a.avgEng)[0];
  const todayH=hmD.filter(h=>h.day===cDay&&h.count>0).sort((a,b)=>b.avg-a.avg);const bestHr=todayH[0];const curSlot=hmD.find(h=>h.day===cDay&&h.hour===cHr);
  const oaE=labeled.reduce((s,p)=>s+p.engRate*100,0)/labeled.length;
  const htMap={};labeled.forEach(p=>{const tags=(p.caption||"").match(/#[\w√°√©√≠√≥√∫√±√º]+/gi)||[];tags.forEach(tag=>{const t=tag.toLowerCase();if(!htMap[t])htMap[t]={count:0,totalEng:0,totalReach:0};htMap[t].count++;htMap[t].totalEng+=p.engRate*100;htMap[t].totalReach+=p.reach})});
  const hashtags=Object.entries(htMap).map(([tag,d])=>({tag,count:d.count,avgEng:d.totalEng/d.count})).sort((a,b)=>b.avgEng-a.avgEng);
  const weekMap={};labeled.forEach(p=>{if(!p.timestamp)return;const d=new Date(p.timestamp),wk=new Date(d);wk.setDate(d.getDate()-d.getDay());const key=wk.toISOString().slice(0,10);if(!weekMap[key])weekMap[key]={posts:0,totalEng:0};weekMap[key].posts++;weekMap[key].totalEng+=p.engRate*100});
  const freqData=Object.entries(weekMap).sort(([a],[b])=>a.localeCompare(b)).map(([wk,d])=>({week:new Date(wk).toLocaleDateString("es-ES",{day:"2-digit",month:"short"}),posts:d.posts,avgEng:+(d.totalEng/d.posts).toFixed(2)}));
  const rateBase=F<1000?10:F<5000?25:F<10000?50:F<50000?150:F<100000?400:F<500000?1500:5000;
  const estimatedRate=Math.round(rateBase*(oaE>5?2:oaE>3?1.5:oaE>1.5?1:0.7));
  return{posts:labeled,engTrend,fatigue,fatSt,hmD,hmM,dn,capStats,fmStats,bestFmt,bestHr,curSlot,cDay,cHr,oaE,aR,
    top5:[...labeled].sort((a,b)=>b.score-a.score).slice(0,5),worst5:[...labeled].sort((a,b)=>a.score-b.score).slice(0,5),
    viralCount:labeled.filter(p=>p.label.includes("Viral")).length,hashtags,freqData,estimatedRate,F};
},[posts,fc])}

function exportCSV(posts,fn){const h=["Fecha","Tipo","Score","Clasif","Likes","Comments","Reach","Saves","Shares","Eng%","Caption"];const rows=posts.map(p=>[p.timestamp?new Date(p.timestamp).toLocaleDateString("es-ES"):"",p.media_type,p.score,p.label,p.likes,p.comments,p.reach,p.saves,p.shares,(p.engRate*100).toFixed(2),'"'+(p.caption||"").replace(/"/g,'""').replace(/\n/g," ").slice(0,200)+'"']);const csv="\uFEFF"+[h,...rows].map(r=>r.join(";")).join("\n");const b=new Blob([csv],{type:"text/csv;charset=utf-8"});const u=URL.createObjectURL(b);const a=document.createElement("a");a.href=u;a.download=fn||"posts.csv";a.click();URL.revokeObjectURL(u)}

// ‚îÄ‚îÄ SMART INSIGHTS ENGINE (zero cost, rule-based) ‚îÄ‚îÄ
function analyzePost(post,A){
  if(!A||!post)return[];const reasons=[];const avgEng=A.oaE;const avgReach=A.aR;
  // Format
  const fmt=post.media_type==="VIDEO"||post.media_product_type==="REELS"?"reel":post.media_type==="CAROUSEL_ALBUM"?"carousel":"photo";
  const fmtS=A.fmStats.find(f=>f.key===fmt);const bestFmt=A.bestFmt;
  if(fmtS&&bestFmt&&fmtS.key===bestFmt.key)reasons.push({icon:"üé¨",text:`Publicado como ${fmtS.label} ‚Äî tu formato con mejor engagement (${fmtS.avgEng.toFixed(2)}%)`});
  else if(fmtS)reasons.push({icon:"üìù",text:`Formato ${fmtS.label} (${fmtS.avgEng.toFixed(2)}% eng medio). Tu mejor formato es ${bestFmt?.label||"?"}`});
  // Time
  if(post.timestamp){const d=new Date(post.timestamp),hr=d.getHours(),day=d.getDay();const slot=A.hmD.find(h=>h.day===day&&h.hour===hr);
    if(slot&&slot.avg>avgEng)reasons.push({icon:"üïê",text:`Publicado a las ${hr}:00 (${A.dn[day]}) ‚Äî una de tus mejores horas (${slot.avg.toFixed(2)}% eng medio)`});
    else if(slot&&slot.count>0)reasons.push({icon:"‚è∞",text:`Publicado a las ${hr}:00 (${A.dn[day]}) ‚Äî hora con ${slot.avg.toFixed(2)}% eng (media: ${avgEng.toFixed(2)}%)`})}
  // Caption length
  const capLen=(post.caption||"").length;const capCat=capLen===0?"Sin caption":capLen<50?"Corto":capLen<150?"Medio":capLen<300?"Largo":"Muy largo";
  const bestCap=A.capStats.length?[...A.capStats].sort((a,b)=>b.avgEng-a.avgEng)[0]:null;
  if(bestCap&&capCat===bestCap.label)reasons.push({icon:"‚úçÔ∏è",text:`Caption ${capCat.toLowerCase()} (${capLen} chars) ‚Äî tu longitud con mejor rendimiento`});
  else reasons.push({icon:"‚úçÔ∏è",text:`Caption ${capCat.toLowerCase()} (${capLen} chars). Mejor rendimiento: "${bestCap?.label||"?"}" (${bestCap?.avgEng.toFixed(2)||0}%)`});
  // Hashtags
  const tags=(post.caption||"").match(/#[\w√°√©√≠√≥√∫√±√º]+/gi)||[];const topTags=A.hashtags.slice(0,5).map(h=>h.tag);
  const matching=tags.filter(t=>topTags.includes(t.toLowerCase()));
  if(matching.length>0)reasons.push({icon:"#Ô∏è‚É£",text:`Usa ${matching.length} de tus top hashtags: ${matching.join(", ")}`});
  else if(tags.length>0)reasons.push({icon:"#Ô∏è‚É£",text:`${tags.length} hashtags, pero ninguno de tus top 5. Prueba: ${topTags.slice(0,3).join(", ")}`});
  // Engagement vs average
  const engPct=post.engRate*100;
  if(engPct>avgEng*2)reasons.push({icon:"üî•",text:`Engagement ${engPct.toFixed(2)}% ‚Äî ${(engPct/avgEng).toFixed(1)}√ó tu media. Contenido excepcional`});
  else if(engPct>avgEng*1.3)reasons.push({icon:"üìà",text:`Engagement ${engPct.toFixed(2)}% ‚Äî por encima de tu media (${avgEng.toFixed(2)}%)`});
  else if(engPct<avgEng*0.5)reasons.push({icon:"üìâ",text:`Engagement ${engPct.toFixed(2)}% ‚Äî muy por debajo de tu media (${avgEng.toFixed(2)}%)`});
  // Saves ratio (quality signal)
  if(post.saves>0&&post.likes>0){const saveRatio=post.saves/post.likes*100;
    if(saveRatio>10)reasons.push({icon:"üíæ",text:`Ratio saves/likes de ${saveRatio.toFixed(1)}% ‚Äî contenido de alto valor (la gente lo guarda)`});
    else if(saveRatio>5)reasons.push({icon:"üíæ",text:`Ratio saves/likes: ${saveRatio.toFixed(1)}%. Buen indicador de contenido √∫til`})}
  // Shares
  if(post.shares>0&&post.reach>0){const shareRate=post.shares/post.reach*100;
    if(shareRate>2)reasons.push({icon:"üîÑ",text:`${shareRate.toFixed(1)}% de personas lo compartieron ‚Äî alta viralidad org√°nica`})}
  return reasons;
}

function generateCalendar(A){
  if(!A)return[];const dn=["Domingo","Lunes","Martes","Mi√©rcoles","Jueves","Viernes","S√°bado"];
  const fmts=A.fmStats.filter(f=>f.count>0).sort((a,b)=>b.avgEng-a.avgEng);
  const days=[];
  for(let d=0;d<7;d++){const dayHours=A.hmD.filter(h=>h.day===d&&h.count>0).sort((a,b)=>b.avg-a.avg);
    if(dayHours.length===0)continue;const bestHr=dayHours[0];
    const fmt=fmts[d%fmts.length]||fmts[0];
    const topTags=A.hashtags.slice(0,3).map(h=>h.tag).join(" ");
    days.push({day:dn[d],dayNum:d,hour:bestHr.hour,eng:bestHr.avg,format:fmt?.label||"Post",color:fmt?.color||C[0],tags:topTags})}
  return days.sort((a,b)=>b.eng-a.eng).slice(0,5);
}

function generateIdeas(A){
  if(!A)return[];const ideas=[];
  const bestFmt=A.bestFmt;const topTags=A.hashtags.slice(0,5);const bestCap=A.capStats.length?[...A.capStats].sort((a,b)=>b.avgEng-a.avgEng)[0]:null;
  if(bestFmt){
    if(bestFmt.key==="reel")ideas.push({icon:"üé¨",title:"Reel con hook fuerte",desc:`Los Reels son tu formato estrella (${bestFmt.avgEng.toFixed(2)}%). Empieza con una pregunta o dato impactante en los primeros 2 segundos.`});
    else if(bestFmt.key==="carousel")ideas.push({icon:"üìë",title:"Carrusel educativo",desc:`Tus carruseles funcionan bien (${bestFmt.avgEng.toFixed(2)}%). Haz uno tipo "5 cosas que..." o "Gu√≠a r√°pida de..." ‚Äî generan muchos saves.`});
    else ideas.push({icon:"üì∑",title:"Foto con storytelling",desc:`Tus fotos funcionan a ${bestFmt.avgEng.toFixed(2)}% eng. Combina buena imagen con caption largo que cuente una historia.`});}
  if(topTags.length>2)ideas.push({icon:"#Ô∏è‚É£",title:"Contenido sobre tu nicho",desc:`Tus hashtags con mejor rendimiento son ${topTags.slice(0,3).map(t=>t.tag).join(", ")}. Crea contenido espec√≠fico sobre estas tem√°ticas.`});
  if(bestCap)ideas.push({icon:"‚úçÔ∏è",title:`Caption ${bestCap.label.toLowerCase()}`,desc:`Tus captions "${bestCap.label}" tienen ${bestCap.avgEng.toFixed(2)}% de engagement. ${bestCap.label.includes("Largo")?"Cuenta historias personales.":bestCap.label.includes("Corto")?"Ve al grano con CTAs directos.":"Equilibra informaci√≥n y personalidad."}`});
  if(A.viralCount>0){const viral=A.posts.filter(p=>p.label.includes("Viral"))[0];if(viral)ideas.push({icon:"üî•",title:"Replica tu viral",desc:`Tu post viral ten√≠a ${viral.reach} reach. Analiza qu√© lo hizo especial y crea contenido similar con un √°ngulo nuevo.`})}
  ideas.push({icon:"üíæ",title:"Contenido guardable",desc:"Posts tipo checklists, tutoriales paso a paso, o datos √∫tiles generan m√°s saves ‚Äî la m√©trica que m√°s valora Instagram para distribuci√≥n."});
  ideas.push({icon:"ü§ù",title:"Post de comunidad",desc:"Haz una pregunta abierta o encuesta en Stories. Los posts que generan comentarios largos reciben m√°s alcance org√°nico."});
  return ideas;
}

// ‚îÄ‚îÄ GURU ENGINE: Advanced growth intelligence ‚îÄ‚îÄ

// Hook Analyzer ‚Äî first line of caption performance
function analyzeHooks(posts){
  if(!posts?.length)return[];
  const hooks=posts.filter(p=>p.caption?.trim()).map(p=>{
    const first=(p.caption||"").split("\n")[0].trim().slice(0,80);
    const type=first.endsWith("?")?  "question":first.endsWith("!")?  "exclamation":first.match(/^\d/)?"number":first.match(/^(c√≥mo|como|qu√©|que|por qu√©|tip|truco|secreto|error|stop|no |esto )/i)?"hook":"statement";
    return{text:first,type,eng:p.engRate*100,score:p.score,reach:p.reach};
  });
  const byType={};hooks.forEach(h=>{if(!byType[h.type])byType[h.type]={count:0,totalEng:0,totalReach:0,examples:[]};byType[h.type].count++;byType[h.type].totalEng+=h.eng;byType[h.type].totalReach+=h.reach;byType[h.type].examples.push(h)});
  const labels={question:"‚ùì Pregunta",exclamation:"‚ùó Exclamaci√≥n",number:"üî¢ Empieza con n√∫mero",hook:"ü™ù Hook/Curiosidad",statement:"üìù Afirmaci√≥n"};
  return Object.entries(byType).map(([type,d])=>({type,label:labels[type]||type,count:d.count,avgEng:d.totalEng/d.count,avgReach:d.totalReach/d.count,best:d.examples.sort((a,b)=>b.eng-a.eng)[0]})).sort((a,b)=>b.avgEng-a.avgEng);
}

// Content Pillars ‚Äî auto-detect topics
function detectPillars(posts){
  if(!posts?.length)return[];
  const stopWords=new Set(["de","la","el","en","y","a","que","los","las","un","una","del","por","con","para","es","se","no","lo","al","mi","su","m√°s","ya","te","tu","me","como","pero","sin","son","muy","hay","le","todo","esta","ser","fue","han","era","dos","nos","he","da","este","sus","sus","si","les","est√°","eso"]);
  const wordMap={};
  posts.forEach(p=>{
    const words=(p.caption||"").toLowerCase().replace(/#[\w√°√©√≠√≥√∫√±√º]+/g,"").replace(/[^a-z√°√©√≠√≥√∫√±√º\s]/g,"").split(/\s+/).filter(w=>w.length>3&&!stopWords.has(w));
    const unique=new Set(words);
    unique.forEach(w=>{if(!wordMap[w])wordMap[w]={count:0,totalEng:0,totalReach:0,posts:[]};wordMap[w].count++;wordMap[w].totalEng+=p.engRate*100;wordMap[w].totalReach+=p.reach;wordMap[w].posts.push(p)});
  });
  return Object.entries(wordMap).filter(([w,d])=>d.count>=2).map(([word,d])=>({word,count:d.count,avgEng:d.totalEng/d.count,avgReach:d.totalReach/d.count})).sort((a,b)=>b.avgEng*b.count-a.avgEng*a.count).slice(0,15);
}

// Ghost Follower ratio
function ghostRatio(posts,fc){
  if(!posts?.length||!fc)return 0;
  const uniqueEngaged=new Set();
  const totalInteractions=posts.reduce((s,p)=>s+(p.interactions||0),0);
  const avgInterPerPost=totalInteractions/posts.length;
  const estimatedActive=Math.min(avgInterPerPost*3,fc);// rough estimate: ~3x interactions = unique engaged
  return Math.round((1-estimatedActive/fc)*100);
}

// Posting Streak
function calcStreak(posts){
  if(!posts?.length)return{current:0,max:0,consistency:0,avgGap:0,lastPost:null};
  const dates=[...new Set(posts.filter(p=>p.timestamp).map(p=>new Date(p.timestamp).toISOString().slice(0,10)))].sort().reverse();
  if(!dates.length)return{current:0,max:0,consistency:0,avgGap:0,lastPost:null};
  const today=new Date().toISOString().slice(0,10);const dayMs=86400000;
  // Current streak (days posting without >3 day gap)
  let current=1;for(let i=0;i<dates.length-1;i++){const diff=(new Date(dates[i])-new Date(dates[i+1]))/dayMs;if(diff<=3)current++;else break}
  // Max streak
  let max=1,run=1;for(let i=0;i<dates.length-1;i++){const diff=(new Date(dates[i])-new Date(dates[i+1]))/dayMs;if(diff<=3){run++;if(run>max)max=run}else run=1}
  // Average gap
  let totalGap=0;for(let i=0;i<dates.length-1;i++)totalGap+=(new Date(dates[i])-new Date(dates[i+1]))/dayMs;
  const avgGap=dates.length>1?totalGap/(dates.length-1):0;
  // Consistency score (0-100): how regular is posting
  const daysSinceLast=(new Date(today)-new Date(dates[0]))/dayMs;
  const consistency=Math.max(0,Math.min(100,Math.round(100-daysSinceLast*5-avgGap*3)));
  return{current,max,consistency,avgGap:+avgGap.toFixed(1),lastPost:dates[0],daysSinceLast:Math.round(daysSinceLast)};
}

// Growth Velocity projection
function projectGrowth(snaps,fc){
  if(!snaps?.length||snaps.length<2)return null;
  const recent=snaps.slice(-14);// last 14 snapshots
  if(recent.length<2)return null;
  const first=recent[0],last=recent[recent.length-1];
  const daysDiff=(new Date(last.snapshot_date)-new Date(first.snapshot_date))/86400000;
  if(daysDiff<1)return null;
  const dailyGrowth=(last.followers_count-first.followers_count)/daysDiff;
  return{daily:+dailyGrowth.toFixed(1),weekly:+(dailyGrowth*7).toFixed(0),monthly:+(dailyGrowth*30).toFixed(0),proj90:Math.round(fc+dailyGrowth*90),proj365:Math.round(fc+dailyGrowth*365)};
}

// Recycle candidates ‚Äî old posts worth reposting
function recycleCandidates(posts){
  if(!posts?.length)return[];
  const now=Date.now();const thirtyDays=30*86400000;
  return posts.filter(p=>p.timestamp&&(now-new Date(p.timestamp).getTime())>thirtyDays).sort((a,b)=>b.score-a.score).slice(0,5).map(p=>({...p,daysAgo:Math.round((now-new Date(p.timestamp).getTime())/86400000)}));
}

// Viral Predictor ‚Äî estimate score before posting
function predictViral(caption,format,hour,day,A){
  if(!A)return null;let score=50;const factors=[];
  // Format bonus
  const fmtKey=format==="reel"?"reel":format==="carousel"?"carousel":"photo";
  const fmtS=A.fmStats.find(f=>f.key===fmtKey);const bestFmt=A.bestFmt;
  if(fmtS&&bestFmt){
    if(fmtS.key===bestFmt.key){score+=15;factors.push({icon:"‚úÖ",text:`${fmtS.label} es tu formato estrella`,impact:"+15"})}
    else{const diff=(fmtS.avgEng-bestFmt.avgEng)/bestFmt.avgEng*100;score+=Math.round(diff/3);factors.push({icon:diff>-20?"üü°":"üî¥",text:`${fmtS.label}: ${diff>0?"+":""}${diff.toFixed(0)}% vs tu mejor formato`,impact:Math.round(diff/3)>0?"+"+Math.round(diff/3):""+Math.round(diff/3)})}
  }
  // Time bonus
  const slot=A.hmD.find(h=>h.day===day&&h.hour===hour);
  if(slot&&slot.count>0){const vs=slot.avg/A.oaE;
    if(vs>1.3){score+=12;factors.push({icon:"‚úÖ",text:`${hour}:00 es una de tus mejores horas (${slot.avg.toFixed(2)}% eng)`,impact:"+12"})}
    else if(vs>0.8){score+=3;factors.push({icon:"üü°",text:`${hour}:00 es hora normal (${slot.avg.toFixed(2)}% eng)`,impact:"+3"})}
    else{score-=8;factors.push({icon:"üî¥",text:`${hour}:00 es hora baja (${slot.avg.toFixed(2)}% eng)`,impact:"-8"})}
  }
  // Caption length
  const capLen=(caption||"").length;const bestCap=A.capStats.length?[...A.capStats].sort((a,b)=>b.avgEng-a.avgEng)[0]:null;
  const capCat=capLen===0?"Sin caption":capLen<50?"Corto (<50)":capLen<150?"Medio (50-150)":capLen<300?"Largo (150-300)":"Muy largo (300+)";
  if(bestCap&&capCat===bestCap.label){score+=10;factors.push({icon:"‚úÖ",text:`Longitud "${capCat}" ‚Äî tu mejor rendimiento`,impact:"+10"})}
  else if(bestCap){const cs=A.capStats.find(c=>c.label===capCat);const diff=cs?(cs.avgEng-bestCap.avgEng)/bestCap.avgEng*100:-20;score+=Math.round(diff/4);factors.push({icon:diff>-15?"üü°":"üî¥",text:`Caption "${capCat}" (√≥ptimo: "${bestCap.label}")`,impact:Math.round(diff/4)>0?"+"+Math.round(diff/4):""+Math.round(diff/4)})}
  // Hashtag match
  const tags=(caption||"").match(/#[\w√°√©√≠√≥√∫√±√º]+/gi)||[];const topTags=A.hashtags.slice(0,8).map(h=>h.tag);
  const matching=tags.filter(t=>topTags.includes(t.toLowerCase()));
  if(matching.length>=3){score+=10;factors.push({icon:"‚úÖ",text:`${matching.length} top hashtags incluidos`,impact:"+10"})}
  else if(matching.length>=1){score+=4;factors.push({icon:"üü°",text:`${matching.length} top hashtag(s). A√±ade m√°s: ${topTags.filter(t=>!matching.map(m=>m.toLowerCase()).includes(t)).slice(0,3).join(", ")}`,impact:"+4"})}
  else if(tags.length>0){score-=3;factors.push({icon:"üî¥",text:`${tags.length} hashtags pero ninguno de tus top performers`,impact:"-3"})}
  else{score-=5;factors.push({icon:"üî¥",text:"Sin hashtags ‚Äî a√±ade 3-5 de tus mejores",impact:"-5"})}
  // Hook analysis
  const firstLine=(caption||"").split("\n")[0]||"";
  if(firstLine.endsWith("?")){score+=5;factors.push({icon:"‚úÖ",text:"Hook con pregunta ‚Äî genera curiosidad",impact:"+5"})}
  else if(firstLine.match(/^\d/)){score+=4;factors.push({icon:"‚úÖ",text:"Empieza con n√∫mero ‚Äî atrae atenci√≥n",impact:"+4"})}
  else if(firstLine.length<10&&caption.length>50){score-=3;factors.push({icon:"üü°",text:"Primera l√≠nea muy corta ‚Äî fortalece el hook",impact:"-3"})}
  // CTA check
  if(caption.match(/(guarda|comparte|comenta|etiqueta|cu√©ntame|dime|opinas|link|bio)/i)){score+=5;factors.push({icon:"‚úÖ",text:"Incluye CTA ‚Äî incentiva interacci√≥n",impact:"+5"})}
  else{factors.push({icon:"üü°",text:"Sin CTA detectado. A√±ade: guarda, comenta, comparte...",impact:"0"})}

  return{score:Math.max(0,Math.min(100,score)),factors};
}

function Auth({onAuth}){const[m,setM]=useState("login"),[e,setE]=useState(""),[p,setP]=useState(""),[err,setErr]=useState(null),[ld,setLd]=useState(false);
  const go=async()=>{setErr(null);if(!e||!p)return setErr("Rellena todos los campos");if(p.length<6)return setErr("M√≠nimo 6 caracteres");setLd(true);try{const r=m==="register"?await sb.auth.signUp({email:e,password:p}):await sb.auth.signInWithPassword({email:e,password:p});if(r.error)throw r.error;if(r.data.user&&!r.data.session){setLd(false);return alert("Revisa tu email para confirmar")}if(r.data.session)onAuth(r.data.session)}catch(x){let msg=x.message;if(msg.includes("Invalid"))msg="Email o contrase√±a incorrectos";if(msg.includes("already"))msg="Este email ya est√° registrado";setErr(msg)}setLd(false)};
  return<div className="auth-w"><div className="auth-b">
    <div className="sb-logo" style={{width:56,height:56,borderRadius:16,fontSize:22,margin:"0 auto 18px"}}>M</div>
    <h1 style={{fontSize:26,fontWeight:900,letterSpacing:"-.04em",marginBottom:2}}>InstaMetrics</h1>
    <p style={{color:"var(--tm)",fontSize:13,marginBottom:28}}>Anal√≠tica profesional para Instagram</p>
    <div style={{display:"flex",flexDirection:"column",gap:10}}>
      <input className="ai" type="email" placeholder="Email" value={e} onChange={x=>setE(x.target.value)} onKeyDown={x=>x.key==="Enter"&&go()}/>
      <input className="ai" type="password" placeholder="Contrase√±a" value={p} onChange={x=>setP(x.target.value)} onKeyDown={x=>x.key==="Enter"&&go()}/>
      {err&&<div className="ae">{err}</div>}
      <button className="bp" style={{width:"100%",justifyContent:"center",padding:13,marginTop:4}} onClick={go} disabled={ld}>{ld?"Cargando...":m==="login"?"Iniciar sesi√≥n":"Crear cuenta"}</button>
      <button className="bg" style={{textAlign:"center"}} onClick={()=>{setM(m==="login"?"register":"login");setErr(null)}}>{m==="login"?"¬øNo tienes cuenta? Reg√≠strate":"¬øYa tienes cuenta? Inicia sesi√≥n"}</button>
    </div></div></div>}

function Badge({type,pt}){if(type==="VIDEO"||pt==="REELS")return<span className="bdg bdg-r">üé¨ Reel</span>;if(type==="CAROUSEL_ALBUM")return<span className="bdg bdg-c">üìë Carrusel</span>;return<span className="bdg bdg-p">üì∑ Foto</span>}
function ScoreRing({score}){const c=score>=80?"var(--grn)":score>=60?"var(--org)":score>=40?"var(--blu)":"var(--red)";return<div className="score-ring" style={{border:"3px solid "+c,color:c}}>{score}</div>}
function getDateRange(r){const now=Math.floor(Date.now()/1000);const d={"all":365,"7d":7,"14d":14,"30d":30,"90d":90};const days=d[r];if(days)return{since:now-days*86400,until:now};return{}}

const PER_PAGE=15;
function Dash({session,onLogout}){
  const[accounts,setAcc]=useState([]),[selId,setSel]=useState(null),[tab,setTab]=useState(()=>sessionStorage.getItem("im_tab")||"overview");
  const[ld,setLd]=useState(true),[toast,setToast]=useState(null),[insights,setIns]=useState(null),[media,setMedia]=useState([]);
  const[detailed,setDet]=useState(null),[demo,setDemo]=useState(null),[snaps,setSnaps]=useState([]);
  const[ldD,setLdD]=useState(false),[ldP,setLdP]=useState(false),[refreshing,setRefreshing]=useState(false);
  const[ddO,setDd]=useState(false),[dr,setDR]=useState("30d"),[cf,setCF]=useState(""),[ct,setCT]=useState("");
  const[sc,setSC]=useState("score"),[sd,setSD]=useState("desc"),[tf,setTF]=useState("all"),[page,setPage]=useState(1);
  const[mobMenu,setMob]=useState(false);
  const[analyzeId,setAnalyzeId]=useState(null);
  const[vpCap,setVpCap]=useState(""),[vpFmt,setVpFmt]=useState("reel"),[vpHr,setVpHr]=useState(new Date().getHours()),[vpDay,setVpDay]=useState(new Date().getDay()),[vpResult,setVpResult]=useState(null);
  const sT=(m,t)=>{setToast({m,t:t||"ok"});setTimeout(()=>setToast(null),3500)};
  const userEmail=session?.user?.email||"";
  const switchTab=t=>{setTab(t);sessionStorage.setItem("im_tab",t);setMob(false)};
  useEffect(()=>{const p=new URLSearchParams(location.search);if(p.get("connected")){sT("@"+p.get("connected")+" conectada ‚úì");history.replaceState({},"","/")}if(p.get("error")){sT(decodeURIComponent(p.get("error")),"err");history.replaceState({},"","/")}loadA()},[]);
  const loadA=async()=>{try{const d=await api("/api/accounts");const a=Array.isArray(d)?d:[];setAcc(a);if(a.length&&!selId)setSel(a[0].id)}catch(e){console.error(e)}setLd(false)};
  useEffect(()=>{if(selId){fetchD();api("/api/accounts/"+selId+"/snapshots").then(setSnaps).catch(()=>setSnaps([]))}},[selId,dr]);
  useEffect(()=>{setDet(null)},[selId]);
  useEffect(()=>{if(["posts","intel","mediakit","report"].includes(tab)&&selId&&!detailed&&!ldP){setLdP(true);api("/api/accounts/"+selId+"/media-detailed?limit=50").then(d=>{setDet(d);setLdP(false)}).catch(()=>setLdP(false))}},[tab,selId]);
  useEffect(()=>{setPage(1)},[tf,sc,sd]);
  const fetchD=async()=>{setLdD(true);const d=dr==="custom"?(cf&&ct?{since:Math.floor(new Date(cf).getTime()/1000),until:Math.floor(new Date(ct).getTime()/1000)}:{}):getDateRange(dr);
    const iq="/api/accounts/"+selId+"/insights?period=day"+(d.since?"&since="+d.since+"&until="+d.until:"");
    const r=await Promise.allSettled([api("/api/accounts/"+selId+"/profile"),api(iq),api("/api/accounts/"+selId+"/media?limit=50")]);
    if(r[1].status==="fulfilled")setIns(r[1].value);else setIns(null);
    if(r[2].status==="fulfilled"){const a=r[2].value?.data||[];setMedia(Array.isArray(a)?a:[])}else setMedia([]);
    if(r[0].status==="fulfilled"&&r[0].value)setAcc(prev=>prev.map(a=>a.id===selId?{...a,...r[0].value,id:a.id}:a));
    try{setDemo(await api("/api/accounts/"+selId+"/demographics"))}catch{setDemo(null)}setLdD(false)};
  const doRefresh=async()=>{setRefreshing(true);await fetchD();setDet(null);setRefreshing(false);sT("Datos actualizados")};
  const connectIG=async()=>{const s=(await sb.auth.getSession()).data.session;if(!s)return sT("Sesi√≥n expirada","err");location.href="/auth/instagram?token="+s.access_token};
  const rmAcc=async id=>{if(!confirm("¬øEliminar esta cuenta?"))return;await api("/api/accounts/"+id,{method:"DELETE"});const u=accounts.filter(a=>a.id!==id);setAcc(u);if(selId===id)setSel(u[0]?.id||null);sT("Cuenta eliminada")};
  const acc=accounts.find(a=>a.id===selId)||null;
  const A=useAnalytics(detailed?.data,detailed?.followers_count||acc?.followers_count);
  const streak=useMemo(()=>A?calcStreak(A.posts):null,[A]);
  const hooks=useMemo(()=>A?analyzeHooks(A.posts):null,[A]);
  const pillars=useMemo(()=>A?detectPillars(A.posts):null,[A]);
  const ghost=useMemo(()=>A?ghostRatio(A.posts,A.F):0,[A]);
  const recycle=useMemo(()=>A?recycleCandidates(A.posts):null,[A]);
  const velocity=useMemo(()=>projectGrowth(snaps,acc?.followers_count||0),[snaps,acc]);
  const chartData=(()=>{if(!insights?.data)return[];const r=insights.data.find(m=>m?.name==="reach"),v=insights.data.find(m=>m?.name==="views");if(!r?.values)return[];return r.values.map((x,i)=>({date:x?.end_time?new Date(x.end_time).toLocaleDateString("es-ES",{day:"2-digit",month:"short"}):"",reach:x?.value||0,views:v?.values?.[i]?.value||0}))})();
  const mS=(()=>{if(!media.length)return{l:0,c:0};let l=0,c=0;media.forEach(m=>{l+=m.like_count||0;c+=m.comments_count||0});return{l,c}})();
  const er=acc?.followers_count&&media.length?((mS.l+mS.c)/Math.max(media.length,1)/acc.followers_count*100).toFixed(2)+"%":"‚Äî";
  const posts=A?.posts||[];
  const filtered=posts.filter(p=>{if(tf==="all")return true;if(tf==="reel")return p.media_type==="VIDEO"||p.media_product_type==="REELS";if(tf==="photo")return p.media_type==="IMAGE";if(tf==="carousel")return p.media_type==="CAROUSEL_ALBUM";return true});
  const sorted=[...filtered].sort((a,b)=>{const key={score:"score",timestamp:"timestamp",engagement:"engRate",likes:"likes",reach:"reach",saves:"saves",shares:"shares"}[sc]||"score";let va=a[key],vb=b[key];if(sc==="timestamp"){va=new Date(a.timestamp||0);vb=new Date(b.timestamp||0)}return sd==="desc"?(vb>va?1:-1):(va>vb?1:-1)});
  const totalPages=Math.ceil(sorted.length/PER_PAGE);const paged=sorted.slice((page-1)*PER_PAGE,page*PER_PAGE);
  const tSrt=c=>{if(sc===c)setSD(sd==="desc"?"asc":"desc");else{setSC(c);setSD("desc")}};const sI=c=>sc===c?(sd==="desc"?" ‚Üì":" ‚Üë"):"";

  const DP=()=><div className="dr no-print">{[["all","Todo"],["7d","7d"],["14d","14d"],["30d","30d"],["90d","90d"],["custom","Fechas"]].map(([v,l])=><button key={v} className={"drb"+(dr===v?" on":"")} onClick={()=>setDR(v)}>{l}</button>)}{dr==="custom"&&<><input type="date" className="dri" value={cf} onChange={e=>setCF(e.target.value)}/><span style={{color:"var(--td)",fontSize:10}}>‚Üí</span><input type="date" className="dri" value={ct} onChange={e=>setCT(e.target.value)}/><button className="bo" style={{padding:"3px 9px",fontSize:10}} onClick={fetchD}>OK</button></>}</div>;

  const navItems=[{id:"overview",i:"üìä",l:"Overview"},{id:"posts",i:"üìã",l:"Posts"},{id:"intel",i:"üß†",l:"Inteligencia"},{id:"audience",i:"üë•",l:"Audiencia"},{id:"mediakit",i:"üíº",l:"Media Kit"},{id:"report",i:"üìÑ",l:"Report"}];

  if(ld)return<div style={{display:"flex",alignItems:"center",justifyContent:"center",minHeight:"100vh"}}><div className="spin"/></div>;

  return<div className="shell">
    <button className="hamburger" onClick={()=>setMob(!mobMenu)}>‚ò∞</button>
    <div className={"overlay"+(mobMenu?" show":"")} onClick={()=>setMob(false)}/>
    <div className={"sb"+(mobMenu?" open":"")}>
      <div className="sb-brand"><div className="sb-logo">M</div><div><div style={{fontWeight:800,fontSize:15,letterSpacing:"-.03em"}}>InstaMetrics</div><div style={{fontSize:9.5,color:"var(--td)",marginTop:1,textTransform:"uppercase",letterSpacing:".08em",fontWeight:600}}>Analytics Pro</div></div></div>

      {/* Account card - TOP */}
      {acc&&<div className="sb-account" onClick={()=>setDd(!ddO)}>
        {acc.profile_picture_url?<img src={acc.profile_picture_url}/>:<div style={{width:32,height:32,borderRadius:9,background:"linear-gradient(135deg,var(--p1),var(--p3))",display:"flex",alignItems:"center",justifyContent:"center",fontSize:13,fontWeight:700}}>@</div>}
        <div style={{flex:1,minWidth:0}}><div style={{fontSize:12,fontWeight:700,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>@{acc.username}</div><div style={{fontSize:10,color:"var(--td)",marginTop:1}}>{n(acc.followers_count)} seg.</div></div>
        <span style={{fontSize:9,color:"var(--td)"}}>‚ñº</span>
        {ddO&&<div className="dd">{accounts.map(a=><div key={a.id} className="ddi" onClick={e=>{e.stopPropagation();setSel(a.id);setDd(false)}}>
          {a.profile_picture_url?<img src={a.profile_picture_url} style={{width:22,height:22,borderRadius:7}}/>:<span style={{width:22,height:22,borderRadius:7,background:"var(--p1)",display:"inline-block"}}/>}
          <span style={{flex:1,fontWeight:selId===a.id?700:400}}>@{a.username}</span>
          {selId===a.id&&<span style={{color:"var(--grn)",fontSize:11}}>‚úì</span>}
        </div>)}</div>}
      </div>}
      <div className="sb-sep"/>

      {navItems.map(t=><button key={t.id} className={"nv"+(tab===t.id?" on":"")} onClick={()=>switchTab(t.id)}><span className="nv-icon">{t.i}</span>{t.l}</button>)}
      <div className="sb-sep"/>
      <button className={"nv"+(tab==="settings"?" on":"")} onClick={()=>switchTab("settings")}><span className="nv-icon">‚öôÔ∏è</span>Ajustes</button>

      <div style={{flex:1}}/>
      <button className="bp" style={{width:"100%",justifyContent:"center",fontSize:11.5,padding:"10px"}} onClick={connectIG}>+ Conectar cuenta</button>
    </div>

    <div className="cnt">{!acc&&tab!=="settings"?<div style={{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",minHeight:"60vh",gap:18,textAlign:"center"}}>
      <div className="sb-logo" style={{width:72,height:72,borderRadius:20,fontSize:30,boxShadow:"0 8px 32px rgba(225,48,108,.3)"}}>M</div>
      <h2 style={{fontSize:24,fontWeight:900,letterSpacing:"-.04em"}}>Bienvenido a InstaMetrics</h2>
      <p style={{color:"var(--tm)",fontSize:13.5,maxWidth:360,lineHeight:1.6}}>Conecta tu cuenta de Instagram profesional para empezar a analizar tu rendimiento con datos reales.</p>
      <button className="bp" style={{padding:"13px 28px",marginTop:8,fontSize:14}} onClick={connectIG}>+ Conectar Instagram</button>
    </div>:<div>

      {/* TOPBAR */}
      {acc&&tab!=="settings"&&<div className="no-print" style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:24,gap:14,flexWrap:"wrap"}}>
        <div><h1 style={{fontSize:20,fontWeight:800,letterSpacing:"-.03em"}}>{navItems.find(x=>x.id===tab)?.i} {navItems.find(x=>x.id===tab)?.l||"Ajustes"}</h1></div>
        <div style={{display:"flex",gap:8,alignItems:"center",flexWrap:"wrap"}}><DP/><button className={"bo"+(refreshing?" loading":"")} onClick={doRefresh} style={{padding:"6px 14px"}}>{refreshing?"‚è≥ Cargando...":"üîÑ Actualizar"}</button></div>
      </div>}

      {ldD&&tab!=="settings"?<div style={{padding:40}}><div className="kg">{[1,2,3,4,5].map(i=><div key={i} className="kpi"><Skel h={12} w="60%"/><Skel h={28} w="50%"/></div>)}</div><Skel h={220} w="100%"/></div>:<div>

      {/* ‚ïê‚ïê‚ïê OVERVIEW ‚ïê‚ïê‚ïê */}
      {tab==="overview"&&acc&&<>
        <div className="kg">
          <div className="kpi"><div className="kl">Seguidores</div><div className="kv">{n(acc.followers_count||0)}</div></div>
          <div className="kpi"><div className="kl">Siguiendo</div><div className="kv">{n(acc.follows_count||0)}</div></div>
          <div className="kpi"><div className="kl">Publicaciones</div><div className="kv">{n(acc.media_count||0)}</div></div>
          <div className="kpi"><div className="kl">Engagement</div><div className="kv">{er}</div><div className="ks" style={{color:parseFloat(er)>3?"var(--grn)":parseFloat(er)>1.5?"var(--org)":"var(--td)"}}>{parseFloat(er)>3?"Excelente":parseFloat(er)>1.5?"Bueno":"Bajo"}</div></div>
          <div className="kpi"><div className="kl">Likes totales</div><div className="kv">{n(mS.l)}</div></div>
          {A&&<div className="kpi"><div className="kl">Virales</div><div className="kv" style={{color:A.viralCount?"var(--red)":"var(--td)"}}>{A.viralCount}</div><div className="ks" style={{color:"var(--td)"}}>reach &gt; 2√ó seguidores</div></div>}
          {A&&<div className="kpi"><div className="kl">üëª Ghost Followers</div><div className="kv" style={{color:ghost>70?"var(--red)":ghost>50?"var(--org)":"var(--grn)"}}>{ghost}%</div><div className="ks" style={{color:"var(--td)"}}>{ghost>70?"Audiencia poco activa":ghost>50?"Normal":"Audiencia muy activa"}</div></div>}
          {streak&&<div className="kpi"><div className="kl">üî• Racha</div><div className="kv">{streak.current}</div><div className="ks" style={{color:streak.daysSinceLast>3?"var(--red)":streak.daysSinceLast>1?"var(--org)":"var(--grn)"}}>{streak.daysSinceLast===0?"Publicaste hoy":streak.daysSinceLast===1?"Ayer":"Hace "+streak.daysSinceLast+" d√≠as"}</div></div>}
          {velocity&&<div className="kpi"><div className="kl">üìà Velocidad</div><div className="kv" style={{color:velocity.daily>0?"var(--grn)":"var(--red)"}}>{velocity.daily>0?"+":""}{velocity.daily}/d√≠a</div><div className="ks" style={{color:"var(--td)"}}>{velocity.monthly>0?"+":""}{velocity.monthly}/mes proyectado</div></div>}
        </div>

        {/* Live indicator + Streak */}
        {A&&<div style={{display:"flex",gap:12,marginBottom:16,flexWrap:"wrap"}}>
          {(()=>{const slot=A.hmD.find(h=>h.day===A.cDay&&h.hour===A.cHr);const isGood=slot&&slot.avg>A.oaE;const isBest=A.hmD.filter(h=>h.day===A.cDay&&h.count>0).sort((a,b)=>b.avg-a.avg)[0];const isBestNow=isBest&&isBest.hour===A.cHr;
            return<div className="ins-card" style={{flex:1,minWidth:200,background:isBestNow?"rgba(52,211,153,.05)":isGood?"rgba(251,191,36,.04)":"rgba(248,113,113,.03)",border:"1px solid "+(isBestNow?"rgba(52,211,153,.12)":isGood?"rgba(251,191,36,.1)":"rgba(248,113,113,.08)"),margin:0}}>
              <div style={{display:"flex",alignItems:"center",gap:10}}>
                <div style={{width:12,height:12,borderRadius:"50%",background:isBestNow?"var(--grn)":isGood?"var(--org)":"var(--red)",boxShadow:isBestNow?"0 0 12px rgba(52,211,153,.5)":isGood?"0 0 12px rgba(251,191,36,.4)":"none",animation:isBestNow?"sp 2s ease infinite":""}}/>
                <h3 style={{fontSize:14,margin:0}}>{isBestNow?"üü¢ ¬°MEJOR MOMENTO! Publica AHORA":isGood?"üü° Buen momento para publicar":"üî¥ Espera ‚Äî no es tu mejor hora"}</h3>
              </div>
              <p style={{marginTop:6}}>{A.dn[A.cDay]} {A.cHr}:00 ‚Äî {slot?slot.avg.toFixed(2)+"% eng hist√≥rico":"sin datos"}{isBest&&!isBestNow?". Mejor hora hoy: "+isBest.hour+":00":""}</p>
            </div>})()}
          {streak&&<div className="ins-card" style={{minWidth:180,background:"rgba(255,255,255,.02)",border:"1px solid var(--bdr)",margin:0}}>
            <h3 style={{fontSize:13,margin:0}}>üî• Consistencia</h3>
            <div style={{display:"flex",alignItems:"center",gap:16,marginTop:8}}>
              <div style={{textAlign:"center"}}><div style={{fontSize:26,fontWeight:900,color:streak.consistency>60?"var(--grn)":streak.consistency>30?"var(--org)":"var(--red)"}}>{streak.consistency}</div><div style={{fontSize:9,color:"var(--td)",marginTop:2}}>SCORE</div></div>
              <div style={{fontSize:11.5,color:"var(--tm)",lineHeight:1.6}}>
                <div>Racha actual: <strong>{streak.current}</strong> ¬∑ M√°xima: <strong>{streak.max}</strong></div>
                <div>Media: cada <strong>{streak.avgGap}</strong> d√≠as</div>
              </div>
            </div>
          </div>}
        </div>}

        <div className="g2">
          {RC&&chartData.length>0&&<div className="pnl gf"><div className="pt">üìà Alcance y visualizaciones</div><ResponsiveContainer width="100%" height={220}><AreaChart data={chartData}><defs><linearGradient id="gR" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stopColor="#e1306c" stopOpacity={.18}/><stop offset="100%" stopColor="#e1306c" stopOpacity={0}/></linearGradient><linearGradient id="gV" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stopColor="#60a5fa" stopOpacity={.18}/><stop offset="100%" stopColor="#60a5fa" stopOpacity={0}/></linearGradient></defs><CartesianGrid strokeDasharray="3 3" stroke="rgba(255,255,255,.03)"/><XAxis dataKey="date" stroke="rgba(255,255,255,.12)" fontSize={10} tickLine={false}/><YAxis stroke="rgba(255,255,255,.12)" fontSize={10} tickLine={false} tickFormatter={v=>v>=1000?(v/1000).toFixed(1)+"k":v}/><Tooltip content={<Tip/>}/><Area type="monotone" dataKey="reach" stroke="#e1306c" strokeWidth={2} fill="url(#gR)" name="Alcance"/><Area type="monotone" dataKey="views" stroke="#60a5fa" strokeWidth={2} fill="url(#gV)" name="Views"/></AreaChart></ResponsiveContainer></div>}
          {RC&&snaps.length>0&&<div className="pnl gf"><div className="pt">üìä Hist√≥rico de seguidores</div>{snaps.length===1?<p style={{fontSize:12.5,color:"var(--tm)",padding:"18px 0"}}>üì∏ Primer snapshot guardado ({n(snaps[0].followers_count)} seg). El gr√°fico aparecer√° ma√±ana con m√°s datos.</p>:<ResponsiveContainer width="100%" height={170}><AreaChart data={snaps.map(s=>({date:new Date(s.snapshot_date).toLocaleDateString("es-ES",{day:"2-digit",month:"short"}),followers:s.followers_count}))}><CartesianGrid strokeDasharray="3 3" stroke="rgba(255,255,255,.03)"/><XAxis dataKey="date" stroke="rgba(255,255,255,.12)" fontSize={10} tickLine={false}/><YAxis stroke="rgba(255,255,255,.12)" fontSize={10} tickLine={false} domain={["dataMin-10","dataMax+10"]}/><Tooltip content={<Tip/>}/><Area type="monotone" dataKey="followers" stroke="var(--grn)" strokeWidth={2} fill="rgba(52,211,153,.06)" name="Seguidores"/></AreaChart></ResponsiveContainer>}<p style={{fontSize:10,color:"var(--td)",marginTop:4}}>Se guarda autom√°ticamente cada vez que usas la app</p></div>}
          {A?<><div className="pnl"><div className="pt">üèÜ Top 5 posts</div>{A.top5.map((p,i)=><div key={p.id||i} style={{display:"flex",alignItems:"center",gap:10,padding:"8px 0",borderBottom:i<4?"1px solid rgba(255,255,255,.03)":"none"}}><ScoreRing score={p.score}/><div style={{flex:1,minWidth:0}}><div style={{fontSize:12.5,fontWeight:600,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{p.caption?p.caption.slice(0,35):"Sin caption"}</div><div style={{fontSize:10.5,color:"var(--td)",marginTop:2}}><Badge type={p.media_type} pt={p.media_product_type}/></div></div><div style={{textAlign:"right"}}><div style={{fontSize:12,fontWeight:700,color:"var(--p1)"}}>‚ù§ {n(p.likes)}</div><div style={{fontSize:10,color:"var(--td)"}}>{n(p.reach)} reach</div></div></div>)}</div>
          <div className="pnl"><div className="pt">üìâ Peor rendimiento</div>{A.worst5.map((p,i)=><div key={p.id||i} style={{display:"flex",alignItems:"center",gap:10,padding:"8px 0",borderBottom:i<4?"1px solid rgba(255,255,255,.03)":"none"}}><ScoreRing score={p.score}/><div style={{flex:1,minWidth:0}}><div style={{fontSize:12.5,fontWeight:600,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{p.caption?p.caption.slice(0,35):"Sin caption"}</div><div style={{fontSize:10.5,color:"var(--td)",marginTop:2}}><Badge type={p.media_type} pt={p.media_product_type}/></div></div><div style={{fontSize:11,color:"var(--td)"}}>{n(p.reach)} reach</div></div>)}</div></>:
          <div className="pnl gf" style={{padding:40,textAlign:"center"}}><p style={{color:"var(--tm)"}}>Entra en la pesta√±a <strong>Posts</strong> para cargar el an√°lisis detallado</p></div>}
        </div>
      </>}

      {/* ‚ïê‚ïê‚ïê POSTS ‚ïê‚ïê‚ïê */}
      {tab==="posts"&&acc&&<>{ldP?<div style={{padding:40}}><Skel h={40} w="100%"/><div style={{height:14}}/><Skel h={300} w="100%"/></div>:!A?<p className="empty">No hay posts disponibles</p>:<>
        <div className="pnl">
          <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:14,flexWrap:"wrap",gap:10}}>
            <div style={{fontSize:13,fontWeight:600,color:"var(--tm)"}}>{filtered.length} publicaciones ¬∑ P√°g {page}/{totalPages||1}</div>
            <button className="bo no-print" style={{fontSize:11}} onClick={()=>exportCSV(sorted,"instametrics-"+acc.username+".csv")}>üì• CSV</button>
          </div>
          <div className="fc">{[["all","Todos"],["reel","üé¨ Reels"],["photo","üì∑ Fotos"],["carousel","üìë Carruseles"]].map(([id,l])=><button key={id} className={"fch"+(tf===id?" on":"")} onClick={()=>setTF(id)}>{l}</button>)}</div>
          {posts.length<10&&<p style={{fontSize:11,color:"var(--org)",marginBottom:10,padding:"8px 12px",background:"rgba(251,191,36,.05)",borderRadius:8,border:"1px solid rgba(251,191,36,.1)"}}>‚ö† Con menos de 10 posts los an√°lisis son orientativos. M√°s datos = m√°s fiabilidad.</p>}
          <div style={{overflowX:"auto"}}><table className="tbl"><thead><tr>
            <th onClick={()=>tSrt("score")}>Score{sI("score")}</th><th>Tipo</th><th>Clasif.</th>
            <th onClick={()=>tSrt("timestamp")}>Fecha{sI("timestamp")}</th><th>Caption</th>
            <th className="num" onClick={()=>tSrt("likes")}>Likes{sI("likes")}</th>
            <th className="num" onClick={()=>tSrt("reach")}>Reach{sI("reach")}</th>
            <th className="num" onClick={()=>tSrt("saves")}>Saves{sI("saves")}</th>
            <th className="num" onClick={()=>tSrt("shares")}>Shares{sI("shares")}</th>
            <th className="num" onClick={()=>tSrt("engagement")}>Eng%{sI("engagement")}</th>
          </tr></thead><tbody>{paged.map((p,i)=><tr key={p.id||i}>
            <td><ScoreRing score={p.score}/></td><td><Badge type={p.media_type} pt={p.media_product_type}/></td>
            <td><span className={"bdg "+p.labelClass}>{p.label}</span></td>
            <td style={{fontSize:11.5,whiteSpace:"nowrap"}}>{p.timestamp?new Date(p.timestamp).toLocaleDateString("es-ES"):"‚Äî"}</td>
            <td style={{maxWidth:140,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",color:"var(--tm)"}}><a href={p.permalink||"#"} target="_blank" rel="noopener" style={{color:"var(--tm)"}}>{p.caption?p.caption.slice(0,40):"‚Äî"}</a></td>
            <td className="num">{n(p.likes)}</td><td className="num">{n(p.reach)}</td><td className="num">{n(p.saves)}</td><td className="num">{n(p.shares)}</td>
            <td className="num" style={{color:p.engRate*100>5?"var(--grn)":p.engRate*100>2?"var(--org)":"var(--tm)",fontWeight:700}}>{(p.engRate*100).toFixed(2)}%</td>
          </tr>)}</tbody></table></div>
          {totalPages>1&&<div className="pag">{Array.from({length:totalPages},(_,i)=><button key={i} className={page===i+1?"on":""} onClick={()=>setPage(i+1)}>{i+1}</button>)}</div>}
        </div>
      </>}</>}

      {/* ‚ïê‚ïê‚ïê INTELIGENCIA ‚ïê‚ïê‚ïê */}
      {tab==="intel"&&acc&&<>{ldP?<div style={{padding:40}}><Skel h={80}/><div style={{height:14}}/><Skel h={80}/><div style={{height:14}}/><Skel h={200}/></div>:!A?<p className="empty">Cargando an√°lisis...</p>:<>
        <div className="ins-card" style={{background:"rgba(225,48,108,.04)",border:"1px solid rgba(225,48,108,.1)"}}><h3>üí° ¬øQu√© publicar ahora?</h3><p>{A.bestFmt?<>Tu formato m√°s efectivo es <strong style={{color:A.bestFmt.color}}>{A.bestFmt.label}</strong> con {A.bestFmt.avgEng.toFixed(2)}% eng. </>:""}{A.bestHr?<>Hoy ({A.dn[A.cDay]}), mejor hora: <strong>{A.bestHr.hour}:00</strong>. </>:""}{A.curSlot&&A.curSlot.avg>A.oaE?<span style={{color:"var(--grn)"}}>üü¢ Ahora ({A.cHr}:00) es buen momento.</span>:<span style={{color:"var(--org)"}}>üü° Espera a las {A.bestHr?A.bestHr.hour+":00":"mejor hora"}.</span>}</p></div>
        <div className="ins-card" style={{background:A.fatSt==="critical"?"rgba(248,113,113,.04)":A.fatSt==="warning"?"rgba(251,191,36,.04)":"rgba(52,211,153,.03)",border:"1px solid "+(A.fatSt==="critical"?"rgba(248,113,113,.12)":A.fatSt==="warning"?"rgba(251,191,36,.12)":"rgba(52,211,153,.1)")}}><h3>{A.fatSt==="critical"?"üö® Fatiga de contenido":A.fatSt==="warning"?"‚ö†Ô∏è Engagement en descenso":"‚úÖ Engagement saludable"}</h3><p>√öltimos 5 posts vs anteriores: <strong style={{color:A.fatigue>=0?"var(--grn)":"var(--red)"}}>{A.fatigue>=0?"+":""}{A.fatigue.toFixed(1)}%</strong>{A.fatSt!=="healthy"&&". Prueba variar formato o tem√°tica."}</p></div>
        <div className="g2">
          <div className="pnl"><div className="pt">üìä Engagement por formato</div>{A.fmStats.filter(f=>f.count>0).map(f=><div key={f.key} className="fmr"><div className="fml" style={{color:f.color}}>{f.label} <span style={{color:"var(--td)",fontWeight:400}}>({f.count})</span></div><div className="fmbg"><div className="fmb" style={{width:Math.max(f.avgEng/Math.max(...A.fmStats.map(x=>x.avgEng),.01)*100,5)+"%",background:f.color+"20"}}/></div><div className="fmv">{f.avgEng.toFixed(2)}%</div></div>)}</div>
          <div className="pnl"><div className="pt">üëÅ Alcance por formato</div>{A.fmStats.filter(f=>f.count>0).map(f=><div key={f.key} className="fmr"><div className="fml" style={{color:f.color}}>{f.label}</div><div className="fmbg"><div className="fmb" style={{width:Math.max(f.avgReach/Math.max(...A.fmStats.map(x=>x.avgReach),1)*100,5)+"%",background:f.color+"20"}}/></div><div className="fmv">{n(Math.round(f.avgReach))}</div></div>)}</div>
          <div className="pnl gf"><div className="pt">üïê Mejor hora para publicar</div><div style={{overflowX:"auto"}}><div style={{display:"grid",gridTemplateColumns:"45px repeat(24,1fr)",gap:2,fontSize:9}}><div/>{Array.from({length:24},(_,h)=><div key={h} style={{textAlign:"center",color:"var(--td)",padding:"2px 0"}}>{h}h</div>)}{A.dn.map((day,d)=><React.Fragment key={d}><div style={{display:"flex",alignItems:"center",color:"var(--tm)",fontWeight:600,fontSize:10.5}}>{day}</div>{Array.from({length:24},(_,h)=>{const c=A.hmD.find(x=>x.day===d&&x.hour===h);const i=c&&A.hmM>0?c.avg/A.hmM:0;return<div key={h} className="hm-cell" style={{background:i>0?`rgba(225,48,108,${.06+i*.6})`:"rgba(255,255,255,.015)"}} title={`${day} ${h}:00 ‚Äî ${c?.count||0} posts`}>{c&&c.count>0?c.avg.toFixed(1):""}</div>})}</React.Fragment>)}</div></div></div>
          <div className="pnl"><div className="pt">#Ô∏è‚É£ Hashtags m√°s efectivos</div>{A.hashtags.length>0?A.hashtags.slice(0,12).map((h,i)=><div key={h.tag} style={{display:"flex",alignItems:"center",gap:8,padding:"5px 0",borderBottom:i<11?"1px solid rgba(255,255,255,.025)":"none"}}><span style={{fontSize:11.5,fontWeight:600,color:C[i%C.length],minWidth:90,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{h.tag}</span><div style={{flex:1}}><div style={{height:4,borderRadius:2,background:"rgba(255,255,255,.03)",overflow:"hidden"}}><div style={{height:"100%",borderRadius:2,width:Math.max(h.avgEng/Math.max(A.hashtags[0]?.avgEng,.01)*100,3)+"%",background:C[i%C.length]}}/></div></div><span style={{fontSize:11.5,fontWeight:700,minWidth:48,textAlign:"right"}}>{h.avgEng.toFixed(2)}%</span><span style={{fontSize:10,color:"var(--td)",minWidth:22,textAlign:"right"}}>{h.count}√ó</span></div>):<p style={{color:"var(--td)",fontSize:12}}>No se encontraron hashtags</p>}</div>
          <div className="pnl"><div className="pt">‚úçÔ∏è Longitud de caption</div>{A.capStats.map((b,i)=><div key={i} style={{marginBottom:11}}><div style={{display:"flex",justifyContent:"space-between",fontSize:11.5,marginBottom:3}}><span style={{fontWeight:600}}>{b.label} ({b.count})</span><span style={{fontWeight:700,color:C[i%C.length]}}>{b.avgEng.toFixed(2)}%</span></div><div style={{height:4,borderRadius:2,background:"rgba(255,255,255,.03)",overflow:"hidden"}}><div style={{height:"100%",borderRadius:2,width:Math.max(b.avgEng/Math.max(...A.capStats.map(x=>x.avgEng),.01)*100,3)+"%",background:C[i%C.length]}}/></div></div>)}</div>
          {RC&&A.freqData.length>2&&<div className="pnl gf"><div className="pt">üìÖ Frecuencia vs engagement</div><ResponsiveContainer width="100%" height={190}><BarChart data={A.freqData}><CartesianGrid strokeDasharray="3 3" stroke="rgba(255,255,255,.03)"/><XAxis dataKey="week" stroke="rgba(255,255,255,.1)" fontSize={10} tickLine={false}/><YAxis yAxisId="l" stroke="rgba(255,255,255,.1)" fontSize={10} tickLine={false}/><YAxis yAxisId="r" orientation="right" stroke="rgba(255,255,255,.1)" fontSize={10} tickLine={false} tickFormatter={v=>v.toFixed(1)+"%"}/><Tooltip content={<Tip/>}/><Bar yAxisId="l" dataKey="posts" fill="rgba(96,165,250,.2)" radius={[4,4,0,0]} name="Posts/semana"/><Bar yAxisId="r" dataKey="avgEng" fill="rgba(225,48,108,.35)" radius={[4,4,0,0]} name="Eng%"/></BarChart></ResponsiveContainer></div>}
          {RC&&A.engTrend.length>3&&<div className="pnl gf"><div className="pt">üìâ Evoluci√≥n del engagement</div><ResponsiveContainer width="100%" height={170}><AreaChart data={A.engTrend}><CartesianGrid strokeDasharray="3 3" stroke="rgba(255,255,255,.03)"/><XAxis dataKey="date" stroke="rgba(255,255,255,.1)" fontSize={10} tickLine={false}/><YAxis stroke="rgba(255,255,255,.1)" fontSize={10} tickLine={false} tickFormatter={v=>v.toFixed(1)+"%"}/><Tooltip content={<Tip/>}/><Area type="monotone" dataKey="rolling" stroke="#e1306c" strokeWidth={2} fill="rgba(225,48,108,.06)" name="Eng% (media 5)"/></AreaChart></ResponsiveContainer></div>}

          {/* ‚îÄ‚îÄ SMART: Why did it work? ‚îÄ‚îÄ */}
          <div className="pnl gf" style={{background:"linear-gradient(135deg,rgba(225,48,108,.03),rgba(131,58,180,.02))",border:"1px solid rgba(225,48,108,.08)"}}>
            <div className="pt">üîç ¬øPor qu√© funcion√≥? ‚Äî An√°lisis de tus mejores posts</div>
            <div style={{display:"flex",gap:8,marginBottom:16,flexWrap:"wrap"}}>{A.top5.map((p,i)=><button key={p.id||i} className={analyzeId===(p.id||i)?"fch on":"fch"} onClick={()=>setAnalyzeId(analyzeId===(p.id||i)?null:(p.id||i))} style={{fontSize:11}}>#{i+1} Score {p.score}</button>)}</div>
            {analyzeId!=null&&(()=>{const post=A.top5.find(p=>(p.id||A.top5.indexOf(p))===analyzeId)||A.top5[0];const reasons=analyzePost(post,A);
              return<div style={{background:"rgba(255,255,255,.02)",borderRadius:12,padding:16}}>
                <div style={{display:"flex",alignItems:"center",gap:10,marginBottom:14,borderBottom:"1px solid rgba(255,255,255,.04)",paddingBottom:12}}>
                  <ScoreRing score={post.score}/><div style={{flex:1}}><div style={{fontSize:13,fontWeight:700}}>{post.caption?post.caption.slice(0,50)+"...":"Sin caption"}</div><div style={{fontSize:11,color:"var(--td)",marginTop:2}}><Badge type={post.media_type} pt={post.media_product_type}/> ¬∑ ‚ù§ {n(post.likes)} ¬∑ üëÅ {n(post.reach)} ¬∑ üíæ {n(post.saves)} ¬∑ üîÑ {n(post.shares)}</div></div></div>
                {reasons.map((r,i)=><div key={i} style={{display:"flex",gap:10,padding:"8px 0",borderBottom:i<reasons.length-1?"1px solid rgba(255,255,255,.025)":"none"}}><span style={{fontSize:16,flexShrink:0}}>{r.icon}</span><span style={{fontSize:12.5,color:"var(--tm)",lineHeight:1.55}}>{r.text}</span></div>)}
              </div>})()}
            {analyzeId==null&&<p style={{fontSize:12,color:"var(--td)"}}>Selecciona un post para ver el an√°lisis detallado de por qu√© funcion√≥.</p>}
          </div>

          {/* ‚îÄ‚îÄ SMART: Content Ideas ‚îÄ‚îÄ */}
          <div className="pnl gf"><div className="pt">üí° Ideas de contenido para ti</div>
            <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(260px,1fr))",gap:10}}>
              {generateIdeas(A).map((idea,i)=><div key={i} style={{background:"rgba(255,255,255,.02)",border:"1px solid rgba(255,255,255,.04)",borderRadius:12,padding:16,transition:"all .2s"}}>
                <div style={{fontSize:15,marginBottom:6}}>{idea.icon}</div>
                <div style={{fontSize:13,fontWeight:700,marginBottom:5}}>{idea.title}</div>
                <p style={{fontSize:11.5,color:"var(--tm)",lineHeight:1.6}}>{idea.desc}</p>
              </div>)}
            </div>
          </div>

          {/* ‚îÄ‚îÄ SMART: Weekly Calendar ‚îÄ‚îÄ */}
          <div className="pnl gf"><div className="pt">üìÖ Tu plan semanal √≥ptimo</div>
            {(()=>{const cal=generateCalendar(A);return cal.length>0?<div style={{display:"grid",gap:8}}>
              {cal.map((d,i)=><div key={i} style={{display:"flex",alignItems:"center",gap:14,padding:"12px 16px",background:"rgba(255,255,255,.02)",border:"1px solid rgba(255,255,255,.04)",borderRadius:11,borderLeft:"3px solid "+d.color}}>
                <div style={{minWidth:80}}><div style={{fontSize:13,fontWeight:700}}>{d.day}</div><div style={{fontSize:11,color:"var(--td)"}}>{d.hour}:00</div></div>
                <div style={{flex:1}}><div style={{fontSize:12.5,fontWeight:600,color:d.color}}>{d.format}</div><div style={{fontSize:10.5,color:"var(--td)",marginTop:2}}>{d.tags}</div></div>
                <div style={{textAlign:"right"}}><div style={{fontSize:12,fontWeight:700}}>{d.eng.toFixed(2)}%</div><div style={{fontSize:10,color:"var(--td)"}}>eng hist√≥rico</div></div>
              </div>)}
              <p style={{fontSize:10.5,color:"var(--td)",marginTop:4}}>Basado en tu mejor hora por d√≠a de la semana, formato m√°s efectivo, y hashtags con mejor rendimiento.</p>
            </div>:<p style={{color:"var(--td)",fontSize:12}}>Necesitas m√°s datos para generar un calendario.</p>})()}
          </div>

          {/* ‚îÄ‚îÄ VIRAL PREDICTOR ‚îÄ‚îÄ */}
          <div className="pnl gf" style={{background:"linear-gradient(135deg,rgba(225,48,108,.04),rgba(131,58,180,.03))",border:"1px solid rgba(225,48,108,.1)"}}>
            <div className="pt">üîÆ Predictor Viral ‚Äî Prueba tu post antes de publicar</div>
            <div style={{display:"flex",gap:12,flexWrap:"wrap",marginBottom:12}}>
              <div style={{flex:"1 1 250px"}}><textarea style={{width:"100%",minHeight:90,padding:12,background:"rgba(255,255,255,.03)",border:"1px solid var(--bdr)",borderRadius:10,color:"var(--t)",fontFamily:"inherit",fontSize:12.5,resize:"vertical",outline:"none"}} placeholder="Pega aqu√≠ tu caption completo con hashtags..." value={vpCap} onChange={e=>setVpCap(e.target.value)}/></div>
              <div style={{display:"flex",flexDirection:"column",gap:8,minWidth:150}}>
                <div style={{display:"flex",gap:5}}>{[["reel","üé¨"],["photo","üì∑"],["carousel","üìë"]].map(([v,i])=><button key={v} className={"fch"+(vpFmt===v?" on":"")} onClick={()=>setVpFmt(v)} style={{fontSize:11}}>{i}</button>)}</div>
                <select style={{padding:8,background:"rgba(255,255,255,.04)",border:"1px solid var(--bdr)",borderRadius:8,color:"var(--t)",fontSize:12,fontFamily:"inherit"}} value={vpHr} onChange={e=>setVpHr(+e.target.value)}>{Array.from({length:24},(_, h)=><option key={h} value={h}>{h}:00</option>)}</select>
                <select style={{padding:8,background:"rgba(255,255,255,.04)",border:"1px solid var(--bdr)",borderRadius:8,color:"var(--t)",fontSize:12,fontFamily:"inherit"}} value={vpDay} onChange={e=>setVpDay(+e.target.value)}>{["Dom","Lun","Mar","Mi√©","Jue","Vie","S√°b"].map((d,i)=><option key={i} value={i}>{d}</option>)}</select>
                <button className="bp" style={{fontSize:12,padding:"9px 0",justifyContent:"center"}} onClick={()=>setVpResult(predictViral(vpCap,vpFmt,vpHr,vpDay,A))}>üîÆ Predecir</button>
              </div>
            </div>
            {vpResult&&<div style={{background:"rgba(255,255,255,.02)",borderRadius:12,padding:18}}>
              <div style={{display:"flex",alignItems:"center",gap:14,marginBottom:14}}>
                <div style={{width:64,height:64,borderRadius:"50%",border:`4px solid ${vpResult.score>=70?"var(--grn)":vpResult.score>=45?"var(--org)":"var(--red)"}`,display:"flex",alignItems:"center",justifyContent:"center",fontSize:22,fontWeight:900,color:vpResult.score>=70?"var(--grn)":vpResult.score>=45?"var(--org)":"var(--red)"}}>{vpResult.score}</div>
                <div><div style={{fontSize:16,fontWeight:800}}>{vpResult.score>=70?"üî• Alto potencial":vpResult.score>=45?"üü° Potencial medio":"üî¥ Potencial bajo"}</div><div style={{fontSize:12,color:"var(--tm)",marginTop:3}}>Basado en tu historial de rendimiento</div></div>
              </div>
              {vpResult.factors.map((f,i)=><div key={i} style={{display:"flex",alignItems:"center",gap:10,padding:"7px 0",borderBottom:i<vpResult.factors.length-1?"1px solid rgba(255,255,255,.025)":"none"}}><span style={{fontSize:14}}>{f.icon}</span><span style={{flex:1,fontSize:12,color:"var(--tm)"}}>{f.text}</span><span style={{fontSize:11.5,fontWeight:700,color:f.impact.startsWith("+")?"var(--grn)":f.impact.startsWith("-")?"var(--red)":"var(--tm)",minWidth:32,textAlign:"right"}}>{f.impact}</span></div>)}
            </div>}
          </div>

          {/* ‚îÄ‚îÄ HOOK ANALYZER ‚îÄ‚îÄ */}
          {hooks&&hooks.length>0&&<div className="pnl gf"><div className="pt">ü™ù An√°lisis de Hooks (primera l√≠nea)</div>
            <p style={{fontSize:11.5,color:"var(--td)",marginBottom:14}}>La primera l√≠nea de tu caption es lo que la gente ve antes de "m√°s". ¬øQu√© tipo de hook funciona mejor para ti?</p>
            <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(200px,1fr))",gap:10}}>
              {hooks.map((h,i)=><div key={h.type} style={{background:"rgba(255,255,255,.02)",border:"1px solid rgba(255,255,255,.04)",borderRadius:11,padding:14,borderLeft:"3px solid "+C[i%C.length]}}>
                <div style={{fontSize:13,fontWeight:700,marginBottom:4}}>{h.label} <span style={{color:"var(--td)",fontWeight:400}}>({h.count})</span></div>
                <div style={{fontSize:20,fontWeight:900,color:C[i%C.length]}}>{h.avgEng.toFixed(2)}%</div>
                <div style={{fontSize:10.5,color:"var(--td)",marginTop:4}}>Mejor: "{h.best?.text?.slice(0,40)}..."</div>
              </div>)}
            </div>
          </div>}

          {/* ‚îÄ‚îÄ CONTENT PILLARS ‚îÄ‚îÄ */}
          {pillars&&pillars.length>0&&<div className="pnl gf"><div className="pt">üß¨ ADN de tu Contenido ‚Äî Pilares tem√°ticos</div>
            <p style={{fontSize:11.5,color:"var(--td)",marginBottom:14}}>Palabras clave que aparecen en tus captions y su rendimiento. Identifica tus tem√°ticas ganadoras.</p>
            <div style={{display:"flex",flexWrap:"wrap",gap:8}}>
              {pillars.map((p,i)=>{const maxEng=pillars[0]?.avgEng||1;const intensity=p.avgEng/maxEng;
                return<div key={p.word} style={{padding:"8px 16px",borderRadius:10,background:`rgba(225,48,108,${.03+intensity*.12})`,border:`1px solid rgba(225,48,108,${.05+intensity*.15})`,display:"flex",alignItems:"center",gap:8,transition:"all .2s"}}>
                  <span style={{fontWeight:700,fontSize:13,color:C[i%C.length]}}>{p.word}</span>
                  <span style={{fontSize:10,color:"var(--tm)"}}>{p.avgEng.toFixed(2)}%</span>
                  <span style={{fontSize:9,color:"var(--td)",background:"rgba(255,255,255,.05)",padding:"1px 5px",borderRadius:4}}>{p.count}√ó</span>
                </div>})}
            </div>
          </div>}

          {/* ‚îÄ‚îÄ RECYCLE SUGGESTIONS ‚îÄ‚îÄ */}
          {recycle&&recycle.length>0&&<div className="pnl gf"><div className="pt">‚ôªÔ∏è Posts para reciclar</div>
            <p style={{fontSize:11.5,color:"var(--td)",marginBottom:14}}>Estos posts funcionaron bien y tienen +30 d√≠as. Podr√≠as republicarlos con un √°ngulo nuevo.</p>
            {recycle.map((p,i)=><div key={p.id||i} style={{display:"flex",alignItems:"center",gap:10,padding:"9px 0",borderBottom:i<recycle.length-1?"1px solid rgba(255,255,255,.03)":"none"}}>
              <ScoreRing score={p.score}/>
              <div style={{flex:1,minWidth:0}}><div style={{fontSize:12.5,fontWeight:600,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{p.caption?p.caption.slice(0,50):"Sin caption"}</div><div style={{fontSize:10.5,color:"var(--td)",marginTop:2}}><Badge type={p.media_type} pt={p.media_product_type}/> ¬∑ hace {p.daysAgo} d√≠as ¬∑ ‚ù§ {n(p.likes)} ¬∑ üëÅ {n(p.reach)}</div></div>
              {p.permalink&&<a href={p.permalink} target="_blank" rel="noopener" style={{fontSize:10.5,color:"var(--p1)",whiteSpace:"nowrap"}}>Ver ‚Üí</a>}
            </div>)}
          </div>}
        </div>
      </>}</>}
      {/* ‚ïê‚ïê‚ïê AUDIENCE ‚ïê‚ïê‚ïê */}
      {tab==="audience"&&acc&&<div className="g2">{demo?.data&&Array.isArray(demo.data)?demo.data.map((m,idx)=>{const labels={"engaged_audience_demographics":"üë• Audiencia comprometida","reached_audience_demographics":"üì° Audiencia alcanzada","follower_demographics":"üéØ Seguidores"};const label=labels[m?.name]||m?.name;const br=m?.total_value?.breakdowns?.[0]?.results;if(!br)return<div key={idx} className="pnl"><div className="pt">{label}</div><p className="empty">Sin datos</p></div>;const s=[...br].sort((a,b)=>(b.value||0)-(a.value||0));const mx=s[0]?.value||1;return<div key={idx} className="pnl"><div className="pt">{label}</div>{s.slice(0,12).map((item,i)=><div key={i} style={{marginBottom:7}}><div style={{display:"flex",justifyContent:"space-between",fontSize:11.5,marginBottom:2}}><span>{Object.values(item.dimension_values||{}).join(" ¬∑ ")}</span><span style={{fontWeight:600,color:C[i%C.length]}}>{n(item.value)}</span></div><div style={{height:4,borderRadius:2,background:"rgba(255,255,255,.03)",overflow:"hidden"}}><div style={{height:"100%",borderRadius:2,width:((item.value||0)/mx*100)+"%",background:C[i%C.length]}}/></div></div>)}</div>}):<div className="pnl gf"><p className="empty">Los datos demogr√°ficos requieren m√≠n. 100 seguidores.</p></div>}</div>}

      {/* ‚ïê‚ïê‚ïê MEDIA KIT ‚ïê‚ïê‚ïê */}
      {tab==="mediakit"&&acc&&<>{ldP&&!A?<div style={{padding:40}}><Skel h={80}/><div style={{height:14}}/><Skel h={200}/></div>:<div>
        <div className="no-print" style={{marginBottom:16,display:"flex",alignItems:"center",gap:10}}><button className="bp" onClick={()=>window.print()}>üñ® Guardar como PDF</button><span style={{fontSize:11.5,color:"var(--td)"}}>Usa "Guardar como PDF" en el di√°logo de impresi√≥n</span></div>
        <div className="pnl" style={{padding:34}}>
          <div style={{textAlign:"center",paddingBottom:26,borderBottom:"1px solid var(--bdr)",marginBottom:30}}>
            <div style={{display:"flex",alignItems:"center",justifyContent:"center",gap:16,marginBottom:12}}>
              {acc.profile_picture_url&&<img src={acc.profile_picture_url} style={{width:76,height:76,borderRadius:22,border:"2.5px solid rgba(225,48,108,.2)",boxShadow:"0 4px 20px rgba(225,48,108,.15)"}}/>}
              <div style={{textAlign:"left"}}><h2 style={{fontSize:28,fontWeight:900,letterSpacing:"-.04em"}}>@{acc.username}</h2><p style={{color:"var(--tm)",fontSize:14}}>{acc.account_type}{acc.name?" ¬∑ "+acc.name:""}</p></div>
            </div>
          </div>
          <div className="kg" style={{marginBottom:28}}>
            <div className="kpi" style={{textAlign:"center"}}><div className="kl">Seguidores</div><div className="kv">{n(acc.followers_count||0)}</div></div>
            <div className="kpi" style={{textAlign:"center"}}><div className="kl">Engagement</div><div className="kv">{er}</div></div>
            <div className="kpi" style={{textAlign:"center"}}><div className="kl">Publicaciones</div><div className="kv">{n(acc.media_count||0)}</div></div>
            {A&&<div className="kpi" style={{textAlign:"center"}}><div className="kl">Reach medio</div><div className="kv">{n(Math.round(A.aR))}</div></div>}
          </div>
          {A&&<>
            <div style={{marginBottom:30,padding:24,background:"linear-gradient(135deg,rgba(52,211,153,.05),rgba(52,211,153,.02))",border:"1px solid rgba(52,211,153,.1)",borderRadius:16}}>
              <div style={{fontSize:13.5,fontWeight:700,color:"var(--grn)",marginBottom:8}}>üí∞ Tarifa estimada por colaboraci√≥n</div>
              <div style={{fontSize:40,fontWeight:900,color:"var(--grn)",letterSpacing:"-.03em"}}>{A.estimatedRate}‚Ç¨ ‚Äî {Math.round(A.estimatedRate*1.5)}‚Ç¨</div>
              <p style={{fontSize:11.5,color:"var(--td)",marginTop:8}}>Estimaci√≥n basada en {n(A.F)} seguidores y {A.oaE.toFixed(2)}% de engagement</p>
            </div>
            <div className="g2" style={{marginBottom:26}}>
              <div><div className="pt">üìä Rendimiento por formato</div>{A.fmStats.filter(f=>f.count>0).map(f=><div key={f.key} style={{fontSize:13,padding:"7px 0",borderBottom:"1px solid rgba(255,255,255,.03)"}}><strong style={{color:f.color}}>{f.label}</strong>: {f.avgEng.toFixed(2)}% eng ¬∑ {n(Math.round(f.avgReach))} reach</div>)}</div>
              <div>{demo?.data?.[2]?.total_value?.breakdowns?.[0]?.results?<><div className="pt">üë• Audiencia principal</div>{[...demo.data[2].total_value.breakdowns[0].results].sort((a,b)=>(b.value||0)-(a.value||0)).slice(0,6).map((item,i)=><div key={i} style={{fontSize:13,padding:"4px 0"}}>{Object.values(item.dimension_values||{}).join(" ¬∑ ")} ‚Äî <strong>{n(item.value)}</strong></div>)}</>:<div style={{color:"var(--td)"}}>Datos de audiencia no disponibles</div>}</div>
            </div>
            {A.hashtags.length>0&&<div style={{marginBottom:26}}><div className="pt">üè∑Ô∏è Tem√°ticas</div><div style={{display:"flex",flexWrap:"wrap",gap:8}}>{A.hashtags.slice(0,8).map(h=><span key={h.tag} style={{fontSize:12.5,padding:"6px 16px",background:"rgba(225,48,108,.06)",borderRadius:9,color:"var(--p1)",fontWeight:600,border:"1px solid rgba(225,48,108,.1)"}}>{h.tag}</span>)}</div></div>}
            <div><div className="pt">üèÜ Top publicaciones</div>{A.top5.map((p,i)=><div key={i} style={{display:"flex",alignItems:"center",gap:12,padding:"10px 0",borderBottom:"1px solid rgba(255,255,255,.03)"}}><ScoreRing score={p.score}/><div style={{flex:1}}><div style={{fontSize:13,fontWeight:600}}>{p.caption?p.caption.slice(0,65):"Sin caption"}</div><div style={{fontSize:11,color:"var(--td)",marginTop:2}}><Badge type={p.media_type} pt={p.media_product_type}/> ¬∑ ‚ù§ {n(p.likes)} ¬∑ üëÅ {n(p.reach)} ¬∑ üíæ {n(p.saves)}</div></div></div>)}</div>
          </>}
        </div>
      </div>}</>}

      {/* ‚ïê‚ïê‚ïê REPORT ‚ïê‚ïê‚ïê */}
      {tab==="report"&&acc&&<>{!A?<>{ldP?<div style={{padding:40}}><Skel h={60}/><div style={{height:14}}/><Skel h={200}/></div>:<div className="pnl" style={{textAlign:"center",padding:40}}><p style={{color:"var(--tm)",marginBottom:12}}>Los datos se cargan al entrar en Posts o Inteligencia.</p><button className="bo" onClick={()=>switchTab("posts")}>Ir a Posts ‚Üí</button></div>}</>:<div>
        <div className="no-print" style={{marginBottom:16}}><button className="bp" onClick={()=>window.print()}>üñ® Imprimir Report</button></div>
        <div className="pnl" style={{padding:30}}>
          <div style={{marginBottom:22,borderBottom:"1px solid var(--bdr)",paddingBottom:18}}>
            <div style={{display:"flex",alignItems:"center",gap:12,marginBottom:6}}><div className="sb-logo" style={{width:28,height:28,borderRadius:7,fontSize:11}}>M</div><span style={{fontSize:18,fontWeight:800,letterSpacing:"-.03em"}}>Report mensual</span></div>
            <div style={{fontSize:13,color:"var(--tm)"}}>@{acc.username} ¬∑ {new Date().toLocaleDateString("es-ES",{day:"numeric",month:"long",year:"numeric"})}</div>
          </div>
          <div className="kg" style={{marginBottom:22}}>
            <div className="kpi"><div className="kl">Seguidores</div><div className="kv">{n(acc.followers_count||0)}</div></div>
            <div className="kpi"><div className="kl">Engagement</div><div className="kv">{er}</div></div>
            <div className="kpi"><div className="kl">Posts</div><div className="kv">{posts.length}</div></div>
            <div className="kpi"><div className="kl">Virales</div><div className="kv" style={{color:A.viralCount?"var(--red)":"var(--td)"}}>{A.viralCount}</div></div>
            <div className="kpi"><div className="kl">Salud</div><div className="kv" style={{color:A.fatSt==="healthy"?"var(--grn)":"var(--red)"}}>{A.fatigue>=0?"+":""}{A.fatigue.toFixed(1)}%</div></div>
          </div>
          <div className="g2" style={{marginBottom:22}}>
            <div><div className="pt">üèÜ Mejores posts</div>{A.top5.map((p,i)=><div key={i} style={{fontSize:12.5,padding:"5px 0"}}>Score <strong>{p.score}</strong> ‚Äî {p.caption?.slice(0,45)||"Sin caption"} ¬∑ ‚ù§ {p.likes} ¬∑ üëÅ {n(p.reach)}</div>)}</div>
            <div><div className="pt">üìä Formatos</div>{A.fmStats.filter(f=>f.count>0).map(f=><div key={f.key} style={{fontSize:12.5,padding:"5px 0"}}><strong style={{color:f.color}}>{f.label}</strong>: {f.count} posts ¬∑ {f.avgEng.toFixed(2)}% ¬∑ {n(Math.round(f.avgReach))} reach</div>)}</div>
          </div>
          {A.hashtags.length>0&&<div style={{marginBottom:18}}><div className="pt">üè∑Ô∏è Top hashtags</div><div style={{display:"flex",flexWrap:"wrap",gap:6}}>{A.hashtags.slice(0,6).map(h=><span key={h.tag} style={{fontSize:12,padding:"4px 12px",background:"rgba(225,48,108,.06)",borderRadius:8,color:"var(--p1)"}}>{h.tag} ({h.avgEng.toFixed(1)}%)</span>)}</div></div>}
          <div><div className="pt">üìù Recomendaciones</div><div style={{fontSize:13,color:"var(--tm)",lineHeight:1.8}}>
            {A.bestFmt&&<p style={{marginBottom:6}}>‚Üí Tu formato m√°s efectivo es <strong style={{color:A.bestFmt.color}}>{A.bestFmt.label}</strong>. Prioriza este tipo de contenido.</p>}
            {A.bestHr&&<p style={{marginBottom:6}}>‚Üí Tu mejor hora hoy ({A.dn[A.cDay]}) es las <strong>{A.bestHr.hour}:00</strong>.</p>}
            {A.capStats.length>1&&<p style={{marginBottom:6}}>‚Üí Captions tipo "<strong>{[...A.capStats].sort((a,b)=>b.avgEng-a.avgEng)[0].label}</strong>" mejor rendimiento ({[...A.capStats].sort((a,b)=>b.avgEng-a.avgEng)[0].avgEng.toFixed(2)}%).</p>}
            {A.fatSt!=="healthy"&&<p style={{marginBottom:6,color:"var(--org)"}}>‚Üí Engagement baj√≥ {Math.abs(A.fatigue).toFixed(1)}%. Var√≠a contenido.</p>}
            {A.hashtags[0]&&<p>‚Üí Hashtag m√°s efectivo: <strong style={{color:"var(--p1)"}}>{A.hashtags[0].tag}</strong> ({A.hashtags[0].avgEng.toFixed(2)}%).</p>}
          </div></div>
        </div>
      </div>}</>}

      {/* ‚ïê‚ïê‚ïê SETTINGS ‚ïê‚ïê‚ïê */}
      {tab==="settings"&&<div style={{maxWidth:620}}>
        <div style={{marginBottom:24}}><h1 style={{fontSize:20,fontWeight:800,letterSpacing:"-.03em"}}>‚öôÔ∏è Ajustes</h1><p style={{fontSize:12.5,color:"var(--tm)",marginTop:3}}>Tu cuenta y configuraci√≥n</p></div>

        <div className="pnl">
          <div className="pt">üë§ Tu cuenta</div>
          <div className="sett-row"><span className="sett-label">Email</span><span className="sett-value">{userEmail}</span></div>
          <div className="sett-row"><span className="sett-label">Plan</span><span className="sett-value" style={{display:"flex",alignItems:"center",gap:8}}>Free <span className="bdg" style={{background:"rgba(225,48,108,.08)",color:"var(--p1)",fontSize:9}}>Upgrade pr√≥ximamente</span></span></div>
          <div className="sett-row"><span className="sett-label">Sesi√≥n</span><button className="bo" style={{fontSize:11,padding:"5px 14px"}} onClick={onLogout}>Cerrar sesi√≥n</button></div>
        </div>

        <div className="pnl">
          <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16}}>
            <div className="pt" style={{margin:0}}>üì± Cuentas conectadas ({accounts.length})</div>
            <button className="bp" style={{fontSize:11,padding:"7px 16px"}} onClick={connectIG}>+ Conectar</button>
          </div>
          {accounts.length===0?<p className="empty">No hay cuentas conectadas todav√≠a.</p>:
            <div>{accounts.map((a,i)=><div key={a.id} style={{display:"flex",alignItems:"center",gap:13,padding:"14px 0",borderBottom:i<accounts.length-1?"1px solid var(--bdr)":"none"}}>
              {a.profile_picture_url?<img src={a.profile_picture_url} style={{width:40,height:40,borderRadius:11,border:"1.5px solid rgba(255,255,255,.06)"}}/>:<div style={{width:40,height:40,borderRadius:11,background:"linear-gradient(135deg,var(--p1),var(--p3))",display:"flex",alignItems:"center",justifyContent:"center",fontSize:15,fontWeight:700}}>@</div>}
              <div style={{flex:1}}>
                <div style={{fontWeight:700,fontSize:13.5}}>@{a.username}</div>
                <div style={{fontSize:11.5,color:"var(--tm)",marginTop:2}}>{a.account_type} ¬∑ {n(a.followers_count)} seguidores ¬∑ {n(a.media_count)} posts</div>
              </div>
              <div style={{display:"flex",gap:8,alignItems:"center"}}>
                {selId===a.id?<span className="bdg bdg-good" style={{padding:"4px 10px"}}>Activa</span>:<button className="bo" style={{fontSize:10.5,padding:"5px 12px"}} onClick={()=>setSel(a.id)}>Seleccionar</button>}
                <button className="bg" onClick={()=>rmAcc(a.id)} style={{color:"var(--red)"}}>Eliminar</button>
              </div>
            </div>)}</div>}
        </div>

        <div className="pnl" style={{background:"rgba(225,48,108,.02)",border:"1px solid rgba(225,48,108,.06)"}}>
          <div className="pt" style={{color:"var(--p1)"}}>‚ú¶ InstaMetrics v5</div>
          <div style={{fontSize:12.5,color:"var(--tm)",lineHeight:1.75}}>
            <p>Anal√≠tica profesional para Instagram con datos de la API oficial.</p>
            <p style={{marginTop:8,fontSize:11.5,color:"var(--td)"}}>Score 1-100 ¬∑ Detecci√≥n viral ¬∑ Hashtags ¬∑ Heatmap ¬∑ Caption analysis ¬∑ Frecuencia √≥ptima ¬∑ Fatiga ¬∑ Media Kit ¬∑ Report ¬∑ CSV export ¬∑ Snapshots hist√≥ricos</p>
          </div>
        </div>
      </div>}

      </div>}</div>}</div>
    {toast&&<div className={"toast "+toast.t}>{toast.m}</div>}
    {ddO&&<div style={{position:"fixed",inset:0,zIndex:49}} onClick={()=>setDd(false)}/>}
  </div>;
}

function App(){const[s,setS]=useState(null),[ld,setLd]=useState(true);
  useEffect(()=>{fetch("/api/config").then(r=>r.json()).then(cfg=>{sb=window.supabase.createClient(cfg.supabaseUrl,cfg.supabaseAnonKey);sb.auth.getSession().then(r=>{if(r.data.session)setS(r.data.session);setLd(false)});sb.auth.onAuthStateChange((_,s)=>setS(s))}).catch(()=>setLd(false))},[]);
  if(ld)return<div style={{display:"flex",alignItems:"center",justifyContent:"center",minHeight:"100vh"}}><div className="spin"/></div>;
  if(!s)return<Auth onAuth={s=>setS(s)}/>;
  return<Dash session={s} onLogout={async()=>{await sb.auth.signOut();setS(null)}}/>;
}
ReactDOM.createRoot(document.getElementById("root")).render(<EB><App/></EB>);
</script>
</body>
</html>
