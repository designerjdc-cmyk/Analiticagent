<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>InstaMetrics ‚Äî Instagram Analytics</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script crossorigin src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
  <script crossorigin src="https://unpkg.com/recharts@2.5.0/umd/Recharts.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'DM Sans', -apple-system, sans-serif;
      background: #0a0a14;
      color: #fff;
      min-height: 100vh;
    }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }
    a { color: inherit; text-decoration: none; }

    .header {
      border-bottom: 1px solid rgba(255,255,255,0.06);
      padding: 16px 28px;
      display: flex; align-items: center; justify-content: space-between;
      backdrop-filter: blur(20px);
      position: sticky; top: 0; z-index: 100;
      background: rgba(10,10,20,0.88);
    }
    .header-brand { display: flex; align-items: center; gap: 12px; }
    .header-logo {
      width: 38px; height: 38px; border-radius: 12px;
      background: linear-gradient(135deg, #F58529, #DD2A7B, #8134AF);
      display: flex; align-items: center; justify-content: center;
      font-weight: 800; font-size: 16px; color: #fff;
    }
    .header-title { font-weight: 700; font-size: 17px; letter-spacing: -0.01em; }
    .header-sub { font-size: 12px; color: rgba(255,255,255,0.4); font-weight: 500; }

    .btn-connect {
      background: linear-gradient(135deg, #DD2A7B, #8134AF);
      border: none; border-radius: 12px; padding: 10px 20px;
      color: #fff; font-size: 14px; font-weight: 600; cursor: pointer;
      font-family: inherit; display: flex; align-items: center; gap: 7px;
      transition: transform 0.2s, box-shadow 0.2s;
      box-shadow: 0 4px 16px rgba(221,42,123,0.3);
    }
    .btn-connect:hover { transform: scale(1.03); box-shadow: 0 6px 24px rgba(221,42,123,0.4); }

    .btn-secondary {
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px; padding: 10px 16px;
      color: #fff; font-size: 14px; font-weight: 600;
      cursor: pointer; font-family: inherit;
      display: flex; align-items: center; gap: 8px;
      transition: all 0.2s;
    }
    .btn-secondary:hover { background: rgba(255,255,255,0.1); }

    .main { padding: 24px 28px; max-width: 1300px; margin: 0 auto; }

    .empty-state {
      display: flex; flex-direction: column; align-items: center;
      justify-content: center; min-height: 70vh; gap: 18px; text-align: center;
    }
    .empty-icon {
      width: 80px; height: 80px; border-radius: 24px;
      background: linear-gradient(135deg, #F58529, #DD2A7B, #8134AF, #515BD4);
      display: flex; align-items: center; justify-content: center; font-size: 36px;
    }

    .card {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 16px; padding: 20px 22px;
      transition: all 0.3s ease;
    }
    .card:hover {
      background: rgba(255,255,255,0.06);
      border-color: rgba(255,255,255,0.12);
    }

    .chart-card {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 18px; padding: 24px;
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
      gap: 14px; margin-bottom: 24px;
    }

    .charts-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    .charts-grid .full-width { grid-column: 1 / -1; }

    .account-selector { position: relative; display: inline-block; }
    .dropdown {
      position: absolute; top: calc(100% + 6px); right: 0;
      background: #1a1a2e; border: 1px solid rgba(255,255,255,0.1);
      border-radius: 14px; overflow: hidden; min-width: 240px;
      box-shadow: 0 16px 48px rgba(0,0,0,0.5); z-index: 200;
    }
    .dropdown-item {
      padding: 12px 16px; display: flex; align-items: center;
      justify-content: space-between; cursor: pointer; transition: background 0.15s;
    }
    .dropdown-item:hover { background: rgba(255,255,255,0.08); }

    .tabs {
      display: flex; gap: 4px; background: rgba(255,255,255,0.04);
      border-radius: 12px; padding: 4px;
    }
    .tab {
      background: transparent; border: none; border-radius: 9px;
      padding: 8px 18px; color: rgba(255,255,255,0.4);
      font-size: 13px; font-weight: 600; cursor: pointer;
      font-family: inherit; text-transform: capitalize; transition: all 0.2s;
    }
    .tab.active { background: rgba(255,255,255,0.1); color: #fff; }

    .media-grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 14px;
    }
    .media-item {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 14px; overflow: hidden; transition: all 0.3s;
    }
    .media-item:hover { border-color: rgba(255,255,255,0.15); transform: translateY(-2px); }
    .media-item img { width: 100%; aspect-ratio: 1; object-fit: cover; }
    .media-info { padding: 12px 14px; }

    .toast {
      position: fixed; bottom: 24px; right: 24px;
      padding: 14px 22px; border-radius: 14px;
      font-size: 14px; font-weight: 600; z-index: 1000;
      animation: slideIn 0.3s ease;
    }
    .toast.success { background: #38EF7D22; border: 1px solid #38EF7D44; color: #38EF7D; }
    .toast.error { background: #FF6B6B22; border: 1px solid #FF6B6B44; color: #FF6B6B; }

    .loading-spinner {
      width: 24px; height: 24px; border: 3px solid rgba(255,255,255,0.1);
      border-top-color: #DD2A7B; border-radius: 50%;
      animation: spin 0.8s linear infinite; margin: 40px auto;
    }

    .token-warning {
      background: rgba(255,152,0,0.1); border: 1px solid rgba(255,152,0,0.3);
      border-radius: 12px; padding: 12px 18px; margin-bottom: 16px;
      font-size: 13px; color: #FFB74D; display: flex; align-items: center; gap: 10px;
    }

    #error-display {
      display: none; color: #FF6B6B; padding: 40px; text-align: center;
      font-family: 'DM Sans', sans-serif; font-size: 15px;
    }

    .debug-panel {
      position: fixed; bottom: 0; left: 0; right: 0; max-height: 50vh;
      background: #111122; border-top: 2px solid #DD2A7B;
      overflow-y: auto; z-index: 9999; font-family: 'Courier New', monospace;
      font-size: 12px; padding: 12px 16px;
    }
    .debug-panel .debug-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 8px; position: sticky; top: 0; background: #111122;
      padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .debug-panel .log-line { padding: 2px 0; border-bottom: 1px solid rgba(255,255,255,0.03); }
    .debug-panel .log-ok { color: #38EF7D; }
    .debug-panel .log-err { color: #FF6B6B; }
    .debug-panel .log-warn { color: #FFB74D; }
    .debug-panel .log-info { color: #8888ff; }

    @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes spin { to { transform: rotate(360deg); } }

    @media (max-width: 768px) {
      .header { padding: 12px 16px; flex-wrap: wrap; gap: 12px; }
      .main { padding: 16px; }
      .charts-grid { grid-template-columns: 1fr; }
      .metrics-grid { grid-template-columns: repeat(2, 1fr); }
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <div id="error-display">
    <div style="font-size: 48px; margin-bottom: 16px;">‚ö†Ô∏è</div>
    <h2 style="margin-bottom: 8px;">Error cargando la aplicaci√≥n</h2>
    <p id="error-msg" style="color: rgba(255,255,255,0.5);"></p>
    <p style="margin-top: 16px; color: rgba(255,255,255,0.3); font-size: 13px;">Abre la consola (F12) para m√°s detalles.</p>
  </div>

  <script type="text/babel" data-type="module">
    if (typeof React === 'undefined' || typeof ReactDOM === 'undefined') {
      throw new Error('React no pudo cargar. Revisa tu conexi√≥n a internet.');
    }

    const { useState, useEffect, useCallback, useRef, Component } = React;

    // ================================================================
    // DEBUG LOG ‚Äî collects logs in memory, shown via Ctrl+D panel
    // ================================================================
    const _debugLogs = [];
    function dlog(level, msg, data) {
      var entry = {
        ts: new Date().toISOString().slice(11, 23),
        level: level,
        msg: msg,
        data: data !== undefined ? data : null,
      };
      _debugLogs.push(entry);
      if (_debugLogs.length > 200) _debugLogs.shift();
      // Also log to real console
      var fn = level === "error" ? console.error : level === "warn" ? console.warn : console.log;
      fn("[IM:" + level + "]", msg, data !== undefined ? data : "");
    }

    // ================================================================
    // ErrorBoundary
    // ================================================================
    class ErrorBoundary extends Component {
      constructor(props) {
        super(props);
        this.state = { hasError: false, error: null };
      }
      static getDerivedStateFromError(error) {
        return { hasError: true, error };
      }
      componentDidCatch(error, info) {
        dlog("error", "REACT RENDER CRASH: " + error.message, info.componentStack);
      }
      render() {
        if (this.state.hasError) {
          return (
            <div style={{ padding: 40, textAlign: "center", color: "#FF6B6B" }}>
              <div style={{ fontSize: 48, marginBottom: 16 }}>üí•</div>
              <h2 style={{ marginBottom: 8 }}>Error de renderizado</h2>
              <p style={{ color: "rgba(255,255,255,0.5)", marginBottom: 8 }}>
                {this.state.error ? String(this.state.error.message) : "Error desconocido"}
              </p>
              <p style={{ color: "rgba(255,255,255,0.3)", fontSize: 13, marginBottom: 16 }}>
                Pulsa Ctrl+D para ver el panel de debug
              </p>
              <button className="btn-connect" style={{ margin: "0 auto" }}
                onClick={() => { this.setState({ hasError: false }); window.location.reload(); }}>
                Recargar
              </button>
            </div>
          );
        }
        return this.props.children;
      }
    }

    // ================================================================
    // Recharts (with fallback)
    // ================================================================
    const RechartAvailable = typeof Recharts !== 'undefined';
    dlog("info", "Recharts available: " + RechartAvailable);

    const LineChart = RechartAvailable ? Recharts.LineChart : function() { return null; };
    const Line = RechartAvailable ? Recharts.Line : function() { return null; };
    const AreaChart = RechartAvailable ? Recharts.AreaChart : function() { return null; };
    const Area = RechartAvailable ? Recharts.Area : function() { return null; };
    const BarChart = RechartAvailable ? Recharts.BarChart : function() { return null; };
    const Bar = RechartAvailable ? Recharts.Bar : function() { return null; };
    const XAxis = RechartAvailable ? Recharts.XAxis : function() { return null; };
    const YAxis = RechartAvailable ? Recharts.YAxis : function() { return null; };
    const CartesianGrid = RechartAvailable ? Recharts.CartesianGrid : function() { return null; };
    const Tooltip = RechartAvailable ? Recharts.Tooltip : function() { return null; };
    const ResponsiveContainer = RechartAvailable ? Recharts.ResponsiveContainer : function(p) { return React.createElement('div', null, p.children); };
    const PieChart = RechartAvailable ? Recharts.PieChart : function() { return null; };
    const Pie = RechartAvailable ? Recharts.Pie : function() { return null; };
    const Cell = RechartAvailable ? Recharts.Cell : function() { return null; };

    const COLORS = ["#DD2A7B", "#8134AF", "#F58529", "#515BD4", "#1DA1F2", "#38EF7D", "#FC466B", "#FFD200"];
    const PIE_COLORS = ["#DD2A7B", "#8134AF", "#F58529", "#515BD4"];

    // API Helper with debug logging
    async function api(path, opts) {
      dlog("info", "API call: " + path);
      try {
        var res = await fetch(path, opts || {});
        var body = await res.text();
        var json;
        try { json = JSON.parse(body); } catch(e) {
          dlog("error", "API non-JSON response from " + path, body.slice(0, 200));
          throw new Error("Non-JSON response from " + path);
        }
        if (!res.ok) {
          dlog("error", "API " + res.status + " from " + path, json);
          throw new Error(json.error || "API Error " + res.status);
        }
        dlog("ok", "API OK: " + path, { keys: Object.keys(json), dataLen: json.data ? json.data.length : "n/a" });
        return json;
      } catch(e) {
        dlog("error", "API exception: " + path + " ‚Äî " + e.message);
        throw e;
      }
    }

    // Chart Tooltip
    function ChartTooltip({ active, payload, label }) {
      if (!active || !payload || !payload.length) return null;
      return React.createElement('div', {
        style: {
          background: "#1a1a2e", border: "1px solid rgba(255,255,255,0.12)",
          borderRadius: 12, padding: "12px 16px", boxShadow: "0 8px 32px rgba(0,0,0,0.4)",
        }
      },
        React.createElement('div', { style: { fontSize: 12, color: "rgba(255,255,255,0.5)", marginBottom: 6 } }, label || ""),
        ...(Array.isArray(payload) ? payload : []).map(function(p, i) {
          var v = typeof p.value === "number" ? p.value.toLocaleString("es-ES") : String(p.value || "");
          return React.createElement('div', {
            key: i,
            style: { fontSize: 13, color: p.color, fontWeight: 600, marginBottom: 2 }
          }, (p.name || "") + ": " + v);
        })
      );
    }

    // Metric Card
    function MetricCard({ icon, label, value, change, color }) {
      var isPositive = change >= 0;
      return (
        <div className="card" style={{ display: "flex", flexDirection: "column", gap: 10, cursor: "default" }}>
          <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between" }}>
            <div style={{
              width: 36, height: 36, borderRadius: 10,
              background: (color || "#888") + "20", display: "flex", alignItems: "center", justifyContent: "center",
              fontSize: 18,
            }}>{icon}</div>
            {change !== undefined && change !== null && (
              <div style={{
                display: "flex", alignItems: "center", gap: 3, fontSize: 13, fontWeight: 600,
                color: isPositive ? "#38EF7D" : "#FF6B6B",
              }}>
                {isPositive ? "‚Üë" : "‚Üì"} {isPositive ? "+" : ""}{typeof change === "number" ? change.toFixed(1) : change}%
              </div>
            )}
          </div>
          <div>
            <div style={{ fontSize: 26, fontWeight: 700, letterSpacing: "-0.02em" }}>
              {typeof value === "number" ? value.toLocaleString("es-ES") : (value || "‚Äî")}
            </div>
            <div style={{ fontSize: 13, color: "rgba(255,255,255,0.45)", marginTop: 2, fontWeight: 500 }}>{label}</div>
          </div>
        </div>
      );
    }

    // ================================================================
    // Debug Panel (toggle with Ctrl+D)
    // ================================================================
    function DebugPanel({ visible, onClose, accounts, selectedId, insights, media, demographics }) {
      var [debugReport, setDebugReport] = useState(null);
      var [loadingDebug, setLoadingDebug] = useState(false);

      var runFullDebug = async function() {
        if (!selectedId) return;
        setLoadingDebug(true);
        try {
          var r = await fetch("/api/debug/" + selectedId);
          var data = await r.json();
          setDebugReport(data);
          dlog("ok", "Debug report loaded", data.summary);
        } catch(e) {
          dlog("error", "Debug report failed: " + e.message);
        }
        setLoadingDebug(false);
      };

      if (!visible) return null;
      return (
        <div className="debug-panel">
          <div className="debug-header">
            <span style={{ color: "#DD2A7B", fontWeight: "bold", fontSize: 14 }}>
              üêõ DEBUG PANEL ‚Äî Ctrl+D para cerrar
            </span>
            <div style={{ display: "flex", gap: 8 }}>
              <button onClick={runFullDebug}
                style={{ background: "#DD2A7B", border: "none", color: "#fff", borderRadius: 6, padding: "4px 12px", cursor: "pointer", fontSize: 12 }}>
                {loadingDebug ? "Testing..." : "üß™ Run API Tests"}
              </button>
              <button onClick={onClose}
                style={{ background: "rgba(255,255,255,0.1)", border: "none", color: "#fff", borderRadius: 6, padding: "4px 12px", cursor: "pointer", fontSize: 12 }}>
                ‚úï Cerrar
              </button>
            </div>
          </div>

          {/* State snapshot */}
          <div style={{ marginBottom: 8 }}>
            <div className="log-line log-info"><strong>STATE SNAPSHOT:</strong></div>
            <div className="log-line">accounts.length = {accounts ? accounts.length : "null"}</div>
            <div className="log-line">selectedId = {JSON.stringify(selectedId)} (type: {typeof selectedId})</div>
            <div className="log-line">
              acc found = {accounts && accounts.find(function(a) { return a.id === selectedId; }) ? "YES ‚úì" : "NO ‚úó ‚Äî THIS IS THE CRASH"}
            </div>
            {accounts && accounts.length > 0 && (
              <div className="log-line">
                account IDs: {accounts.map(function(a) { return JSON.stringify(a.id) + " (" + typeof a.id + ")"; }).join(", ")}
              </div>
            )}
            <div className="log-line">insights = {insights ? "loaded (" + (insights.data ? insights.data.length + " metrics" : "no .data") + ")" : "null"}</div>
            <div className="log-line">media = {Array.isArray(media) ? media.length + " items" : "not array"}</div>
            <div className="log-line">demographics = {demographics ? "loaded" : "null"}</div>
          </div>

          {/* API Test results */}
          {debugReport && (
            <div style={{ marginBottom: 8, padding: 8, background: "rgba(255,255,255,0.03)", borderRadius: 8 }}>
              <div className="log-line log-info"><strong>API TEST RESULTS ({debugReport.summary.passed}/{debugReport.summary.total} passed):</strong></div>
              <div className="log-line">Graph base: {debugReport.graph_base}</div>
              <div className="log-line">Stored ID: {debugReport.stored_id} (type: {debugReport.stored_id_type})</div>
              {debugReport.stored_account && (
                <div className="log-line">Token valid: {debugReport.stored_account.token_valid ? "YES" : "NO"} | Expires in: {debugReport.stored_account.days_until_expiry} days</div>
              )}
              {Object.entries(debugReport.tests).map(function(entry) {
                var name = entry[0], test = entry[1];
                var cls = test.status === "OK" ? "log-ok" : "log-err";
                return (
                  <div key={name} className={"log-line " + cls}>
                    {test.status === "OK" ? "‚úì" : "‚úó"} {name}: {test.status}
                    {test.error ? " ‚Äî " + (typeof test.error === "string" ? test.error : JSON.stringify(test.error)) : ""}
                    {test.count !== undefined ? " (" + test.count + " items)" : ""}
                    {test.response_id !== undefined ? " | resp.id=" + JSON.stringify(test.response_id) + " resp.user_id=" + JSON.stringify(test.response_user_id) : ""}
                  </div>
                );
              })}
            </div>
          )}

          {/* Log entries */}
          <div className="log-line log-info" style={{ marginTop: 4 }}><strong>EVENT LOG ({_debugLogs.length} entries):</strong></div>
          {_debugLogs.slice(-50).map(function(entry, i) {
            var cls = entry.level === "error" ? "log-err" : entry.level === "warn" ? "log-warn" : entry.level === "ok" ? "log-ok" : "log-info";
            return (
              <div key={i} className={"log-line " + cls}>
                [{entry.ts}] {entry.msg}
                {entry.data ? " ‚Üí " + (typeof entry.data === "string" ? entry.data.slice(0, 120) : JSON.stringify(entry.data).slice(0, 120)) : ""}
              </div>
            );
          })}
        </div>
      );
    }

    // ================================================================
    // Main App
    // ================================================================
    function App() {
      var [accounts, setAccounts] = useState([]);
      var [selectedId, setSelectedId] = useState(null);
      var [dropdownOpen, setDropdownOpen] = useState(false);
      var [tab, setTab] = useState("overview");
      var [loading, setLoading] = useState(true);
      var [toast, setToast] = useState(null);
      var [insights, setInsights] = useState(null);
      var [media, setMedia] = useState([]);
      var [demographics, setDemographics] = useState(null);
      var [loadingData, setLoadingData] = useState(false);
      var [showDebug, setShowDebug] = useState(false);

      // Ctrl+D toggles debug panel
      useEffect(function() {
        var handler = function(e) {
          if (e.ctrlKey && e.key === "d") {
            e.preventDefault();
            setShowDebug(function(v) { return !v; });
          }
        };
        window.addEventListener("keydown", handler);
        return function() { window.removeEventListener("keydown", handler); };
      }, []);

      var showToast = function(msg, type) {
        setToast({ msg: msg, type: type || "success" });
        setTimeout(function() { setToast(null); }, 4000);
      };

      useEffect(function() {
        var params = new URLSearchParams(window.location.search);
        if (params.get("connected")) {
          showToast("@" + params.get("connected") + " conectada correctamente ‚úì");
          window.history.replaceState({}, "", "/");
        }
        if (params.get("error")) {
          showToast(params.get("error"), "error");
          window.history.replaceState({}, "", "/");
        }
        // Auto-show debug on ?debug param
        if (params.get("debug") !== null) {
          setShowDebug(true);
        }
        loadAccountsList();
      }, []);

      var loadAccountsList = async function() {
        dlog("info", "Loading accounts list...");
        try {
          var data = await api("/api/accounts");
          var arr = Array.isArray(data) ? data : [];
          dlog("ok", "Accounts loaded: " + arr.length, arr.map(function(a) { return { id: a.id, idType: typeof a.id, user: a.username }; }));
          setAccounts(arr);
          if (arr.length > 0 && !selectedId) {
            dlog("info", "Auto-selecting first account: " + JSON.stringify(arr[0].id) + " (type: " + typeof arr[0].id + ")");
            setSelectedId(arr[0].id);
          }
        } catch (e) {
          dlog("error", "loadAccountsList failed: " + e.message);
          setAccounts([]);
        }
        setLoading(false);
      };

      useEffect(function() {
        if (!selectedId) return;
        dlog("info", "selectedId changed ‚Üí fetching data for " + JSON.stringify(selectedId));
        fetchAccountData();
      }, [selectedId]);

      var fetchAccountData = async function() {
        setLoadingData(true);
        dlog("info", "fetchAccountData START for id=" + JSON.stringify(selectedId));

        try {
          var results = await Promise.allSettled([
            api("/api/accounts/" + selectedId + "/profile"),
            api("/api/accounts/" + selectedId + "/insights?period=day"),
            api("/api/accounts/" + selectedId + "/media?limit=25"),
          ]);

          var profileData = results[0];
          var insightsData = results[1];
          var mediaData = results[2];

          dlog("info", "allSettled results", {
            profile: profileData.status,
            insights: insightsData.status,
            media: mediaData.status,
          });

          // INSIGHTS
          if (insightsData.status === "fulfilled" && insightsData.value) {
            setInsights(insightsData.value);
            dlog("ok", "Insights set", { metrics: insightsData.value.data ? insightsData.value.data.length : 0 });
          } else {
            dlog("warn", "Insights failed", insightsData.reason ? String(insightsData.reason) : "unknown");
            setInsights(null);
          }

          // MEDIA
          if (mediaData.status === "fulfilled" && mediaData.value) {
            var mediaArr = (mediaData.value && mediaData.value.data) || [];
            setMedia(Array.isArray(mediaArr) ? mediaArr : []);
            dlog("ok", "Media set: " + (Array.isArray(mediaArr) ? mediaArr.length : 0) + " items");
          } else {
            dlog("warn", "Media failed", mediaData.reason ? String(mediaData.reason) : "unknown");
            setMedia([]);
          }

          // PROFILE ‚Äî FIX: preserve the original account id!
          if (profileData.status === "fulfilled" && profileData.value) {
            var profileVal = profileData.value;
            dlog("info", "Profile response keys: " + Object.keys(profileVal).join(","),
              { resp_id: profileVal.id, resp_id_type: typeof profileVal.id, resp_user_id: profileVal.user_id });

            setAccounts(function(prev) {
              return prev.map(function(a) {
                if (a.id === selectedId) {
                  // ‚òÖ‚òÖ‚òÖ CRITICAL FIX: Always preserve a.id ‚Äî the Instagram API
                  // response may include an `id` field (sometimes numeric) that
                  // would overwrite our stored string id, breaking the find() lookup.
                  var merged = Object.assign({}, a, profileVal, { id: a.id });
                  dlog("ok", "Profile merged for " + a.username + " ‚Äî id preserved as " + JSON.stringify(merged.id));
                  return merged;
                }
                return a;
              });
            });
          } else {
            dlog("warn", "Profile failed", profileData.reason ? String(profileData.reason) : "unknown");
          }

          // DEMOGRAPHICS
          try {
            var demo = await api("/api/accounts/" + selectedId + "/demographics");
            setDemographics(demo);
          } catch(e) {
            dlog("warn", "Demographics failed: " + e.message);
            setDemographics(null);
          }
        } catch (e) {
          dlog("error", "fetchAccountData EXCEPTION: " + e.message);
          showToast("Error: " + e.message, "error");
        }

        dlog("info", "fetchAccountData DONE");
        setLoadingData(false);
      };

      var removeAccount = async function(id) {
        try {
          await api("/api/accounts/" + id, { method: "DELETE" });
          var updated = accounts.filter(function(a) { return a.id !== id; });
          setAccounts(updated);
          if (selectedId === id) setSelectedId(updated[0] ? updated[0].id : null);
          showToast("Cuenta eliminada");
        } catch (e) {
          showToast("Error: " + e.message, "error");
        }
      };

      var refreshToken = async function(id) {
        try {
          await api("/api/accounts/" + id + "/refresh-token", { method: "POST" });
          showToast("Token renovado ‚úì");
          loadAccountsList();
        } catch (e) {
          showToast("Error renovando token: " + e.message, "error");
        }
      };

      var acc = accounts.find(function(a) { return a.id === selectedId; }) || null;

      // Parse insights ‚Äî fully defensive
      var chartData = (function() {
        if (!insights || !insights.data || !Array.isArray(insights.data)) return [];
        var reachMetric = insights.data.find(function(m) { return m && m.name === "reach"; });
        var viewsMetric = insights.data.find(function(m) { return m && m.name === "views"; });
        if (!reachMetric || !reachMetric.values || !Array.isArray(reachMetric.values)) return [];
        return reachMetric.values.map(function(v, i) {
          return {
            date: v && v.end_time ? new Date(v.end_time).toLocaleDateString("es-ES", { day: "2-digit", month: "short" }) : "",
            reach: (v && v.value) || 0,
            views: viewsMetric && viewsMetric.values && viewsMetric.values[i] ? (viewsMetric.values[i].value || 0) : 0,
          };
        });
      })();

      // Media stats
      var mediaStats = (function() {
        if (!Array.isArray(media) || !media.length) return { totalLikes: 0, totalComments: 0, byType: {} };
        var totalLikes = 0, totalComments = 0, byType = {};
        media.forEach(function(m) {
          if (!m) return;
          totalLikes += m.like_count || 0;
          totalComments += m.comments_count || 0;
          var type = m.media_type || "UNKNOWN";
          byType[type] = (byType[type] || 0) + 1;
        });
        return { totalLikes: totalLikes, totalComments: totalComments, byType: byType };
      })();

      var contentDistribution = Object.entries(mediaStats.byType).map(function(entry) {
        var labels = { IMAGE: "Fotos", VIDEO: "Reels/Video", CAROUSEL_ALBUM: "Carruseles" };
        return { name: labels[entry[0]] || entry[0], value: entry[1] };
      });

      var daysUntilExpiry = acc && acc.token_expires_at
        ? Math.floor((acc.token_expires_at - Date.now()) / (1000 * 60 * 60 * 24))
        : null;

      var engRate = (function() {
        if (!acc || !acc.followers_count || !media.length) return "‚Äî";
        var avg = (mediaStats.totalLikes + mediaStats.totalComments) / Math.max(media.length, 1);
        return (avg / acc.followers_count * 100).toFixed(2) + "%";
      })();

      if (loading) {
        return (
          <div style={{ display: "flex", alignItems: "center", justifyContent: "center", minHeight: "100vh", flexDirection: "column", gap: 16 }}>
            <div className="loading-spinner"></div>
            <p style={{ color: "rgba(255,255,255,0.3)", fontSize: 13 }}>Ctrl+D = debug panel</p>
            <DebugPanel visible={showDebug} onClose={function() { setShowDebug(false); }}
              accounts={accounts} selectedId={selectedId} insights={insights} media={media} demographics={demographics} />
          </div>
        );
      }

      return (
        <div>
          {/* Header */}
          <div className="header">
            <div className="header-brand">
              <div className="header-logo">IG</div>
              <div>
                <div className="header-title">InstaMetrics</div>
                <div className="header-sub">Analytics Dashboard</div>
              </div>
            </div>

            <div style={{ display: "flex", alignItems: "center", gap: 12 }}>
              {accounts.length > 0 && acc && (
                <div className="account-selector">
                  <button className="btn-secondary" onClick={function() { setDropdownOpen(!dropdownOpen); }}>
                    {acc.profile_picture_url && (
                      <img src={acc.profile_picture_url} style={{ width: 22, height: 22, borderRadius: "50%" }} />
                    )}
                    {"@" + (acc.username || "Seleccionar")}
                    <span style={{ opacity: 0.4, fontSize: 12 }}>‚ñº</span>
                  </button>
                  {dropdownOpen && (
                    <div className="dropdown">
                      {accounts.map(function(a, i) {
                        return (
                          <div key={a.id} className="dropdown-item"
                            onClick={function() { setSelectedId(a.id); setDropdownOpen(false); }}>
                            <div style={{ display: "flex", alignItems: "center", gap: 10 }}>
                              {a.profile_picture_url
                                ? <img src={a.profile_picture_url} style={{ width: 24, height: 24, borderRadius: "50%" }} />
                                : <span style={{ width: 8, height: 8, borderRadius: "50%", background: COLORS[i % COLORS.length], display: "inline-block" }}></span>}
                              <span style={{ fontSize: 14, fontWeight: 500 }}>{"@" + a.username}</span>
                            </div>
                            <button onClick={function(e) { e.stopPropagation(); removeAccount(a.id); }}
                              style={{
                                background: "none", border: "none", cursor: "pointer",
                                color: "rgba(255,255,255,0.3)", fontSize: 16, padding: "2px 6px",
                              }}>‚úï</button>
                          </div>
                        );
                      })}
                    </div>
                  )}
                </div>
              )}
              <button className="btn-connect" onClick={function() { window.location.href = "/auth/login"; }}>
                + Conectar cuenta
              </button>
            </div>
          </div>

          {/* Main */}
          <div className="main">
            {!acc ? (
              <div className="empty-state">
                <div className="empty-icon">üìä</div>
                <h2 style={{ fontSize: 28, fontWeight: 700, letterSpacing: "-0.02em" }}>
                  Bienvenido a InstaMetrics
                </h2>
                <p style={{ color: "rgba(255,255,255,0.45)", fontSize: 16, maxWidth: 440, lineHeight: 1.6 }}>
                  Conecta tu primera cuenta de Instagram para ver tus m√©tricas reales.
                  Necesitas una cuenta Business o Creator.
                </p>
                <button className="btn-connect" style={{ marginTop: 8, padding: "14px 28px", fontSize: 16 }}
                  onClick={function() { window.location.href = "/auth/login"; }}>
                  + Conectar cuenta
                </button>
                <div style={{ marginTop: 32, padding: 24, background: "rgba(255,255,255,0.03)", borderRadius: 16, maxWidth: 500, textAlign: "left" }}>
                  <h4 style={{ marginBottom: 12, color: "rgba(255,255,255,0.7)" }}>‚ö° Antes de conectar:</h4>
                  <ol style={{ paddingLeft: 20, color: "rgba(255,255,255,0.5)", lineHeight: 2, fontSize: 14 }}>
                    <li>Tu cuenta debe ser <strong style={{ color: "#fff" }}>Business</strong> o <strong style={{ color: "#fff" }}>Creator</strong></li>
                    <li>Configura la app en <a href="https://developers.facebook.com" target="_blank" style={{ color: "#DD2A7B" }}>Meta for Developers</a></li>
                    <li>Pulsa "Conectar cuenta" y autoriza el acceso</li>
                  </ol>
                </div>
                {/* Debug hint when on welcome screen with accounts */}
                {accounts.length > 0 && (
                  <div style={{ marginTop: 24, padding: 16, background: "rgba(255,100,100,0.08)", border: "1px solid rgba(255,100,100,0.2)", borderRadius: 12, maxWidth: 500 }}>
                    <p style={{ color: "#FF6B6B", fontSize: 13, fontWeight: 600 }}>
                      ‚ö†Ô∏è Hay {accounts.length} cuenta(s) conectada(s) pero no se puede seleccionar.
                      <br />
                      <span style={{ color: "rgba(255,255,255,0.5)", fontWeight: 400 }}>
                        selectedId = {JSON.stringify(selectedId)} | account IDs = [{accounts.map(function(a) { return JSON.stringify(a.id); }).join(", ")}]
                      </span>
                      <br />
                      <span style={{ color: "rgba(255,255,255,0.4)", fontWeight: 400 }}>
                        Pulsa Ctrl+D para abrir el debug panel, o ve a <a href="/?debug" style={{ color: "#DD2A7B" }}>/?debug</a>
                      </span>
                    </p>
                  </div>
                )}
              </div>
            ) : (
              <div>
                {/* Token warning */}
                {daysUntilExpiry !== null && daysUntilExpiry < 10 && (
                  <div className="token-warning">
                    {"‚ö†Ô∏è El token de @" + acc.username + " expira en " + daysUntilExpiry + " d√≠as."}
                    <button onClick={function() { refreshToken(acc.id); }}
                      style={{
                        background: "rgba(255,152,0,0.2)", border: "1px solid rgba(255,152,0,0.4)",
                        borderRadius: 8, padding: "4px 14px", color: "#FFB74D",
                        fontSize: 13, fontWeight: 600, cursor: "pointer", fontFamily: "inherit",
                      }}>Renovar</button>
                  </div>
                )}

                {/* Account header */}
                <div style={{ marginBottom: 24, display: "flex", alignItems: "center", justifyContent: "space-between", flexWrap: "wrap", gap: 16 }}>
                  <div style={{ display: "flex", alignItems: "center", gap: 16 }}>
                    {acc.profile_picture_url && (
                      <img src={acc.profile_picture_url}
                        style={{ width: 52, height: 52, borderRadius: 16, border: "2px solid rgba(255,255,255,0.1)" }} />
                    )}
                    <div>
                      <h1 style={{ fontSize: 26, fontWeight: 800, letterSpacing: "-0.02em" }}>{"@" + acc.username}</h1>
                      <p style={{ color: "rgba(255,255,255,0.4)", fontSize: 14, fontWeight: 500 }}>
                        {(acc.account_type || "") + (acc.name && acc.name !== acc.username ? " ¬∑ " + acc.name : "")}
                      </p>
                    </div>
                  </div>
                  <div style={{ display: "flex", alignItems: "center", gap: 10 }}>
                    <button className="btn-secondary" onClick={fetchAccountData}
                      style={{ fontSize: 13, padding: "8px 14px" }}>
                      üîÑ Actualizar
                    </button>
                    <div className="tabs">
                      {["overview", "media", "audiencia"].map(function(t) {
                        return (
                          <button key={t} className={"tab" + (tab === t ? " active" : "")} onClick={function() { setTab(t); }}>
                            {t}
                          </button>
                        );
                      })}
                    </div>
                  </div>
                </div>

                {loadingData && (
                  <div style={{ display: "flex", justifyContent: "center", padding: 40 }}>
                    <div className="loading-spinner"></div>
                  </div>
                )}

                {!loadingData && (
                  <div>
                    {/* Metrics */}
                    <div className="metrics-grid">
                      <MetricCard icon="üë•" label="Seguidores" value={acc.followers_count || 0} color="#DD2A7B" />
                      <MetricCard icon="‚û°Ô∏è" label="Siguiendo" value={acc.follows_count || 0} color="#8134AF" />
                      <MetricCard icon="üì∏" label="Publicaciones" value={acc.media_count || 0} color="#F58529" />
                      <MetricCard icon="‚ù§Ô∏è" label="Likes (√∫lt. posts)" value={mediaStats.totalLikes} color="#FC466B" />
                      <MetricCard icon="üí¨" label="Comentarios" value={mediaStats.totalComments} color="#515BD4" />
                      <MetricCard icon="üìä" label="Eng. Rate" value={engRate} color="#38EF7D" />
                    </div>

                    {/* OVERVIEW */}
                    {tab === "overview" && (
                      <div className="charts-grid">
                        {RechartAvailable && chartData.length > 0 && (
                          <div className="chart-card full-width">
                            <h3 style={{ marginBottom: 20, fontSize: 16, fontWeight: 700 }}>Alcance y Visualizaciones (diario)</h3>
                            <ResponsiveContainer width="100%" height={280}>
                              <AreaChart data={chartData}>
                                <defs>
                                  <linearGradient id="reachG" x1="0" y1="0" x2="0" y2="1">
                                    <stop offset="0%" stopColor="#DD2A7B" stopOpacity={0.3} />
                                    <stop offset="100%" stopColor="#DD2A7B" stopOpacity={0} />
                                  </linearGradient>
                                  <linearGradient id="viewsG" x1="0" y1="0" x2="0" y2="1">
                                    <stop offset="0%" stopColor="#515BD4" stopOpacity={0.3} />
                                    <stop offset="100%" stopColor="#515BD4" stopOpacity={0} />
                                  </linearGradient>
                                </defs>
                                <CartesianGrid strokeDasharray="3 3" stroke="rgba(255,255,255,0.05)" />
                                <XAxis dataKey="date" stroke="rgba(255,255,255,0.2)" fontSize={11} tickLine={false} />
                                <YAxis stroke="rgba(255,255,255,0.2)" fontSize={11} tickLine={false}
                                  tickFormatter={function(v) { return v >= 1000 ? (v/1000).toFixed(1) + "k" : v; }} />
                                <Tooltip content={ChartTooltip} />
                                <Area type="monotone" dataKey="reach" stroke="#DD2A7B" strokeWidth={2.5}
                                  fill="url(#reachG)" name="Alcance" />
                                <Area type="monotone" dataKey="views" stroke="#515BD4" strokeWidth={2}
                                  fill="url(#viewsG)" name="Visualizaciones" />
                              </AreaChart>
                            </ResponsiveContainer>
                          </div>
                        )}

                        {RechartAvailable && contentDistribution.length > 0 && (
                          <div className="chart-card">
                            <h3 style={{ marginBottom: 20, fontSize: 16, fontWeight: 700 }}>Tipo de contenido</h3>
                            <ResponsiveContainer width="100%" height={240}>
                              <PieChart>
                                <Pie data={contentDistribution} cx="50%" cy="50%"
                                  innerRadius={55} outerRadius={90} paddingAngle={4} dataKey="value">
                                  {contentDistribution.map(function(_, i) {
                                    return <Cell key={i} fill={PIE_COLORS[i % PIE_COLORS.length]} />;
                                  })}
                                </Pie>
                                <Tooltip content={ChartTooltip} />
                              </PieChart>
                            </ResponsiveContainer>
                            <div style={{ display: "flex", justifyContent: "center", gap: 16, marginTop: 8, flexWrap: "wrap" }}>
                              {contentDistribution.map(function(ct, i) {
                                return (
                                  <div key={ct.name} style={{ display: "flex", alignItems: "center", gap: 6, fontSize: 12 }}>
                                    <span style={{ width: 10, height: 10, borderRadius: 3, background: PIE_COLORS[i % PIE_COLORS.length], display: "inline-block" }}></span>
                                    <span style={{ color: "rgba(255,255,255,0.6)" }}>{ct.name + " (" + ct.value + ")"}</span>
                                  </div>
                                );
                              })}
                            </div>
                          </div>
                        )}

                        {/* Top posts */}
                        <div className={"chart-card" + (contentDistribution.length === 0 ? " full-width" : "")}>
                          <h3 style={{ marginBottom: 16, fontSize: 16, fontWeight: 700 }}>Top publicaciones</h3>
                          <div style={{ display: "flex", flexDirection: "column", gap: 10 }}>
                            {Array.isArray(media) && media.length > 0 && media.slice().sort(function(a, b) { return (b.like_count || 0) - (a.like_count || 0); }).slice(0, 6).map(function(m, i) {
                              if (!m) return null;
                              return (
                                <a key={m.id || i} href={m.permalink || "#"} target="_blank" rel="noopener"
                                  style={{
                                    display: "flex", alignItems: "center", gap: 12,
                                    padding: "10px 12px", background: "rgba(255,255,255,0.03)",
                                    borderRadius: 12, transition: "background 0.2s",
                                  }}>
                                  {(m.media_url || m.thumbnail_url) && (
                                    <img src={m.thumbnail_url || m.media_url}
                                      style={{ width: 44, height: 44, borderRadius: 8, objectFit: "cover" }}
                                      onError={function(e) { e.target.style.display = "none"; }} />
                                  )}
                                  <div style={{ flex: 1, minWidth: 0 }}>
                                    <div style={{ fontSize: 13, fontWeight: 600 }}>
                                      {(m.media_type === "VIDEO" ? "üé¨ " : m.media_type === "CAROUSEL_ALBUM" ? "üìë " : "üì∑ ") +
                                        (m.caption ? m.caption.slice(0, 35) + (m.caption.length > 35 ? "..." : "") : "Sin caption")}
                                    </div>
                                    <div style={{ fontSize: 11, color: "rgba(255,255,255,0.4)", marginTop: 2 }}>
                                      {m.timestamp ? new Date(m.timestamp).toLocaleDateString("es-ES") : ""}
                                    </div>
                                  </div>
                                  <div style={{ textAlign: "right", flexShrink: 0 }}>
                                    <div style={{ fontSize: 14, fontWeight: 700, color: "#DD2A7B" }}>{"‚ù§ " + (m.like_count || 0).toLocaleString("es-ES")}</div>
                                    <div style={{ fontSize: 11, color: "rgba(255,255,255,0.4)" }}>{"üí¨ " + (m.comments_count || 0)}</div>
                                  </div>
                                </a>
                              );
                            })}
                            {(!Array.isArray(media) || media.length === 0) && (
                              <p style={{ color: "rgba(255,255,255,0.4)", fontSize: 14, textAlign: "center", padding: 20 }}>
                                No hay publicaciones todav√≠a
                              </p>
                            )}
                          </div>
                        </div>

                        {/* Multi-account */}
                        {accounts.length > 1 && (
                          <div className="chart-card full-width">
                            <h3 style={{ marginBottom: 16, fontSize: 16, fontWeight: 700 }}>Comparaci√≥n entre cuentas</h3>
                            <div style={{ overflowX: "auto" }}>
                              <table style={{ width: "100%", borderCollapse: "collapse" }}>
                                <thead>
                                  <tr>
                                    {["Cuenta", "Seguidores", "Siguiendo", "Posts", "Tipo"].map(function(h) {
                                      return <th key={h} style={{ textAlign: "left", padding: "10px 16px", fontSize: 12, fontWeight: 600, color: "rgba(255,255,255,0.4)", borderBottom: "1px solid rgba(255,255,255,0.06)" }}>{h}</th>;
                                    })}
                                  </tr>
                                </thead>
                                <tbody>
                                  {accounts.map(function(a, i) {
                                    return (
                                      <tr key={a.id} style={{ background: acc && a.id === acc.id ? "rgba(255,255,255,0.04)" : "transparent", cursor: "pointer" }}
                                        onClick={function() { setSelectedId(a.id); }}>
                                        <td style={{ padding: "12px 16px", fontSize: 14, fontWeight: 600 }}>
                                          <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                                            {a.profile_picture_url
                                              ? <img src={a.profile_picture_url} style={{ width: 24, height: 24, borderRadius: "50%" }} />
                                              : <span style={{ width: 8, height: 8, borderRadius: "50%", background: COLORS[i % COLORS.length], display: "inline-block" }}></span>}
                                            {"@" + a.username}
                                          </div>
                                        </td>
                                        <td style={{ padding: "12px 16px", fontSize: 14 }}>{(a.followers_count || 0).toLocaleString("es-ES")}</td>
                                        <td style={{ padding: "12px 16px", fontSize: 14 }}>{(a.follows_count || 0).toLocaleString("es-ES")}</td>
                                        <td style={{ padding: "12px 16px", fontSize: 14 }}>{a.media_count || 0}</td>
                                        <td style={{ padding: "12px 16px", fontSize: 13, color: "rgba(255,255,255,0.5)" }}>{a.account_type || ""}</td>
                                      </tr>
                                    );
                                  })}
                                </tbody>
                              </table>
                            </div>
                          </div>
                        )}

                        {chartData.length === 0 && (
                          <div className="chart-card full-width" style={{ textAlign: "center", padding: 40 }}>
                            <p style={{ color: "rgba(255,255,255,0.4)", fontSize: 15 }}>
                              üìà Los insights aparecer√°n aqu√≠ cuando Instagram tenga datos suficientes.
                            </p>
                          </div>
                        )}
                      </div>
                    )}

                    {/* MEDIA TAB */}
                    {tab === "media" && (
                      <div className="media-grid">
                        {Array.isArray(media) && media.map(function(m) {
                          if (!m) return null;
                          return (
                            <a key={m.id} href={m.permalink || "#"} target="_blank" rel="noopener" className="media-item">
                              {(m.thumbnail_url || m.media_url) && (
                                <img src={m.thumbnail_url || m.media_url} alt=""
                                  style={{ width: "100%", aspectRatio: "1", objectFit: "cover" }}
                                  onError={function(e) { e.target.style.display = "none"; }} />
                              )}
                              <div className="media-info">
                                <div style={{ display: "flex", justifyContent: "space-between", marginBottom: 6 }}>
                                  <span style={{ fontSize: 13, fontWeight: 600 }}>
                                    {m.media_type === "VIDEO" ? "üé¨ Reel" : m.media_type === "CAROUSEL_ALBUM" ? "üìë Carrusel" : "üì∑ Foto"}
                                  </span>
                                  <span style={{ fontSize: 12, color: "rgba(255,255,255,0.4)" }}>
                                    {m.timestamp ? new Date(m.timestamp).toLocaleDateString("es-ES") : ""}
                                  </span>
                                </div>
                                <div style={{ display: "flex", gap: 14, fontSize: 13 }}>
                                  <span style={{ color: "#DD2A7B", fontWeight: 600 }}>{"‚ù§ " + (m.like_count || 0).toLocaleString("es-ES")}</span>
                                  <span style={{ color: "#8134AF", fontWeight: 600 }}>{"üí¨ " + (m.comments_count || 0)}</span>
                                </div>
                                {m.caption && (
                                  <p style={{ fontSize: 12, color: "rgba(255,255,255,0.4)", marginTop: 6, lineHeight: 1.4 }}>
                                    {m.caption.slice(0, 80) + (m.caption.length > 80 ? "..." : "")}
                                  </p>
                                )}
                              </div>
                            </a>
                          );
                        })}
                        {(!Array.isArray(media) || media.length === 0) && (
                          <div style={{ gridColumn: "1 / -1", textAlign: "center", padding: 60, color: "rgba(255,255,255,0.4)" }}>
                            No se encontraron publicaciones
                          </div>
                        )}
                      </div>
                    )}

                    {/* AUDIENCE TAB */}
                    {tab === "audiencia" && (
                      <div className="charts-grid">
                        {demographics && demographics.data && Array.isArray(demographics.data) ? (
                          demographics.data.map(function(metric, idx) {
                            if (!metric) return null;
                            var br = (metric.total_value && metric.total_value.breakdowns && Array.isArray(metric.total_value.breakdowns) && metric.total_value.breakdowns[0] && Array.isArray(metric.total_value.breakdowns[0].results)) ? metric.total_value.breakdowns[0].results : null;
                            return (
                              <div key={idx} className="chart-card">
                                <h3 style={{ marginBottom: 16, fontSize: 16, fontWeight: 700 }}>{metric.title || metric.name || "M√©trica"}</h3>
                                {br ? (
                                  <div style={{ display: "flex", flexDirection: "column", gap: 8 }}>
                                    {br.slice().sort(function(a, b) { return (b.value || 0) - (a.value || 0); }).slice(0, 10).map(function(item, i) {
                                      var maxVal = br[0] ? (br[0].value || 1) : 1;
                                      return (
                                        <div key={i}>
                                          <div style={{ display: "flex", justifyContent: "space-between", marginBottom: 4 }}>
                                            <span style={{ fontSize: 13, fontWeight: 500 }}>{Object.values(item.dimension_values || {}).join(" ¬∑ ") || "‚Äî"}</span>
                                            <span style={{ fontSize: 13, fontWeight: 600, color: COLORS[i % COLORS.length] }}>{(item.value || 0).toLocaleString("es-ES")}</span>
                                          </div>
                                          <div style={{ height: 6, borderRadius: 3, background: "rgba(255,255,255,0.06)", overflow: "hidden" }}>
                                            <div style={{ height: "100%", borderRadius: 3, width: ((item.value || 0) / maxVal * 100) + "%", background: COLORS[i % COLORS.length] }}></div>
                                          </div>
                                        </div>
                                      );
                                    })}
                                  </div>
                                ) : (
                                  <p style={{ color: "rgba(255,255,255,0.4)", fontSize: 14 }}>Sin datos disponibles</p>
                                )}
                              </div>
                            );
                          })
                        ) : (
                          <div className="chart-card full-width" style={{ textAlign: "center", padding: 50 }}>
                            <p style={{ color: "rgba(255,255,255,0.4)", fontSize: 15, lineHeight: 1.7 }}>
                              üë• Los datos demogr√°ficos requieren al menos <strong style={{ color: "#fff" }}>100 seguidores</strong>.
                              <br /><span style={{ fontSize: 13 }}>Instagram restringe estos datos en cuentas peque√±as por privacidad.</span>
                            </p>
                          </div>
                        )}
                      </div>
                    )}
                  </div>
                )}
              </div>
            )}
          </div>

          {/* Toast */}
          {toast && <div className={"toast " + toast.type}>{toast.msg}</div>}

          {/* Click outside dropdown */}
          {dropdownOpen && (
            <div style={{ position: "fixed", inset: 0, zIndex: 150 }}
              onClick={function() { setDropdownOpen(false); }}></div>
          )}

          {/* Debug Panel */}
          <DebugPanel visible={showDebug} onClose={function() { setShowDebug(false); }}
            accounts={accounts} selectedId={selectedId} insights={insights} media={media} demographics={demographics} />
        </div>
      );
    }

    // Mount with ErrorBoundary
    ReactDOM.createRoot(document.getElementById("root")).render(
      React.createElement(ErrorBoundary, null, React.createElement(App))
    );

    // Hide static error div since React mounted
    var errDiv = document.getElementById("error-display");
    if (errDiv) errDiv.style.display = "none";
    dlog("ok", "React mounted successfully");
  </script>

  <script>
    window.__reactMounted = false;
    window.addEventListener('error', function(e) {
      setTimeout(function() {
        if (window.__reactMounted) return;
        var errorDiv = document.getElementById('error-display');
        var errorMsg = document.getElementById('error-msg');
        if (errorDiv && errorMsg) {
          errorDiv.style.display = 'block';
          errorMsg.textContent = e.message || 'Error desconocido';
        }
      }, 500);
    });
    var checkMount = setInterval(function() {
      if (document.getElementById('root') && document.getElementById('root').childNodes.length > 0) {
        window.__reactMounted = true;
        clearInterval(checkMount);
        var errDiv = document.getElementById('error-display');
        if (errDiv) errDiv.style.display = 'none';
      }
    }, 200);
    setTimeout(function() { clearInterval(checkMount); }, 10000);
  </script>
</body>
</html>
